{{!-- Reporte de Productividad de Matrizadores - VISTA MEJORADA CON M√âTRICAS AVANZADAS --}}

<!-- Breadcrumb -->
<div class="row mb-3">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="/admin/dashboard">
            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
          </a>
        </li>
        <li class="breadcrumb-item">
          <a href="/admin/reportes">
            <i class="fas fa-chart-bar me-1"></i>Reportes
          </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          <i class="fas fa-users me-1"></i>Productividad de Matrizadores
        </li>
      </ol>
    </nav>
  </div>
</div>

<!-- Header con informaci√≥n de filtro aplicado -->
<div class="row">
  <div class="col-md-12 mb-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-chart-bar me-2"></i> {{title}}</span>
        <div>
          <a href="/admin/reportes" class="btn btn-sm btn-outline-secondary me-2">
            <i class="fas fa-arrow-left me-1"></i> Volver a Reportes
          </a>
          <button class="btn btn-sm btn-outline-primary me-2" onclick="window.print()">
            <i class="fas fa-print me-1"></i> Imprimir
          </button>
          <button class="btn btn-sm btn-outline-success" onclick="exportarProductividad()">
            <i class="fas fa-file-excel me-1"></i> Exportar
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <p class="text-muted mb-0">
              <i class="fas fa-calendar me-1"></i>
              <strong>Per√≠odo:</strong> {{periodoTexto}}
              {{#if esFiltradoPorMatrizador}}
                <br>
                <i class="fas fa-user me-1"></i>
                <strong>Matrizador:</strong> {{matrizadorFiltradoNombre}}
              {{/if}}
            </p>
          </div>
          <div class="col-md-4 text-end">
            <small class="text-muted">
              <i class="fas fa-clock me-1"></i>
              Actualizado en tiempo real
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filtros Mejorados -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-filter me-2"></i> Filtros de Productividad
      </div>
      <div class="card-body">
        <form method="GET" action="/admin/reportes/productividad-matrizadores" id="filtrosForm">
          <div class="row">
            <div class="col-md-3">
              <label for="rango" class="form-label">Per√≠odo de An√°lisis</label>
              <select class="form-select" id="rango" name="rango">
                <option value="desde_inicio" {{#if (eq filtros.rango "desde_inicio")}}selected{{/if}}>üìä Desde el Inicio</option>
                <option value="hoy" {{#if (eq filtros.rango "hoy")}}selected{{/if}}>Hoy</option>
                <option value="ayer" {{#if (eq filtros.rango "ayer")}}selected{{/if}}>Ayer</option>
                <option value="semana" {{#if (eq filtros.rango "semana")}}selected{{/if}}>Esta Semana</option>
                <option value="mes" {{#if (eq filtros.rango "mes")}}selected{{/if}}>Este Mes</option>
                <option value="ultimo_mes" {{#if (eq filtros.rango "ultimo_mes")}}selected{{/if}}>√öltimos 30 d√≠as</option>
                <option value="personalizado" {{#if (eq filtros.rango "personalizado")}}selected{{/if}}>Personalizado</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="idMatrizador" class="form-label">Matrizador Espec√≠fico</label>
              <select class="form-select" id="idMatrizador" name="idMatrizador">
                <option value="todos" {{#if (eq filtros.idMatrizador "todos")}}selected{{/if}}>Todos los Matrizadores</option>
                {{#each matrizadores}}
                <option value="{{this.id}}" {{#if (eq ../filtros.idMatrizador this.id)}}selected{{/if}}>{{this.nombre}}</option>
                {{/each}}
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-search me-1"></i> Analizar
              </button>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <a href="/admin/reportes/productividad-matrizadores" class="btn btn-outline-secondary w-100">
                <i class="fas fa-times me-1"></i> Limpiar
              </a>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button type="button" class="btn btn-outline-info w-100" onclick="toggleAyuda()">
                <i class="fas fa-question-circle me-1"></i> Ayuda
              </button>
            </div>
          </div>
          
          <!-- Filtros de fecha personalizado (oculto por defecto) -->
          <div id="fechasPersonalizadas" class="row mt-3" style="display: none;">
            <div class="col-md-3">
              <label for="fechaInicio" class="form-label">Fecha Inicio</label>
              <input type="date" class="form-control" id="fechaInicio" name="fechaInicio" value="{{filtros.fechaInicio}}">
            </div>
            <div class="col-md-3">
              <label for="fechaFin" class="form-label">Fecha Fin</label>
              <input type="date" class="form-control" id="fechaFin" name="fechaFin" value="{{filtros.fechaFin}}">
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Cards de Estad√≠sticas Mejoradas (4 cards principales - SIN NOTIFICACIONES) -->
<div class="row mb-4">
  <!-- Card 1: Total Documentos -->
  <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
    <div class="card bg-primary text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="mb-0">{{stats.totalDocumentos}}</h4>
            <p class="mb-0 small">Total Documentos</p>
          </div>
          <div class="align-self-center">
            <i class="fas fa-file-alt fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Card 2: Documentos por D√≠a Promedio -->
  <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
    <div class="card bg-info text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="mb-0">{{stats.documentosPorDiaPromedio}}</h4>
            <p class="mb-0 small">Docs/D√≠a Promedio</p>
          </div>
          <div class="align-self-center">
            <i class="fas fa-calendar-day fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Card 3: Tiempo Promedio -->
  <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
    <div class="card bg-warning text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="mb-0">{{stats.tiempoPromedioGeneral}}</h4>
            <p class="mb-0 small">D√≠as Promedio</p>
          </div>
          <div class="align-self-center">
            <i class="fas fa-clock fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Card 4: Documentos Atrasados -->
  <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
    <div class="card bg-danger text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="mb-0">{{stats.documentosAtrasados}}</h4>
            <p class="mb-0 small">Docs Atrasados</p>
          </div>
          <div class="align-self-center">
            <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Segunda fila de cards adicionales -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-success text-white h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="mb-0">{{stats.totalFacturacion}}</h4>
            <p class="mb-0">Total Facturado</p>
          </div>
          <div class="align-self-center">
            <i class="fas fa-money-bill-wave fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-gradient text-white h-100" style="background: linear-gradient(45deg, #6a11cb 0%, #2575fc 100%);">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="mb-0">{{stats.eficienciaGeneral}}%</h4>
            <p class="mb-0">Eficiencia General</p>
          </div>
          <div class="align-self-center">
            <i class="fas fa-chart-line fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-gradient text-white h-100" style="background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="mb-0">{{stats.tasaCalidadPromedio}}%</h4>
            <p class="mb-0">Calidad Promedio</p>
          </div>
          <div class="align-self-center">
            <i class="fas fa-star fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-gradient text-white h-100" style="background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="mb-0">{{stats.matrizadoresActivos}}</h4>
            <p class="mb-0">Matrizadores Activos</p>
          </div>
          <div class="align-self-center">
            <i class="fas fa-users fa-2x opacity-75"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Tabla de Productividad Mejorada - SIN COLUMNAS DE NOTIFICACIONES -->
<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-table me-2"></i> An√°lisis Detallado de Productividad por Matrizador</span>
        <div>
          <button class="btn btn-sm btn-outline-primary" onclick="toggleTablaCompleta()">
            <i class="fas fa-expand me-1"></i> Vista Completa
          </button>
        </div>
      </div>
      <div class="card-body">
        {{#if productividadMatrizadores}}
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="tablaProductividad">
            <thead class="table-dark">
              <tr>
                <th class="sticky-column">Matrizador</th>
                <th class="text-center">Registrados</th>
                <th class="text-center">Completados</th>
                <th class="text-center">Entregados</th>
                <th class="text-center">Atrasados</th>
                <th class="text-center">Tiempo Prom.</th>
                <th class="text-center">Docs/D√≠a</th>
                <th class="text-center">Eficiencia</th>
                <th class="text-center">Calidad</th>
                <th class="text-end">Facturaci√≥n</th>
              </tr>
            </thead>
            <tbody>
              {{#each productividadMatrizadores}}
              <tr class="{{#if (eq ../esFiltradoPorMatrizador true)}}table-warning{{/if}}">
                <td class="sticky-column">
                  <div>
                    <strong>{{this.nombre}}</strong>
                    {{#if this.email}}
                    <br><small class="text-muted">{{this.email}}</small>
                    {{/if}}
                  </div>
                </td>
                <td class="text-center">
                  <span class="badge bg-primary fs-6">{{this.documentos_registrados}}</span>
                </td>
                <td class="text-center">
                  <span class="badge bg-success fs-6">{{this.documentos_completados}}</span>
                </td>
                <td class="text-center">
                  <span class="badge bg-info fs-6">{{this.documentos_entregados}}</span>
                </td>
                <td class="text-center">
                  {{#if (gt this.documentos_atrasados 0)}}
                    <span class="badge bg-danger fs-6">{{this.documentos_atrasados}}</span>
                  {{else}}
                    <span class="badge bg-light text-dark fs-6">0</span>
                  {{/if}}
                </td>
                <td class="text-center">
                  <span class="badge {{#if (lt this.tiempo_promedio_dias 2)}}bg-success{{else if (lt this.tiempo_promedio_dias 4)}}bg-warning{{else}}bg-danger{{/if}} fs-6">
                    {{this.tiempo_promedio_dias}} d√≠as
                  </span>
                </td>
                <td class="text-center">
                  <span class="badge bg-secondary fs-6">{{this.documentos_por_dia}}</span>
                </td>
                <td class="text-center">
                  <div class="d-flex align-items-center justify-content-center">
                    <div class="progress" style="width: 60px; height: 20px;">
                      <div class="progress-bar {{#if (gt this.eficiencia_procesamiento 80)}}bg-success{{else if (gt this.eficiencia_procesamiento 60)}}bg-warning{{else}}bg-danger{{/if}}" 
                           role="progressbar" 
                           style="width: {{this.eficiencia_procesamiento}}%">
                        <small>{{this.eficiencia_procesamiento}}%</small>
                      </div>
                    </div>
                  </div>
                </td>
                <td class="text-center">
                  <div class="d-flex align-items-center justify-content-center">
                    <div class="progress" style="width: 60px; height: 20px;">
                      <div class="progress-bar {{#if (gt this.tasa_calidad 90)}}bg-success{{else if (gt this.tasa_calidad 80)}}bg-warning{{else}}bg-danger{{/if}}" 
                           role="progressbar" 
                           style="width: {{this.tasa_calidad}}%">
                        <small>{{this.tasa_calidad}}%</small>
                      </div>
                    </div>
                  </div>
                </td>
                <td class="text-end">
                  <strong class="text-success">{{this.facturacion_total_formato}}</strong>
                </td>
              </tr>
              {{/each}}
            </tbody>
          </table>
        </div>
        {{else}}
        <div class="text-center py-4">
          <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">No hay datos de productividad</h5>
          <p class="text-muted">Ajuste los filtros para ver informaci√≥n de productividad</p>
        </div>
        {{/if}}
      </div>
    </div>
  </div>
</div>

<!-- Panel de Ayuda (oculto por defecto) -->
<div id="panelAyuda" class="row mt-4" style="display: none;">
  <div class="col-md-12">
    <div class="alert alert-info">
      <h6><i class="fas fa-info-circle me-2"></i>Informaci√≥n de M√©tricas de Productividad</h6>
      <div class="row">
        <div class="col-md-6">
          <ul class="mb-0">
            <li><strong>Documentos Registrados:</strong> Total ingresados en el per√≠odo</li>
            <li><strong>Documentos Completados:</strong> Marcados como "listo para entrega"</li>
            <li><strong>Documentos Entregados:</strong> Entregados al cliente final</li>
            <li><strong>Documentos Atrasados:</strong> M√°s de 3 d√≠as en proceso</li>
            <li><strong>Tiempo Promedio:</strong> D√≠as promedio de procesamiento</li>
            <li><strong>Docs/D√≠a:</strong> Promedio diario de documentos procesados</li>
          </ul>
        </div>
        <div class="col-md-6">
          <ul class="mb-0">
            <li><strong>Eficiencia:</strong> % de documentos completados vs registrados</li>
            <li><strong>Calidad:</strong> % estimado sin devoluciones</li>
            <li><strong>Notificaciones:</strong> Total de notificaciones enviadas</li>
            <li><strong>Costo Notif.:</strong> Costo estimado WhatsApp + Email</li>
            <li><strong>Facturaci√≥n:</strong> Total facturado en el per√≠odo</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Informaci√≥n adicional con detalles de an√°lisis -->
<div class="row mt-4">
  <div class="col-md-12">
    <div class="alert alert-light border">
      <div class="row">
        <div class="col-md-8">
          <h6><i class="fas fa-lightbulb me-2"></i>An√°lisis de Productividad Mejorado</h6>
          <p class="mb-0 small">
            Este reporte incluye m√©tricas avanzadas para evaluar la productividad real: velocidad de procesamiento, 
            calidad del trabajo, control de costos de notificaciones y eficiencia temporal. 
            Use los filtros para analizar per√≠odos espec√≠ficos o matrizadores individuales.
          </p>
        </div>
        <div class="col-md-4 text-end">
          <small class="text-muted">
            <i class="fas fa-database me-1"></i>
            Datos en tiempo real | 
            <i class="fas fa-sync me-1"></i>
            <a href="javascript:location.reload()">Actualizar</a>
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Funci√≥n para exportar datos
function exportarProductividad() {
  const filtros = new URLSearchParams(window.location.search);
  const url = '/admin/reportes/productividad-matrizadores?' + filtros.toString() + '&formato=excel';
  window.open(url, '_blank');
}

// Funci√≥n para mostrar/ocultar panel de ayuda
function toggleAyuda() {
  const panel = document.getElementById('panelAyuda');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// Funci√≥n para alternar vista completa de tabla
function toggleTablaCompleta() {
  const tabla = document.getElementById('tablaProductividad');
  tabla.classList.toggle('table-full-width');
}

// Mostrar/ocultar fechas personalizadas
document.getElementById('rango').addEventListener('change', function() {
  const fechasDiv = document.getElementById('fechasPersonalizadas');
  if (this.value === 'personalizado') {
    fechasDiv.style.display = 'block';
  } else {
    fechasDiv.style.display = 'none';
  }
});

// Inicializar fechas personalizadas si est√° seleccionado
document.addEventListener('DOMContentLoaded', function() {
  const rangoSelect = document.getElementById('rango');
  if (rangoSelect.value === 'personalizado') {
    document.getElementById('fechasPersonalizadas').style.display = 'block';
  }
});
</script>

<style>
.sticky-column {
  position: sticky;
  left: 0;
  background-color: white;
  z-index: 10;
  border-right: 2px solid #dee2e6;
}

.table-dark .sticky-column {
  background-color: #212529;
}

.table-full-width {
  font-size: 0.85rem;
}

.progress {
  background-color: #e9ecef;
}

.opacity-75 {
  opacity: 0.75;
}

.fs-6 {
  font-size: 0.875rem;
}

.card.h-100 {
  transition: transform 0.2s;
}

.card.h-100:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.bg-gradient {
  background-image: linear-gradient(180deg, rgba(255,255,255,.15), rgba(255,255,255,0));
}
</style> 