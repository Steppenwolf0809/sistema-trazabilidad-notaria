<!-- Navegación -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/admin">Dashboard</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{title}}</li>
  </ol>
</nav>

<!-- Página Principal de Reportes -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Reportes y Estadísticas</h5>
      </div>
      <div class="card-body">
        <p class="lead">
          Seleccione el tipo de reporte que desea generar para obtener información detallada sobre los documentos y operaciones del sistema.
        </p>
        
        <!-- Filtros comunes para todos los reportes -->
        <form method="GET" action="/admin/reportes" id="filtrosForm" class="row g-3 mb-4">
          <input type="hidden" name="tipo" id="tipoReporte" value="{{filtros.tipo}}">
          
          <div class="col-md-3">
            <label for="rango" class="form-label">Período</label>
            <select id="rango" name="rango" class="form-select">
              <option value="hoy" {{#if (eq filtros.rango "hoy")}}selected{{/if}}>Hoy</option>
              <option value="ayer" {{#if (eq filtros.rango "ayer")}}selected{{/if}}>Ayer</option>
              <option value="semana" {{#if (eq filtros.rango "semana")}}selected{{/if}}>Esta semana</option>
              <option value="mes" {{#if (eq filtros.rango "mes")}}selected{{/if}}>Este mes</option>
              <option value="ultimo_mes" {{#if (eq filtros.rango "ultimo_mes")}}selected{{/if}}>Últimos 30 días</option>
              <option value="personalizado" {{#if (eq filtros.rango "personalizado")}}selected{{/if}}>Personalizado</option>
            </select>
          </div>
          
          <div id="fechasPersonalizadas" class="row g-3" style="{{#unless (eq filtros.rango "personalizado")}}display: none;{{/unless}}">
            <div class="col-md-3">
              <label for="fechaInicio" class="form-label">Desde</label>
              <input type="date" id="fechaInicio" name="fechaInicio" class="form-control" value="{{filtros.fechaInicio}}">
            </div>
            <div class="col-md-3">
              <label for="fechaFin" class="form-label">Hasta</label>
              <input type="date" id="fechaFin" name="fechaFin" class="form-control" value="{{filtros.fechaFin}}">
            </div>
          </div>
          
          <div class="col-md-3">
            <label for="idMatrizador" class="form-label">Matrizador</label>
            <select id="idMatrizador" name="idMatrizador" class="form-select">
              <option value="">Todos</option>
              {{#each matrizadores}}
              <option value="{{this.id}}" {{#if (eq ../filtros.idMatrizador this.id)}}selected{{/if}}>{{this.nombre}}</option>
              {{/each}}
            </select>
          </div>
          
          <div class="col-md-3">
            <label for="estado" class="form-label">Estado</label>
            <select id="estado" name="estado" class="form-select">
              <option value="">Todos</option>
              <option value="en_proceso" {{#if (eq filtros.estado "en_proceso")}}selected{{/if}}>En Proceso</option>
              <option value="listo_para_entrega" {{#if (eq filtros.estado "listo_para_entrega")}}selected{{/if}}>Listo para Entrega</option>
              <option value="entregado" {{#if (eq filtros.estado "entregado")}}selected{{/if}}>Entregado</option>
            </select>
          </div>
          
          <div class="col-12 text-center">
            <button type="submit" class="btn btn-primary" {{#unless vistaPartial}}style="display: none;"{{/unless}} id="btnAplicarFiltro">
              <i class="fas fa-filter me-1"></i> Aplicar Filtros
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Si hay un tipo de reporte seleccionado, mostrar el partial correspondiente -->
{{#if vistaPartial}}
  <div class="row mb-4">
    <div class="col-12">
      <div class="mb-3">
        <a href="/admin/reportes" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-1"></i> Volver a Lista de Reportes
        </a>
      </div>
      {{> (lookup . 'vistaPartial')}}
    </div>
  </div>
{{else}}
  <!-- Mostrar tarjetas de reportes disponibles si no hay tipo seleccionado -->
  <div class="row row-cols-1 row-cols-md-3 g-4">
    <!-- Reporte por Estado -->
    <div class="col">
      <div class="card h-100 bg-light border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-chart-pie fa-4x text-primary"></i>
          </div>
          <h5 class="card-title">Reporte por Estado</h5>
          <p class="card-text">
            Analice la distribución de documentos según su estado actual en el sistema.
          </p>
          <a href="/admin/reportes/estado" class="btn btn-primary">
            <i class="fas fa-eye me-1"></i> Ver Reporte
          </a>
        </div>
      </div>
    </div>
    
    <!-- Reporte por Matrizador -->
    <div class="col">
      <div class="card h-100 bg-light border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-users fa-4x text-primary"></i>
          </div>
          <h5 class="card-title">Reporte por Matrizador</h5>
          <p class="card-text">
            Evalúe el rendimiento y la distribución de trabajo entre los matrizadores.
          </p>
          <a href="/admin/reportes/matrizador" class="btn btn-primary">
            <i class="fas fa-eye me-1"></i> Ver Reporte
          </a>
        </div>
      </div>
    </div>
    
    <!-- Reporte por Fecha -->
    <div class="col">
      <div class="card h-100 bg-light border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-calendar fa-4x text-primary"></i>
          </div>
          <h5 class="card-title">Reporte por Fecha</h5>
          <p class="card-text">
            Visualice la evolución temporal de documentos procesados por día.
          </p>
          <a href="/admin/reportes/fecha" class="btn btn-primary">
            <i class="fas fa-eye me-1"></i> Ver Reporte
          </a>
        </div>
      </div>
    </div>
    
    <!-- Reporte por Tipo de Documento -->
    <div class="col">
      <div class="card h-100 bg-light border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-file-alt fa-4x text-primary"></i>
          </div>
          <h5 class="card-title">Reporte por Tipo</h5>
          <p class="card-text">
            Analice la distribución de documentos según su categoría o tipo.
          </p>
          <a href="/admin/reportes/tipoDocumento" class="btn btn-primary">
            <i class="fas fa-eye me-1"></i> Ver Reporte
          </a>
        </div>
      </div>
    </div>
    
    <!-- Reporte Documentos Sin Procesar -->
    <div class="col">
      <div class="card h-100 bg-light border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-tasks fa-4x text-warning"></i>
          </div>
          <h5 class="card-title">Documentos Sin Procesar</h5>
          <p class="card-text">
            Supervise los documentos pendientes que requieren procesamiento urgente.
          </p>
          <a href="/admin/reportes/sin_procesar" class="btn btn-warning text-dark">
            <i class="fas fa-eye me-1"></i> Ver Reporte
          </a>
        </div>
      </div>
    </div>
    
    <!-- Reporte Documentos Sin Pago -->
    <div class="col">
      <div class="card h-100 bg-light border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-dollar-sign fa-4x text-danger"></i>
          </div>
          <h5 class="card-title">Documentos Sin Pago</h5>
          <p class="card-text">
            Gestione la cobranza de documentos pendientes de pago y facturación.
          </p>
          <a href="/admin/reportes/sin_pago" class="btn btn-danger">
            <i class="fas fa-eye me-1"></i> Ver Reporte
          </a>
        </div>
      </div>
    </div>
    
    <!-- Reporte Financiero -->
    <div class="col">
      <div class="card h-100 bg-light border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-chart-line fa-4x text-success"></i>
          </div>
          <h5 class="card-title">Reporte Financiero</h5>
          <p class="card-text">
            Analice métricas financieras, facturación y cobranza en diferentes períodos.
          </p>
          <a href="/admin/reportes/financiero" class="btn btn-success">
            <i class="fas fa-eye me-1"></i> Ver Reporte
          </a>
        </div>
      </div>
    </div>
    
    <!-- Reporte de Documentos -->
    <div class="col">
      <div class="card h-100 bg-light border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-file-invoice fa-4x text-primary"></i>
          </div>
          <h5 class="card-title">Reporte de Documentos</h5>
          <p class="card-text">
            Estadísticas completas de documentos procesados, tipos y tendencias.
          </p>
          <a href="/admin/reportes/documentos" class="btn btn-primary">
            <i class="fas fa-eye me-1"></i> Ver Reporte
          </a>
        </div>
      </div>
    </div>
    
    <!-- Reporte de Pendientes -->
    <div class="col">
      <div class="card h-100 bg-light border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-clock fa-4x text-warning"></i>
          </div>
          <h5 class="card-title">Pagos Atrasados</h5>
          <p class="card-text">
            Documentos pendientes de pago organizados por antigüedad y matrizador.
          </p>
          <a href="/admin/reportes/pendientes" class="btn btn-warning text-dark">
            <i class="fas fa-eye me-1"></i> Ver Reporte
          </a>
        </div>
      </div>
    </div>
    
    <!-- Reporte de Matrizadores -->
    <div class="col">
      <div class="card h-100 bg-light border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-user-tie fa-4x text-info"></i>
          </div>
          <h5 class="card-title">Productividad Matrizadores</h5>
          <p class="card-text">
            Análisis de productividad y rendimiento por matrizador en el período.
          </p>
          <a href="/admin/reportes/matrizadores" class="btn btn-info text-white">
            <i class="fas fa-eye me-1"></i> Ver Reporte
          </a>
        </div>
      </div>
    </div>
    
    <!-- Reporte de Cobros por Matrizador -->
    <div class="col">
      <div class="card h-100 bg-light border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-hand-holding-usd fa-4x text-success"></i>
          </div>
          <h5 class="card-title">Cobros por Matrizador</h5>
          <p class="card-text">
            Análisis detallado de cobros realizados por cada matrizador en el período.
          </p>
          <a href="/admin/reportes/cobros-matrizador" class="btn btn-success">
            <i class="fas fa-eye me-1"></i> Ver Reporte
          </a>
        </div>
      </div>
    </div>
    
    <!-- Registros de Auditoría -->
    <div class="col">
      <div class="card h-100 bg-light border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-clipboard-list fa-4x text-info"></i>
          </div>
          <h5 class="card-title">Registros de Auditoría</h5>
          <p class="card-text">
            Consulte el historial de acciones realizadas en el sistema para fines de seguridad.
          </p>
          <a href="/admin/auditoria" class="btn btn-info text-white">
            <i class="fas fa-eye me-1"></i> Ver Registros
          </a>
        </div>
      </div>
    </div>
    
    <!-- Auditoría de Eliminaciones -->
    <div class="col">
      <div class="card h-100 bg-light border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="mb-3">
            <i class="fas fa-trash-alt fa-4x text-secondary"></i>
          </div>
          <h5 class="card-title">Auditoría de Eliminaciones</h5>
          <p class="card-text">
            Revise el historial de documentos eliminados y los motivos registrados.
          </p>
          <a href="/admin/auditoria-eliminaciones" class="btn btn-secondary">
            <i class="fas fa-eye me-1"></i> Ver Historial
          </a>
        </div>
      </div>
    </div>
  </div>
{{/if}}

<!-- Script para manejar filtros -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Mostrar/ocultar fechas personalizadas
  const rangoSelect = document.getElementById('rango');
  const fechasPersonalizadas = document.getElementById('fechasPersonalizadas');
  const formFiltros = document.getElementById('filtrosForm');
  const btnAplicarFiltro = document.getElementById('btnAplicarFiltro');
  const tipoReporteInput = document.getElementById('tipoReporte');

  if (rangoSelect) {
    rangoSelect.addEventListener('change', function() {
      if (this.value === 'personalizado') {
        fechasPersonalizadas.style.display = 'flex';
      } else {
        fechasPersonalizadas.style.display = 'none';
      }
    });
  }

  // Controlar visibilidad del botón Aplicar Filtros
  if (tipoReporteInput && tipoReporteInput.value) {
    if(btnAplicarFiltro) btnAplicarFiltro.style.display = 'inline-block';
  } else {
    if(btnAplicarFiltro) btnAplicarFiltro.style.display = 'none';
  }

  // No necesitamos el listener de 'change' en los filtros para auto-submit,
  // ya que ahora el usuario hará clic explícito en "Aplicar Filtros".

  // Agregar el tipo de reporte al hacer clic en los enlaces de reportes
  const botonesReporte = document.querySelectorAll('a[href^="/admin/reportes/"]');
  botonesReporte.forEach(boton => {
    boton.addEventListener('click', function(e) {
      e.preventDefault();
      const href = this.getAttribute('href');
      const tipo = href.split('/').pop(); // Obtener la última parte de la URL como tipo

      if (tipoReporteInput) tipoReporteInput.value = tipo;
      
      // Si la acción del formulario ya es /admin/reportes, no necesitamos cambiarla.
      // Solo aseguramos que el tipo esté en el input hidden.
      if (formFiltros) {
         if(formFiltros.action.endsWith('/admin/reportes') || formFiltros.action.endsWith('/admin/reportes/')) {
            // La acción ya es correcta, o es la base, solo enviar.
         } else {
            // Si la acción es específica (ej /admin/reportes/financiero), la mantenemos.
            // Si no, la establecemos a la genérica.
            if (!href.startsWith('/admin/reportes/')) {
                 formFiltros.action = '/admin/reportes';
            } else {
                 formFiltros.action = href;
            }
         }
        formFiltros.submit();
      }
    });
  });
});
</script> 