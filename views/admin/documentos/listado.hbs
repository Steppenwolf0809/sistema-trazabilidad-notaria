{{!-- VISTA DE SUPERVISIN - SOLO LECTURA PARA ADMIN --}}
{{!-- SEGREGACIN DE FUNCIONES: Admin solo puede VER documentos, no crear/editar/entregar --}}

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span><i class="fas fa-binoculars me-2"></i> Supervisi贸n de Documentos - Solo Lectura</span>
    {{#unless soloLectura}}
    <a href="/admin/documentos/registro" class="btn btn-sm btn-primary">
      <i class="fas fa-plus me-1"></i> Nuevo Documento
    </a>
    {{/unless}}
    {{#if soloLectura}}
    <div class="alert alert-info mb-0 py-1 px-2 small">
      <i class="fas fa-info-circle me-1"></i> 
      <strong>Modo Supervisi贸n:</strong> Solo puede consultar informaci贸n, no crear/editar/entregar documentos
    </div>
    {{/if}}
  </div>
  <div class="card-body">
    <!-- Filtros -->
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card bg-light">
          <div class="card-body p-3">
            <form id="filtrosForm" method="GET" action="/admin/documentos/listado">
              <div class="row">
                <div class="col-md-2 mb-2">
                  <label for="filtroEstado" class="form-label small">Estado</label>
                  <select class="form-select form-select-sm" id="filtroEstado" name="estado">
                    <option value="">Todos</option>
                    <option value="en_proceso" {{#if (eq filtros.estado 'en_proceso')}}selected{{/if}}>En Proceso</option>
                    <option value="listo_para_entrega" {{#if (eq filtros.estado 'listo_para_entrega')}}selected{{/if}}>Listos para Entrega</option>
                    <option value="entregado" {{#if (eq filtros.estado 'entregado')}}selected{{/if}}>Entregados</option>
                    <option value="nota_credito" {{#if (eq filtros.estado 'nota_credito')}}selected{{/if}}>Notas de Cr茅dito</option>
                  </select>
                </div>
                
                <div class="col-md-2 mb-2">
                  <label for="filtroEstadoPago" class="form-label small">Estado Pago</label>
                  <select class="form-select form-select-sm" id="filtroEstadoPago" name="estadoPago">
                    <option value="">Todos</option>
                    <option value="pendiente" {{#if (eq filtros.estadoPago 'pendiente')}}selected{{/if}}>Pendiente</option>
                    <option value="pagado_completo" {{#if (eq filtros.estadoPago 'pagado_completo')}}selected{{/if}}>Pagado Completo</option>
                    <option value="pagado_con_retencion" {{#if (eq filtros.estadoPago 'pagado_con_retencion')}}selected{{/if}}>Con Retenci贸n</option>
                    <option value="pago_parcial" {{#if (eq filtros.estadoPago 'pago_parcial')}}selected{{/if}}>Pago Parcial</option>
                  </select>
                </div>
                
                <div class="col-md-2 mb-2">
                  <label for="filtroMatrizador" class="form-label small">Matrizador</label>
                  <select class="form-select form-select-sm" id="filtroMatrizador" name="matrizadorId">
                    <option value="">Todos</option>
                    {{#each matrizadores}}
                    <option value="{{this.id}}" {{#if (eq ../filtros.matrizadorId this.id)}}selected{{/if}}>{{this.nombre}}</option>
                    {{/each}}
                  </select>
                </div>
                
                <div class="col-md-2 mb-2">
                  <label for="fechaDesde" class="form-label small">Desde</label>
                  <input type="date" class="form-control form-control-sm" id="fechaDesde" name="fechaDesde" value="{{filtros.fechaDesde}}">
                </div>
                
                <div class="col-md-2 mb-2">
                  <label for="fechaHasta" class="form-label small">Hasta</label>
                  <input type="date" class="form-control form-control-sm" id="fechaHasta" name="fechaHasta" value="{{filtros.fechaHasta}}">
                </div>
                
                <div class="col-md-2 mb-2">
                  <label for="filtroBusqueda" class="form-label small">B煤squeda</label>
                  <input type="text" class="form-control form-control-sm" id="filtroBusqueda" name="busqueda" placeholder="C贸digo, cliente, factura" value="{{filtros.busqueda}}">
                </div>
                
                <div class="col-md-12 text-end mt-2">
                  <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-filter me-1"></i> Filtrar
                  </button>
                  <a href="/admin/documentos/listado" class="btn btn-sm btn-outline-secondary ms-1">
                    <i class="fas fa-times me-1"></i> Limpiar
                  </a>
                  <button type="button" class="btn btn-sm btn-success ms-2" onclick="exportarDatos()">
                    <i class="fas fa-download me-1"></i> Exportar
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Resumen de resultados -->
    {{#if documentos}}
    <div class="row mb-3">
      <div class="col-md-12">
        <div class="alert alert-light mb-0 py-2">
          <i class="fas fa-chart-bar me-2"></i>
          <strong>Resultados:</strong> {{documentos.length}} documentos encontrados
          {{#if pagination.totalPages}}
          (P谩gina {{pagination.currentPage}} de {{pagination.totalPages}})
          {{/if}}
        </div>
      </div>
    </div>
    {{/if}}
    
    <!-- Tabla de documentos -->
    <div class="table-responsive">
      <table class="table table-hover table-striped tabla-ordenable">
        <thead class="table-dark">
          <tr>
            <th class="ordenable" data-columna="codigo" data-tipo="texto">C贸digo</th>
            <th class="ordenable" data-columna="tipo" data-tipo="texto">Tipo</th>
            <th class="ordenable" data-columna="cliente" data-tipo="texto">Cliente</th>
            <th class="ordenable" data-columna="matrizador" data-tipo="texto">Matrizador</th>
            <th class="ordenable" data-columna="fecha" data-tipo="fecha">Fecha Registro</th>
            <th class="ordenable" data-columna="estado" data-tipo="estado">Estado</th>
            <th class="ordenable" data-columna="pago" data-tipo="estado">Estado Pago</th>
            <th class="ordenable" data-columna="valor" data-tipo="numero">Valor</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {{#each documentos}}
          <tr>
            <td><code class="small">{{this.codigoBarras}}</code></td>
            <td>
              <span class="badge bg-secondary">{{this.tipoDocumento}}</span>
            </td>
            <td>
              <strong>{{this.nombreCliente}}</strong>
              <div class="small text-muted">CI: {{this.identificacionCliente}}</div>
              {{#if this.emailCliente}}
              <div class="small text-muted"><i class="fas fa-envelope me-1"></i>{{this.emailCliente}}</div>
              {{/if}}
            </td>
            <td>
              {{#if this.matrizador}}
              <span class="badge bg-info">{{this.matrizador.nombre}}</span>
              {{else}}
              <span class="text-muted">Sin asignar</span>
              {{/if}}
            </td>
            <td>
              <span class="small">{{formatDateDocument this.created_at}}</span>
              {{#if this.fechaFactura}}
              <div class="small text-muted">Fact: {{formatDateDocument this.fechaFactura}}</div>
              {{/if}}
            </td>
            <td>
              {{#if (eq this.estado "en_proceso")}}
              <span class="badge bg-warning text-dark"><i class="fas fa-cog me-1"></i>En Proceso</span>
              {{else if (eq this.estado "listo_para_entrega")}}
              <span class="badge bg-success"><i class="fas fa-check me-1"></i>Listo</span>
              {{else if (eq this.estado "entregado")}}
              <span class="badge bg-primary"><i class="fas fa-handshake me-1"></i>Entregado</span>
              {{else if (eq this.estado "nota_credito")}}
              <span class="badge bg-danger"><i class="fas fa-minus-circle me-1"></i>Nota Cr茅dito</span>
              {{else}}
              <span class="badge bg-secondary">{{this.estado}}</span>
              {{/if}}
            </td>
            <td>
              {{#if this.numeroFactura}}
                {{#if (eq this.estadoPago "pagado_completo")}}
                <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Pagado</span>
                {{else if (eq this.estadoPago "pagado_con_retencion")}}
                <span class="badge bg-info"><i class="fas fa-receipt me-1"></i>Con Retenci贸n</span>
                {{else if (eq this.estadoPago "pago_parcial")}}
                <span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>Parcial</span>
                {{else}}
                <span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Pendiente</span>
                {{/if}}
              {{else}}
              <span class="badge bg-secondary">Sin Factura</span>
              {{/if}}
            </td>
            <td>
              {{#if this.valorFactura}}
              <strong class="text-success">${{formatMoney this.valorFactura}}</strong>
              {{#if this.numero_factura}}
              <div class="small text-muted">Fact: {{this.numero_factura}}</div>
              {{/if}}
              {{else}}
              <span class="text-muted">-</span>
              {{/if}}
            </td>
            <td>
              <div class="btn-group">
                <!-- SOLO LECTURA: Admin puede VER detalles -->
                <a href="/admin/documentos/detalle/{{this.id}}" class="btn btn-sm btn-outline-primary" title="Ver Detalles (Solo Lectura)">
                  <i class="fas fa-eye"></i>
                </a>
                
                {{!-- ELIMINADO POR SEGREGACIN: Admin NO puede editar --}}
                {{#unless soloLectura}}
                {{#if (puedeEditarDocumento ../usuario this)}}
                <a href="/admin/documentos/editar/{{this.id}}" class="btn btn-sm btn-primary" title="Editar Documento">
                  <i class="fas fa-edit"></i>
                </a>
                {{/if}}
                
                {{!-- ELIMINADO POR SEGREGACIN: Admin NO puede marcar documentos como listos --}}
                {{!-- Solo Matrizadores pueden marcar documentos como listos --}}
                
                {{!-- ELIMINADO POR SEGREGACIN: Admin NO puede entregar documentos --}}
                {{!-- Los documentos listos solo pueden ser entregados por Recepci贸n --}}
                {{/unless}}
                
                {{!-- SEGREGACIN: Admin mantiene capacidad de supervisi贸n y eliminaci贸n si es necesario --}}
                {{#if (and (eq ../userRole "admin") (not soloLectura))}}
                {{#unless (eq this.estado "entregado")}}
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="abrirModalEliminar({
                  id: {{this.id}},
                  codigoBarras: '{{this.codigoBarras}}',
                  tipoDocumento: '{{this.tipoDocumento}}',
                  nombreCliente: '{{this.nombreCliente}}',
                  estado: '{{this.estado}}',
                  valorFactura: {{this.valorFactura}},
                  estadoPago: '{{this.estadoPago}}'
                })" title="Eliminar (Supervisi贸n)">
                  <i class="fas fa-trash-alt"></i>
                </button>
                {{/unless}}
                {{/if}}
              </div>
            </td>
          </tr>
          {{else}}
          <tr>
            <td colspan="9" class="text-center py-5">
              <div class="text-muted">
                <i class="fas fa-search fa-2x mb-3"></i>
                <h5>No se encontraron documentos</h5>
                <p class="mb-0">Pruebe ajustando los filtros de b煤squeda</p>
              </div>
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
    
    <!-- Paginaci贸n -->
    {{#if pagination}}
    <nav aria-label="Paginaci贸n de documentos" class="mt-4">
      <ul class="pagination justify-content-center">
        {{#if pagination.hasPrev}}
        <li class="page-item">
          <a class="page-link" href="?page={{pagination.prevPage}}&{{buildQueryString filtros}}">
            <i class="fas fa-chevron-left me-1"></i>Anterior
          </a>
        </li>
        {{else}}
        <li class="page-item disabled">
          <span class="page-link">
            <i class="fas fa-chevron-left me-1"></i>Anterior
          </span>
        </li>
        {{/if}}
        
        <li class="page-item active">
          <span class="page-link">
            P谩gina {{pagination.currentPage}} de {{pagination.totalPages}}
          </span>
        </li>
        
        {{#if pagination.hasNext}}
        <li class="page-item">
          <a class="page-link" href="?page={{pagination.nextPage}}&{{buildQueryString filtros}}">
            Siguiente<i class="fas fa-chevron-right ms-1"></i>
          </a>
        </li>
        {{else}}
        <li class="page-item disabled">
          <span class="page-link">
            Siguiente<i class="fas fa-chevron-right ms-1"></i>
          </span>
        </li>
        {{/if}}
      </ul>
    </nav>
    {{/if}}

    {{!-- INFORMACIN DE SEGREGACIN PARA EDUCACIN DEL USUARIO --}}
    {{#if soloLectura}}
    <div class="alert alert-warning mt-4">
      <h6><i class="fas fa-shield-alt me-2"></i>Segregaci贸n de Funciones - Control de Auditor铆a</h6>
      <p class="mb-2"><strong>Como Administrador, su rol es SUPERVISAR, no operar directamente.</strong></p>
      
      <div class="row">
        <div class="col-md-6">
          <h6 class="text-success"><i class="fas fa-check-circle me-1"></i> Lo que S puede hacer:</h6>
          <ul class="small">
            <li> <strong>Supervisar:</strong> Ver todos los documentos y su estado</li>
            <li> <strong>Reportes:</strong> Generar an谩lisis y estad铆sticas</li>
            <li> <strong>Auditar:</strong> Revisar registros y trazabilidad</li>
            <li> <strong>Gestionar:</strong> Usuarios y configuraciones</li>
          </ul>
        </div>
        <div class="col-md-6">
          <h6 class="text-danger"><i class="fas fa-times-circle me-1"></i> Lo que NO puede hacer:</h6>
          <ul class="small">
            <li> <strong>Crear documentos:</strong> Solo <span class="badge bg-primary">Caja</span></li>
            <li>锔 <strong>Procesar/Marcar listos:</strong> Solo <span class="badge bg-info">Matrizadores</span></li>
            <li> <strong>Entregar documentos:</strong> Solo <span class="badge bg-success">Recepci贸n</span></li>
            <li> <strong>Registrar pagos:</strong> Solo <span class="badge bg-primary">Caja</span></li>
          </ul>
        </div>
      </div>
      
      <hr class="my-2">
      <p class="mb-0 small text-muted">
        <i class="fas fa-info-circle me-1"></i>
        Esta separaci贸n garantiza controles internos apropiados y facilita auditor铆as. 
        Para operaciones, contacte al rol correspondiente.
      </p>
    </div>
    {{/if}}
  </div>
</div>

{{!-- ELIMINADO: Scripts de operaciones que admin no debe realizar --}}
{{#unless soloLectura}}
<script>
// Scripts originales mantenerlos solo si no est谩 en modo solo lectura
function marcarListo(documentoId) {
  // Funci贸n original...
}

function exportarDatos() {
  // Funci贸n para exportar datos de supervisi贸n
  window.location.href = '/admin/reportes/documentos?formato=excel&' + $('#filtrosForm').serialize();
}
</script>
{{/unless}}

{{#if soloLectura}}
<script>
// Solo funciones de consulta para modo supervisi贸n
function exportarDatos() {
  // Funci贸n para exportar datos de supervisi贸n
  window.location.href = '/admin/reportes/documentos?formato=excel&' + $('#filtrosForm').serialize();
}

// Mostrar tooltips informativos
document.addEventListener('DOMContentLoaded', function() {
  // Inicializar tooltips de Bootstrap
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>
{{/if}} 