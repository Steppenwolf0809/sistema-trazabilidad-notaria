{{! Listado de Documentos - Recepci√≥n }}
{{! layout: 'recepcion' }}
<div class="container mt-4">
  <h2>Listado de Documentos</h2>
  
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span><i class="fas fa-list me-2"></i> Documentos</span>
    </div>
    <div class="card-body">
      <!-- Filtros -->
      <form method="GET" action="/recepcion/documentos" class="mb-4">
        <div class="row mb-3">
          <div class="col-md-2">
            <label for="estado" class="form-label">Estado</label>
            <select class="form-select form-select-sm" id="estado" name="estado">
              <option value="">Todos</option>
              <option value="en_proceso" {{#if filtros.estado.en_proceso}}selected{{/if}}>En Proceso</option>
              <option value="listo_para_entrega" {{#if filtros.estado.listo_para_entrega}}selected{{/if}}>Listo</option>
              <option value="entregado" {{#if filtros.estado.entregado}}selected{{/if}}>Entregado</option>
            </select>
          </div>
          <div class="col-md-2">
            <label for="estadoPago" class="form-label">Estado Pago</label>
            <select class="form-select form-select-sm" id="estadoPago" name="estadoPago">
              <option value="">Todos</option>
              <option value="pendiente" {{#if (eq filtros.estadoPago "pendiente")}}selected{{/if}}>Pendiente</option>
              <option value="pago_parcial" {{#if (eq filtros.estadoPago "pago_parcial")}}selected{{/if}}>Pago Parcial</option>
              <option value="pagado_completo" {{#if (eq filtros.estadoPago "pagado_completo")}}selected{{/if}}>Pagado Completo</option>
              <option value="pagado_con_retencion" {{#if (eq filtros.estadoPago "pagado_con_retencion")}}selected{{/if}}>Pagado con Retenci√≥n</option>
            </select>
          </div>
          <div class="col-md-2">
            <label for="tipoDocumento" class="form-label">Tipo</label>
            <select class="form-select form-select-sm" id="tipoDocumento" name="tipoDocumento">
              <option value="">Todos</option>
              {{#each tiposDocumento}}
              <option value="{{this}}" {{#if (eq ../filtros.tipoDocumento this)}}selected{{/if}}>{{this}}</option>
              {{/each}}
            </select>
          </div>
          <div class="col-md-2">
            <label for="idMatrizador" class="form-label">Matrizador</label>
            <select class="form-select form-select-sm" id="idMatrizador" name="idMatrizador">
              <option value="">Todos</option>
              {{#each matrizadores}}
              <option value="{{this.id}}" {{#if (eq ../filtros.idMatrizador (stringifyNumber this.id))}}selected{{/if}}>{{this.nombre}}</option>
              {{/each}}
            </select>
          </div>
          <div class="col-md-3">
            <label for="busqueda" class="form-label">Buscar</label>
            <input type="text" class="form-control form-control-sm" id="busqueda" name="busqueda" placeholder="C√≥digo o cliente..." value="{{filtros.busqueda}}">
          </div>
          <div class="col-md-1 d-flex align-items-end">
            <button type="submit" class="btn btn-primary btn-sm w-100">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
      </form>
      
      <!-- Tabla de documentos -->
      <div class="table-responsive">
        <table class="table table-hover table-striped tabla-ordenable">
          <thead class="table-light">
            <tr>
              <th class="ordenable" data-columna="codigo" data-tipo="texto">
                <span>C√≥digo</span>
                <i class="fas fa-sort ms-1"></i>
              </th>
              <th class="ordenable" data-columna="tipo" data-tipo="texto">
                <span>Tipo</span>
                <i class="fas fa-sort ms-1"></i>
              </th>
              <th class="ordenable" data-columna="cliente" data-tipo="texto">
                <span>Cliente</span>
                <i class="fas fa-sort ms-1"></i>
              </th>
              <th class="ordenable" data-columna="matrizador" data-tipo="texto">
                <span>Matrizador</span>
                <i class="fas fa-sort ms-1"></i>
              </th>
              <th class="ordenable" data-columna="fecha" data-tipo="fecha">
                <span>Fecha Registro Sistema</span>
                <i class="fas fa-sort ms-1"></i>
              </th>
              <th class="ordenable" data-columna="estado" data-tipo="estado">
                <span>Estado</span>
                <i class="fas fa-sort ms-1"></i>
              </th>
              <th class="ordenable" data-columna="estadoPago" data-tipo="estado">
                <span>Estado Pago</span>
                <i class="fas fa-sort ms-1"></i>
              </th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {{#each documentos}}
            <tr>
              <td><span class="small">{{this.codigoBarras}}</span></td>
              <td>
                <span class="badge badge-estado badge-tipo bg-secondary">{{this.tipoDocumento}}</span>
              </td>
              <td>
                {{this.nombreCliente}}
                <div class="small text-muted">{{this.identificacionCliente}}</div>
              </td>
              <td>
                {{#if this.matrizador}}
                <span class="badge bg-info">{{this.matrizador.nombre}}</span>
                {{else}}
                <span class="text-muted">No asignado</span>
                {{/if}}
              </td>
              <td>{{formatDateDocument this.created_at}}</td>
              <td class="columna-estado">
                {{#if (eq this.estado "en_proceso")}}
                <span class="badge badge-estado badge-estado-medio bg-warning text-dark">En Proceso</span>
                {{else if (eq this.estado "listo_para_entrega")}}
                <span class="badge badge-estado badge-estado-corto bg-success">Listo</span>
                {{else if (eq this.estado "entregado")}}
                <span class="badge badge-estado badge-estado-largo bg-primary">Entregado</span>
                {{else}}
                <span class="badge badge-estado bg-secondary">{{this.estado}}</span>
                {{/if}}
              </td>
              <td class="columna-estado">
                {{#if (eq this.estadoPago "pagado_completo")}}
                <span class="badge badge-estado badge-estado-corto bg-success"><i class="fas fa-check"></i> Pagado</span>
                {{else if (eq this.estadoPago "pagado_con_retencion")}}
                <span class="badge badge-estado badge-estado-largo bg-info"><i class="fas fa-receipt"></i> Con Retenci√≥n</span>
                {{else if (eq this.estadoPago "pago_parcial")}}
                <span class="badge badge-estado badge-estado-medio bg-warning text-dark"><i class="fas fa-clock"></i> Parcial</span>
                {{else}}
                <span class="badge badge-estado badge-estado-medio bg-danger"><i class="fas fa-exclamation-triangle"></i> Pendiente</span>
                {{/if}}
              </td>
              <td>
                <div class="btn-group">
                  <a href="/recepcion/documentos/detalle/{{this.id}}" class="btn btn-sm btn-outline-primary" title="Ver Detalles">
                    <i class="fas fa-eye"></i>
                  </a>
                  
                  {{#if (puedeMarcarComoListoRecepcion ../usuario this)}}
                  <button type="button" class="btn btn-sm btn-outline-success" title="Marcar como Listo para Entrega" onclick="mostrarModalMarcarListoRecepcion({{this.id}})">
                    <i class="fas fa-check-circle"></i>
                  </button>
                  {{/if}}

                  {{#if (eq this.estado "listo_para_entrega")}}
                  <a href="/recepcion/documentos/entrega/{{this.id}}" class="btn btn-sm btn-outline-warning" title="Entregar Documento">
                    <i class="fas fa-handshake"></i>
                  </a>
                  {{/if}}
                </div>
              </td>
            </tr>
            {{else}}
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                <i class="fas fa-file-alt fa-2x mb-2"></i><br>
                No se encontraron documentos
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
      
      <!-- Paginaci√≥n -->
      {{#if pagination}}
      <nav aria-label="Paginaci√≥n de documentos">
        <ul class="pagination justify-content-center">
          {{#if pagination.prev}}
          <li class="page-item">
            <a class="page-link" href="{{pagination.prev}}">Anterior</a>
          </li>
          {{else}}
          <li class="page-item disabled">
            <a class="page-link">Anterior</a>
          </li>
          {{/if}}
          
          {{#each pagination.pages}}
          <li class="page-item {{#if this.active}}active{{/if}}">
            <a class="page-link" href="{{this.url}}">{{this.num}}</a>
          </li>
          {{/each}}
          
          {{#if pagination.next}}
          <li class="page-item">
            <a class="page-link" href="{{pagination.next}}">Siguiente</a>
          </li>
          {{else}}
          <li class="page-item disabled">
            <a class="page-link">Siguiente</a>
          </li>
          {{/if}}
        </ul>
      </nav>
      {{/if}}
    </div>
  </div>
</div>

<!-- Modal de Confirmaci√≥n para Marcar como Listo (Recepci√≥n) -->
<div class="modal fade" id="marcarListoModalRecepcion" tabindex="-1" aria-labelledby="marcarListoModalRecepcionLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="marcarListoModalRecepcionLabel">Confirmar Acci√≥n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>¬øEst√° seguro de que desea marcar este documento como "Listo para Entrega"?</p>
        <p class="text-muted small">Esto generar√° un nuevo c√≥digo de verificaci√≥n si no existe uno o si se decide regenerar.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <form id="marcarListoFormRecepcion" action="/recepcion/documentos/marcar-listo" method="POST" class="d-inline">
          <input type="hidden" id="idDocumentoMarcarListoRecepcion" name="documentoId">
          <button type="submit" class="btn btn-success">Confirmar y Marcar Listo</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üóÇÔ∏è Inicializando vista recepci√≥n con ordenamiento mejorado');
    
    // Inicializar ordenamiento de tablas
    if (typeof inicializarOrdenamientoTablas === 'function') {
      inicializarOrdenamientoTablas();
      console.log('‚úÖ Ordenamiento de tablas inicializado para recepci√≥n');
    } else {
      console.warn('‚ö†Ô∏è Funci√≥n inicializarOrdenamientoTablas no encontrada');
    }
    
    console.log('‚úÖ Vista recepci√≥n cargada correctamente - Ordenamiento activado');
  });

  function mostrarModalMarcarListoRecepcion(idDocumento) {
    document.getElementById('idDocumentoMarcarListoRecepcion').value = idDocumento;
    const modal = new bootstrap.Modal(document.getElementById('marcarListoModalRecepcion'));
    modal.show();
  }
</script> 