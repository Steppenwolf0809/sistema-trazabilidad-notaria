{{! Entrega de Documento - Recepci√≥n }}
{{! layout: 'recepcion' }}
<div class="container-fluid" data-user-role="recepcion">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-handshake me-2"></i>Entrega de Documentos - Recepci√≥n</h2>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/recepcion">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/recepcion/documentos">Documentos</a></li>
            <li class="breadcrumb-item active">Entrega</li>
          </ol>
        </nav>
      </div>

      {{!-- Mensajes de estado --}}
      {{#if error}}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fas fa-exclamation-triangle me-2"></i>{{error}}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {{/if}}

      {{#if success}}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="fas fa-check-circle me-2"></i>{{success}}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {{/if}}

      {{#if documento}}
        {{!-- ============== 1. DOCUMENTO PRINCIPAL CON INFORMACI√ìN COMPLETA ============== --}}
        <div class="card mb-3">
          <div class="card-header bg-info text-white">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h5 class="mb-1">
                  <i class="fas fa-file-alt me-2"></i>üìÑ Documento Principal: {{documento.codigoBarras}}
                </h5>
                <small class="opacity-75">
                  <strong>C√≥digo de Verificaci√≥n:</strong> 
                  {{#if documento.codigoVerificacion}}
                    {{#if (eq documento.codigoVerificacion 'sin_codigo')}}
                      <span class="badge bg-warning text-dark">Sin c√≥digo</span>
                    {{else}}
                      <code class="bg-light text-dark px-2 py-1 rounded">{{documento.codigoVerificacion}}</code>
                    {{/if}}
                  {{else}}
                    <span class="badge bg-warning text-dark">Sin c√≥digo</span>
                  {{/if}}
                </small>
              </div>
              <span class="badge bg-light text-dark fs-6">{{documento.tipoDocumento}}</span>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <h6><i class="fas fa-user me-1"></i> Cliente</h6>
                <p class="mb-1"><strong>{{documento.nombreCliente}}</strong></p>
                <p class="text-muted mb-0"><small>{{documento.identificacionCliente}}</small></p>
              </div>
              <div class="col-md-3">
                <h6><i class="fas fa-user-tie me-1"></i> Matrizador</h6>
                <p class="mb-1"><strong>{{#if documento.matrizador}}{{documento.matrizador.nombre}}{{else}}Sin asignar{{/if}}</strong></p>
                <p class="text-muted mb-0"><small>Responsable</small></p>
              </div>
              <div class="col-md-3">
                <h6><i class="fas fa-dollar-sign me-1"></i> Valor</h6>
                <p class="mb-1"><strong>${{formatMoney documento.valorFactura}}</strong></p>
                <p class="text-muted mb-0"><small>{{#if documento.numeroFactura}}Fact: {{documento.numeroFactura}}{{else}}Sin factura{{/if}}</small></p>
              </div>
              <div class="col-md-3">
                <h6><i class="fas fa-credit-card me-1"></i> Estado Pago</h6>
                <span class="badge {{estadoPagoClass documento.estadoPago}} fs-6">
                  {{estadoPagoTexto documento.estadoPago}}
                </span>
              </div>
            </div>
          </div>
        </div>

        {{!-- ============== 2. DOCUMENTOS ADICIONALES DETECTADOS ============== --}}
        {{#if documentosGrupales.tieneDocumentosAdicionales}}
          <div class="alert alert-info" id="alerta-entrega-grupal">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6><i class="fas fa-boxes me-2"></i>Documentos Adicionales Detectados</h6>
                <p class="mb-2">
                  Se encontraron <strong>{{documentosGrupales.cantidad}} documento(s) adicional(es)</strong> 
                  del mismo cliente listos para entrega.
                </p>
                <p class="mb-0 text-info">
                  <i class="fas fa-shield-alt me-1"></i>
                  <strong>Acceso Recepci√≥n:</strong> Puede entregar TODOS los documentos sin restricciones
                </p>
                
                {{!-- ============== NUEVA SECCI√ìN: ALERTAS DE DOCUMENTOS PENDIENTES ============== --}}
                {{#if documentosGrupales.requiereAutorizacion}}
                  <div class="alert alert-warning mt-3" id="alerta-documentos-pendientes">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Documentos con Pago Pendiente Detectados</h6>
                    <p class="mb-2">
                      <strong>{{documentosGrupales.documentosPendientes.length}} documento(s)</strong> tienen pago pendiente.
                      Debe confirmar que ha consultado con el matrizador responsable.
                    </p>
                    <div class="mt-2">
                      {{#each documentosGrupales.alertas}}
                        <div class="alert alert-light border-warning p-2 mb-2">
                          <div class="d-flex justify-content-between align-items-center">
                            <div>
                              <strong>{{this.codigo}}</strong> - {{this.tipoDocumento}}
                              <br><small class="text-muted">Valor: ${{formatMoney this.valor}} - Estado: {{this.estadoPago}}</small>
                            </div>
                            <div class="text-end">
                              <small><strong>Matrizador:</strong><br>{{this.matrizador}}</small>
                            </div>
                          </div>
                        </div>
                      {{/each}}
                    </div>
                  </div>
                {{/if}}
              </div>
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="ocultarEntregaGrupal()">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>

          {{!-- Tabla de documentos adicionales con ESTADO DE PAGO VISIBLE --}}
          <div class="card mb-4" id="seccion-entrega-grupal">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                  <i class="fas fa-list-check me-2"></i>
                  Seleccionar Documentos Adicionales
                </h6>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="selectAll">
                  <label class="form-check-label" for="selectAll">
                    <strong>Seleccionar todos</strong>
                  </label>
                </div>
              </div>
            </div>
            <div class="card-body">
              {{!-- Encabezado con nombre del cliente --}}
              <div class="alert alert-info border-info mb-3">
                <div class="d-flex align-items-center">
                  <i class="fas fa-user me-3 fs-4"></i>
                  <div>
                    <h6 class="mb-1">üìÑ <strong>DOCUMENTOS PARA:</strong></h6>
                    <h5 class="mb-0 text-info"><strong>{{documento.nombreCliente}}</strong></h5>
                    <small class="text-muted">ID: {{documento.identificacionCliente}}</small>
                  </div>
                </div>
              </div>
              
              <div class="table-responsive">
                <table class="table table-hover table-sm">
                  <thead class="table-light">
                    <tr>
                      <th width="50">Seleccionar</th>
                      <th>C√≥digo</th>
                      <th>Tipo</th>
                      <th>Matrizador</th>
                      <th>Valor</th>
                      <th>Estado Pago</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    {{#each documentosGrupales.documentos}}
                      <tr>
                        <td>
                          <div class="form-check">
                            <input 
                              class="form-check-input documento-checkbox" 
                              type="checkbox" 
                              value="{{this.id}}"
                              data-codigo="{{this.codigoVerificacion}}"
                              data-matrizador-id="{{this.matrizadorId}}"
                              id="doc_{{this.id}}">
                            <label class="form-check-label" for="doc_{{this.id}}"></label>
                          </div>
                        </td>
                        <td>
                          <strong>{{this.codigoBarras}}</strong>
                        </td>
                        <td>
                          <span class="badge bg-secondary">{{this.tipoDocumento}}</span>
                        </td>
                        <td>
                          <span class="badge bg-info">{{#if this.matrizador}}{{this.matrizador.nombre}}{{else}}Sin asignar{{/if}}</span>
                        </td>
                        <td>
                          <strong>${{formatMoney this.valorFactura}}</strong>
                        </td>
                        <td>
                          <span class="badge {{estadoPagoClass this.estadoPago}}">
                            {{estadoPagoTexto this.estadoPago}}
                          </span>
                        </td>
                        <td>
                          <span class="badge bg-success">Listo</span>
                        </td>
                      </tr>
                    {{/each}}
                  </tbody>
                </table>
              </div>

              {{!-- Contador de selecci√≥n mejorado --}}
              <div class="mt-3">
                <div class="alert alert-light border">
                  <div class="d-flex justify-content-between align-items-center">
                    <span>
                      <i class="fas fa-info-circle me-2 text-info"></i>
                      <span id="contador-seleccion">1 documento(s) seleccionado(s)</span>
                    </span>
                    <div id="codigos-seleccionados" class="small text-muted"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {{/if}}

        {{!-- ============== 3. FORMULARIO DE ENTREGA CORREGIDO ============== --}}
        <form id="formEntrega" action="/recepcion/documentos/entrega/{{documento.id}}" method="POST">
          {{!-- Campos ocultos para entrega grupal --}}
          <input type="hidden" id="documentos_seleccionados" name="documentosAdicionales" value="">
          <input type="hidden" id="entrega_grupal" name="entregaGrupal" value="false">
          <input type="hidden" name="tipoEntregaGrupal" value="recepcion_completa">

          {{!-- SECCI√ìN: VALIDACI√ìN DE C√ìDIGO CORREGIDA --}}
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-key me-2"></i>
                Validaci√≥n de C√≥digo
              </h6>
            </div>
            <div class="card-body">
              {{!-- Mostrar c√≥digos v√°lidos din√°micamente --}}
              <div class="alert alert-info" id="alert-codigos-validos">
                <strong>C√≥digos v√°lidos para esta entrega:</strong>
                <div id="lista-codigos-validos">
                  {{#if documento.codigoVerificacion}}
                    {{#unless (eq documento.codigoVerificacion 'sin_codigo')}}
                      <code class="bg-dark text-light px-2 py-1 rounded me-2">{{documento.codigoVerificacion}}</code>
                      <small class="text-muted">(documento principal)</small>
                    {{/unless}}
                  {{/if}}
                </div>
              </div>

              {{!-- Input de c√≥digo con validaci√≥n mejorada --}}
              <div class="row">
                <div class="col-md-6">
                  <label for="codigoVerificacion" class="form-label">
                    <strong>C√≥digo de Verificaci√≥n</strong>
                    <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="codigoVerificacion" name="codigoVerificacion" 
                           placeholder="Ingrese c√≥digo de 4 d√≠gitos" maxlength="6" required>
                    <button type="button" class="btn btn-outline-primary" id="validarCodigo">
                      <i class="fas fa-check me-1"></i>Validar
                    </button>
                  </div>
                  <div id="mensaje-validacion-codigo" class="mt-2"></div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">M√©todo de verificaci√≥n alternativo</label>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="tipoVerificacion" value="llamada" id="verificacionLlamada">
                    <label class="form-check-label" for="verificacionLlamada">
                      Verificaci√≥n por llamada telef√≥nica
                    </label>
                  </div>
                  <div id="div-observaciones" class="mt-2 d-none">
                    <textarea class="form-control" id="observaciones" name="observaciones" rows="2" 
                              placeholder="Detalles de la verificaci√≥n por llamada..."></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {{!-- SECCI√ìN: INFORMACI√ìN DEL RECEPTOR --}}
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-user-check me-2"></i>
                Informaci√≥n del Receptor
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="nombreReceptor" class="form-label">
                    <strong>Nombre completo del receptor</strong>
                    <span class="text-danger">*</span>
                  </label>
                  <input type="text" class="form-control" id="nombreReceptor" name="nombreReceptor" 
                         placeholder="Nombre completo de quien recibe" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="identificacionReceptor" class="form-label">
                    <strong>Identificaci√≥n del receptor</strong>
                    <span class="text-danger">*</span>
                  </label>
                  <input type="text" class="form-control" id="identificacionReceptor" name="identificacionReceptor" 
                         placeholder="C√©dula o identificaci√≥n" required>
                </div>
              </div>
              <div class="mb-3">
                <label for="relacionReceptor" class="form-label">
                  <strong>Relaci√≥n con el cliente</strong>
                  <span class="text-danger">*</span>
                </label>
                <select class="form-select" id="relacionReceptor" name="relacionReceptor" required>
                  <option value="">Seleccione la relaci√≥n</option>
                  <option value="titular">Titular del documento</option>
                  <option value="representante_legal">Representante legal</option>
                  <option value="apoderado">Apoderado</option>
                  <option value="familiar">Familiar autorizado</option>
                  <option value="empleado">Empleado autorizado</option>
                  <option value="tercero_autorizado">Tercero autorizado</option>
                </select>
              </div>
            </div>
          </div>

          {{!-- ============== NUEVA SECCI√ìN: AUTORIZACI√ìN PARA DOCUMENTOS PENDIENTES ============== --}}
          {{#if documentosGrupales.requiereAutorizacion}}
            <div class="card mb-4 border-warning" id="seccion-autorizacion">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  Autorizaci√≥n Requerida
                </h6>
              </div>
              <div class="card-body">
                <div class="alert alert-warning">
                  <p class="mb-3">
                    <strong>Se detectaron documentos con pago pendiente.</strong> 
                    Para proceder con la entrega, debe confirmar que ha consultado con el matrizador responsable.
                  </p>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="confirmarEntregaPendiente" name="confirmarEntregaPendiente" value="true" required>
                    <label class="form-check-label" for="confirmarEntregaPendiente">
                      <strong>Confirmo que he consultado con el matrizador responsable y autorizo la entrega de documentos con pago pendiente</strong>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          {{/if}}

          {{!-- BOT√ìN DE CONFIRMACI√ìN --}}
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-info btn-lg" id="btnConfirmarEntrega">
              <i class="fas fa-check-circle me-2"></i>
              Confirmar Entrega
            </button>
          </div>
        </form>

      {{else}}
        {{!-- ============== B√öSQUEDA Y LISTADO DE DOCUMENTOS ============== --}}
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-search me-2"></i>
              Buscar Documento para Entrega
            </h5>
          </div>
          <div class="card-body">
            <form action="/recepcion/documentos/entrega" method="GET">
              <div class="input-group mb-3">
                <input type="text" class="form-control form-control-lg" name="codigo" 
                       placeholder="Escanee o ingrese el c√≥digo de barras del documento" 
                       value="{{filtros.codigo}}" autofocus>
                <button class="btn btn-primary btn-lg" type="submit">
                  <i class="fas fa-search me-1"></i>Buscar
                </button>
              </div>
            </form>
          </div>
        </div>

        {{!-- LISTA DE DOCUMENTOS LISTOS CON ESTADO DE PAGO VISIBLE --}}
        {{#if documentosListos.length}}
          <div class="card mt-4">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-list me-2"></i>
                Documentos Listos para Entrega ({{documentosListos.length}})
              </h6>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>C√≥digo</th>
                      <th>Cliente</th>
                      <th>Tipo</th>
                      <th>Matrizador</th>
                      <th>Valor</th>
                      <th>Estado Pago</th>
                      <th>Fecha Registro</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    {{#each documentosListos}}
                      <tr>
                        <td><strong>{{this.codigoBarras}}</strong></td>
                        <td>
                          <div>{{this.nombreCliente}}</div>
                          <small class="text-muted">{{this.identificacionCliente}}</small>
                        </td>
                        <td>
                          <span class="badge bg-secondary">{{this.tipoDocumento}}</span>
                        </td>
                        <td>
                          <span class="badge bg-info">{{#if this.matrizador}}{{this.matrizador.nombre}}{{else}}Sin asignar{{/if}}</span>
                        </td>
                        <td><strong>${{formatMoney this.valorFactura}}</strong></td>
                        <td>
                          <span class="badge {{estadoPagoClass this.estadoPago}}">
                            {{estadoPagoTexto this.estadoPago}}
                          </span>
                        </td>
                        <td>{{formatDate this.created_at}}</td>
                        <td>
                          <a href="/recepcion/documentos/entrega/{{this.id}}" class="btn btn-sm btn-primary">
                            <i class="fas fa-handshake me-1"></i>Entregar
                          </a>
                        </td>
                      </tr>
                    {{/each}}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        {{else}}
          <div class="card mt-4">
            <div class="card-body text-center py-5">
              <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
              <h5>No hay documentos listos para entrega</h5>
              <p class="text-muted">Todos los documentos han sido entregados o est√°n en proceso.</p>
            </div>
          </div>
        {{/if}}
      {{/if}}
    </div>
  </div>
</div>

{{!-- ============== JAVASCRIPT CORREGIDO PARA FUNCIONALIDAD ============== --}}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Configuraci√≥n global (igual que admin)
  window.documentoPrincipal = {{{json documento}}};
  window.documentosDisponibles = {{{json documentosGrupales.documentos}}};
  window.usuarioActual = { rol: 'recepcion' };
  
  // Variables del DOM (id√©nticas a admin y matrizador)
  const selectAll = document.getElementById('selectAll');
  const documentoCheckboxes = document.querySelectorAll('.documento-checkbox');
  const contadorSeleccion = document.getElementById('contador-seleccion');
  const codigoInput = document.getElementById('codigoVerificacion');
  const btnValidar = document.getElementById('validarCodigo');
  const listaCodigosValidos = document.getElementById('lista-codigos-validos');
  const verificacionLlamada = document.getElementById('verificacionLlamada');
  const divObservaciones = document.getElementById('div-observaciones');
  const btnConfirmar = document.getElementById('btnConfirmarEntrega');
  
  // ============== GESTI√ìN DE SELECCI√ìN DE DOCUMENTOS (ID√âNTICA) ==============
  function actualizarSeleccion() {
    const seleccionados = Array.from(documentoCheckboxes).filter(cb => cb.checked);
    const total = seleccionados.length + 1; // +1 por el documento principal
    
    // Actualizar contador
    if (contadorSeleccion) {
      contadorSeleccion.textContent = `${total} documento(s) seleccionado(s)`;
    }
    
    // Actualizar c√≥digos v√°lidos
    if (listaCodigosValidos && window.documentoPrincipal) {
      let codigosHTML = '';
      
      // C√≥digo del documento principal
      if (window.documentoPrincipal.codigoVerificacion && window.documentoPrincipal.codigoVerificacion !== 'sin_codigo') {
        codigosHTML += `<code class="bg-dark text-light px-2 py-1 rounded me-2">{{documento.codigoVerificacion}}</code>`;
        codigosHTML += `<small class="text-muted me-3">(principal)</small>`;
      }
      
      // C√≥digos de documentos seleccionados
      seleccionados.forEach((checkbox, index) => {
        const codigo = checkbox.dataset.codigo;
        if (codigo && codigo !== 'sin_codigo') {
          codigosHTML += `<code class="bg-success text-light px-2 py-1 rounded me-2">${codigo}</code>`;
          codigosHTML += `<small class="text-muted me-3">(seleccionado ${index + 1})</small>`;
        }
      });
      
      if (codigosHTML === '') {
        codigosHTML = '<span class="text-warning">‚ö†Ô∏è Documentos sin c√≥digo - usar verificaci√≥n alternativa</span>';
      }
      
      listaCodigosValidos.innerHTML = codigosHTML;
    }
    
    // Actualizar campos ocultos
    const idsSeleccionados = seleccionados.map(cb => cb.value);
    document.getElementById('documentos_seleccionados').value = idsSeleccionados.join(',');
    document.getElementById('entrega_grupal').value = idsSeleccionados.length > 0 ? 'true' : 'false';
  }
  
  // Event listeners (id√©nticos a admin y matrizador)
  if (selectAll) {
    selectAll.addEventListener('change', function() {
      documentoCheckboxes.forEach(cb => {
        cb.checked = this.checked;
      });
      actualizarSeleccion();
    });
  }
  
  documentoCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', actualizarSeleccion);
  });
  
  // Validaci√≥n de c√≥digo (id√©ntica)
  if (btnValidar && codigoInput) {
    btnValidar.addEventListener('click', function() {
      const codigoIngresado = codigoInput.value.trim();
      const mensajeDiv = document.getElementById('mensaje-validacion-codigo');
      
      if (!codigoIngresado) {
        mensajeDiv.innerHTML = '<div class="alert alert-warning alert-sm mt-2">‚ö†Ô∏è Ingrese un c√≥digo</div>';
        return;
      }
      
      // Obtener c√≥digos v√°lidos (recepci√≥n puede validar todos)
      const codigosValidos = [];
      
      // C√≥digo principal
      if (window.documentoPrincipal && window.documentoPrincipal.codigoVerificacion && 
          window.documentoPrincipal.codigoVerificacion !== 'sin_codigo') {
        codigosValidos.push(window.documentoPrincipal.codigoVerificacion);
      }
      
      // C√≥digos de seleccionados
      const seleccionados = Array.from(documentoCheckboxes).filter(cb => cb.checked);
      seleccionados.forEach(cb => {
        const codigo = cb.dataset.codigo;
        if (codigo && codigo !== 'sin_codigo') {
          codigosValidos.push(codigo);
        }
      });
      
      // Validar c√≥digo
      if (codigosValidos.includes(codigoIngresado)) {
        mensajeDiv.innerHTML = '<div class="alert alert-success alert-sm mt-2">‚úÖ C√≥digo v√°lido</div>';
        codigoInput.classList.remove('is-invalid');
        codigoInput.classList.add('is-valid');
      } else {
        mensajeDiv.innerHTML = `<div class="alert alert-danger alert-sm mt-2">‚ùå C√≥digo inv√°lido. C√≥digos v√°lidos: ${codigosValidos.join(', ')}</div>`;
        codigoInput.classList.remove('is-valid');
        codigoInput.classList.add('is-invalid');
      }
    });
  }
  
  // Verificaci√≥n alternativa (id√©ntica)
  if (verificacionLlamada) {
    verificacionLlamada.addEventListener('change', function() {
      if (this.checked) {
        divObservaciones.classList.remove('d-none');
        document.getElementById('observaciones').setAttribute('required', '');
        codigoInput.removeAttribute('required');
      } else {
        divObservaciones.classList.add('d-none');
        document.getElementById('observaciones').removeAttribute('required');
        codigoInput.setAttribute('required', '');
      }
    });
  }
  
  // Validaci√≥n de formulario (id√©ntica)
  if (btnConfirmar) {
    document.getElementById('formEntrega').addEventListener('submit', function(e) {
      // ============== NUEVA VALIDACI√ìN: AUTORIZACI√ìN PARA DOCUMENTOS PENDIENTES ==============
      const checkboxAutorizacion = document.getElementById('confirmarEntregaPendiente');
      if (checkboxAutorizacion && !checkboxAutorizacion.checked) {
        e.preventDefault();
        alert('Debe confirmar que ha consultado con el matrizador responsable para proceder con la entrega de documentos con pago pendiente.');
        checkboxAutorizacion.focus();
        return false;
      }
      
      const entregaGrupal = document.getElementById('entrega_grupal').value === 'true';
      const numDocumentos = entregaGrupal ? 
        document.getElementById('documentos_seleccionados').value.split(',').length + 1 : 1;
      
      if (entregaGrupal) {
        btnConfirmar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Procesando entrega grupal (${numDocumentos} documentos)...`;
      } else {
        btnConfirmar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Procesando entrega...`;
      }
      
      btnConfirmar.disabled = true;
    });
  }
  
  // Inicializar selecci√≥n
  actualizarSeleccion();
  
  // Funciones espec√≠ficas para recepci√≥n
  window.ocultarEntregaGrupal = function() {
    document.getElementById('alerta-entrega-grupal').style.display = 'none';
    document.getElementById('seccion-entrega-grupal').style.display = 'none';
  };
});
</script> 