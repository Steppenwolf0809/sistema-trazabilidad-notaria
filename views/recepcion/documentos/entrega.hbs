{{! Entrega de Documento - Recepción }}
{{! layout: 'recepcion' }}
<div class="container-fluid" data-user-role="recepcion">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-handshake me-2"></i>Entrega de Documentos - Recepción</h2>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/recepcion">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/recepcion/documentos">Documentos</a></li>
            <li class="breadcrumb-item active">Entrega</li>
          </ol>
        </nav>
      </div>

      {{!-- Mensajes de estado --}}
      {{#if error}}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fas fa-exclamation-triangle me-2"></i>{{error}}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {{/if}}

      {{#if success}}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="fas fa-check-circle me-2"></i>{{success}}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {{/if}}

      {{#if documento}}
        {{!-- ============== INCLUIR ESTILOS JERÁRQUICOS ============== --}}
        <link rel="stylesheet" href="/css/entrega-grupal-jerarquica.css">

        {{!-- ============== 1. DOCUMENTO PRINCIPAL CON INFORMACIÓN COMPLETA ============== --}}
        <div class="card mb-3">
          <div class="card-header bg-info text-white">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h5 class="mb-1">
                  <i class="fas fa-file-alt me-2"></i>📄 Documento Principal: {{documento.codigoBarras}}
                </h5>
                <small class="opacity-75">
                  <strong>Código de Verificación:</strong> 
                  {{#if documento.codigoVerificacion}}
                    {{#if (eq documento.codigoVerificacion 'sin_codigo')}}
                      <span class="badge bg-warning text-dark">Sin código</span>
                    {{else}}
                      <code class="bg-light text-dark px-2 py-1 rounded">{{documento.codigoVerificacion}}</code>
                    {{/if}}
                  {{else}}
                    <span class="badge bg-warning text-dark">Sin código</span>
                  {{/if}}
                </small>
              </div>
              <span class="badge bg-light text-dark fs-6">{{documento.tipoDocumento}}</span>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <h6><i class="fas fa-user me-1"></i> Cliente</h6>
                <p class="mb-1"><strong>{{documento.nombreCliente}}</strong></p>
                <p class="text-muted mb-0"><small>{{documento.identificacionCliente}}</small></p>
              </div>
              <div class="col-md-3">
                <h6><i class="fas fa-user-tie me-1"></i> Matrizador</h6>
                <p class="mb-1"><strong>{{#if documento.matrizador}}{{documento.matrizador.nombre}}{{else}}Sin asignar{{/if}}</strong></p>
                <p class="text-muted mb-0"><small>Responsable</small></p>
              </div>
              <div class="col-md-3">
                <h6><i class="fas fa-dollar-sign me-1"></i> Valor</h6>
                <p class="mb-1"><strong>${{formatMoney documento.valorFactura}}</strong></p>
                <p class="text-muted mb-0"><small>{{#if documento.numeroFactura}}Fact: {{documento.numeroFactura}}{{else}}Sin factura{{/if}}</small></p>
              </div>
              <div class="col-md-3">
                <h6><i class="fas fa-credit-card me-1"></i> Estado Pago</h6>
                <span class="badge {{estadoPagoClass documento.estadoPago}} fs-6">
                  {{estadoPagoTexto documento.estadoPago}}
                </span>
              </div>
            </div>
          </div>
        </div>

        {{!-- ============== 2. DOCUMENTOS ADICIONALES DETECTADOS ============== --}}
        {{#if documentosGrupales.tieneDocumentosAdicionales}}
          <div class="alert alert-info" id="alerta-entrega-grupal">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6><i class="fas fa-boxes me-2"></i>Documentos Adicionales Detectados</h6>
                <p class="mb-2">
                  Se encontraron <strong>{{documentosGrupales.cantidad}} documento(s) adicional(es)</strong> 
                  del mismo cliente listos para entrega.
                </p>
                <p class="mb-0 text-info">
                  <i class="fas fa-shield-alt me-1"></i>
                  <strong>Acceso Recepción:</strong> Puede entregar TODOS los documentos sin restricciones
                </p>
                
                {{!-- ============== NUEVA SECCIÓN: ALERTAS DE DOCUMENTOS PENDIENTES ============== --}}
                {{#if documentosGrupales.requiereAutorizacion}}
                  <div class="alert alert-warning mt-3" id="alerta-documentos-pendientes">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Documentos con Pago Pendiente Detectados</h6>
                    <p class="mb-2">
                      <strong>{{documentosGrupales.documentosPendientes.length}} documento(s)</strong> tienen pago pendiente.
                      Debe confirmar que ha consultado con el matrizador responsable.
                    </p>
                    <div class="mt-2">
                      {{#each documentosGrupales.alertas}}
                        <div class="alert alert-light border-warning p-2 mb-2">
                          <div class="d-flex justify-content-between align-items-center">
                            <div>
                              <strong>{{this.codigo}}</strong> - {{this.tipoDocumento}}
                              <br><small class="text-muted">Valor: ${{formatMoney this.valor}} - Estado: {{this.estadoPago}}</small>
                            </div>
                            <div class="text-end">
                              <small><strong>Matrizador:</strong><br>{{this.matrizador}}</small>
                            </div>
                          </div>
                        </div>
                      {{/each}}
                    </div>
                  </div>
                {{/if}}
              </div>
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="ocultarEntregaGrupal()">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>

          {{!-- ============== NUEVA ESTRUCTURA JERÁRQUICA DE DOCUMENTOS ============== --}}
          <div class="card mb-4" id="seccion-entrega-grupal">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                  <i class="fas fa-sitemap me-2"></i>
                  Documentos Estructurados para Entrega
                </h6>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="selectAll">
                  <label class="form-check-label" for="selectAll">
                    <strong>Seleccionar todos</strong>
                  </label>
                </div>
              </div>
            </div>
            <div class="card-body">
              {{!-- Encabezado con nombre del cliente --}}
              <div class="alert alert-info border-info mb-3">
                <div class="d-flex align-items-center">
                  <i class="fas fa-user me-3 fs-4"></i>
                  <div>
                    <h6 class="mb-1">📄 <strong>DOCUMENTOS PARA:</strong></h6>
                    <h5 class="mb-0 text-info"><strong>{{documento.nombreCliente}}</strong></h5>
                    <small class="text-muted">ID: {{documento.identificacionCliente}}</small>
                  </div>
                </div>
              </div>

              {{!-- Resumen de estructura --}}
              {{#if (or documentosGrupales.tieneGruposRelacionados documentosGrupales.tieneDocumentosIndependientes)}}
                <div class="resumen-estructura">
                  <div class="estadisticas">
                    <div class="estadistica">
                      <div class="numero">{{documentosGrupales.gruposRelacionados.length}}</div>
                      <div class="etiqueta">Grupos Relacionados</div>
                    </div>
                    <div class="estadistica">
                      <div class="numero">{{documentosGrupales.documentosIndependientes.length}}</div>
                      <div class="etiqueta">Documentos Independientes</div>
                    </div>
                    <div class="estadistica">
                      <div class="numero">{{documentosGrupales.cantidad}}</div>
                      <div class="etiqueta">Total Documentos</div>
                    </div>
                  </div>
                </div>
              {{/if}}

              <div class="documentos-estructurados">
                {{!-- ============== GRUPOS RELACIONADOS ============== --}}
                {{#if documentosGrupales.tieneGruposRelacionados}}
                  <div class="grupos-relacionados">
                    <h5>DOCUMENTOS RELACIONADOS (deben entregarse juntos)</h5>
                    
                    {{#each documentosGrupales.gruposRelacionados}}
                      <div class="grupo-documentos" data-grupo-id="{{@index}}">
                        {{!-- Documento Principal --}}
                        <div class="documento-principal">
                          <div class="checkbox-grupo">
                            <input 
                              class="form-check-input documento-checkbox grupo-checkbox" 
                              type="checkbox" 
                              value="{{this.principal.id}}"
                              data-codigo="{{this.principal.codigoVerificacion}}"
                              data-es-grupo="true"
                              data-grupo-id="{{@index}}"
                              id="grupo_{{@index}}_principal">
                          </div>
                          
                          <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                              <div class="codigo-principal">{{this.principal.codigoBarras}}</div>
                              <div class="mt-2">
                                <span class="tipo-principal">{{this.principal.tipoDocumento}}</span>
                                <span class="badge-principal ms-2">PRINCIPAL</span>
                              </div>
                              <div class="mt-2 small text-muted">
                                <i class="fas fa-user-tie me-1"></i>
                                {{#if this.principal.matrizador}}{{this.principal.matrizador.nombre}}{{else}}Sin asignar{{/if}}
                              </div>
                            </div>
                            <div class="text-end">
                              <div class="fw-bold">${{formatMoney this.principal.valorFactura}}</div>
                              <span class="badge {{estadoPagoClass this.principal.estadoPago}}">
                                {{estadoPagoTexto this.principal.estadoPago}}
                              </span>
                            </div>
                          </div>
                        </div>

                        {{!-- Documentos Habilitantes --}}
                        {{#if this.habilitantes.length}}
                          <div class="documentos-habilitantes">
                            {{#each this.habilitantes}}
                              <div class="documento-habilitante">
                                <div class="d-flex justify-content-between align-items-start">
                                  <div class="flex-grow-1">
                                    <div class="codigo-habilitante">{{this.codigoBarras}}</div>
                                    <div class="mt-1">
                                      <span class="tipo-habilitante">{{this.tipoDocumento}}</span>
                                    </div>
                                    <div class="relacion-info">
                                      Se entrega con: {{this.principalCodigo}}
                                    </div>
                                  </div>
                                  <div class="text-end small">
                                    <div class="fw-bold">${{formatMoney this.valorFactura}}</div>
                                    <span class="badge {{estadoPagoClass this.estadoPago}} small">
                                      {{estadoPagoTexto this.estadoPago}}
                                    </span>
                                  </div>
                                </div>
                              </div>
                            {{/each}}
                          </div>
                        {{/if}}

                        {{!-- Advertencia del grupo --}}
                        <div class="advertencia-grupo">
                          Estos {{this.totalDocumentos}} documentos DEBEN entregarse juntos
                        </div>

                        {{!-- Información del grupo --}}
                        <div class="info-grupo">
                          Valor total del grupo: ${{formatMoney this.valorTotalGrupo}} | 
                          Códigos: {{join this.codigosGrupo ", "}}
                        </div>
                      </div>
                    {{/each}}
                  </div>
                {{/if}}

                {{!-- ============== DOCUMENTOS INDEPENDIENTES ============== --}}
                {{#if documentosGrupales.tieneDocumentosIndependientes}}
                  <div class="documentos-independientes">
                    <h5>DOCUMENTOS INDEPENDIENTES</h5>
                    
                    {{#each documentosGrupales.documentosIndependientes}}
                      <div class="documento-individual {{#if this.esHabilitanteHuerfano}}habilitante-huerfano{{/if}}">
                        <div class="checkbox-individual">
                          <input 
                            class="form-check-input documento-checkbox individual-checkbox" 
                            type="checkbox" 
                            value="{{this.id}}"
                            data-codigo="{{this.codigoVerificacion}}"
                            data-es-individual="true"
                            id="individual_{{this.id}}">
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-start">
                          <div class="flex-grow-1" style="margin-left: 35px;">
                            <div class="codigo-individual">{{this.codigoBarras}}</div>
                            <div class="mt-2">
                              <span class="tipo-individual">{{this.tipoDocumento}}</span>
                            </div>
                            <div class="mt-2 small text-muted">
                              <i class="fas fa-user-tie me-1"></i>
                              {{#if this.matrizador}}{{this.matrizador.nombre}}{{else}}Sin asignar{{/if}}
                            </div>
                            {{#unless this.esHabilitanteHuerfano}}
                              <div class="entrega-individual-permitida">
                                Entrega individual permitida
                              </div>
                            {{/unless}}
                            {{#if this.advertencia}}
                              <div class="text-warning small mt-1">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                {{this.advertencia}}
                              </div>
                            {{/if}}
                          </div>
                          <div class="text-end">
                            <div class="fw-bold">${{formatMoney this.valorFactura}}</div>
                            <span class="badge {{estadoPagoClass this.estadoPago}}">
                              {{estadoPagoTexto this.estadoPago}}
                            </span>
                          </div>
                        </div>
                      </div>
                    {{/each}}
                  </div>
                {{/if}}
              </div>

              {{!-- Contador de selección mejorado --}}
              <div class="mt-3">
                <div class="alert alert-light border">
                  <div class="d-flex justify-content-between align-items-center">
                    <span>
                      <i class="fas fa-info-circle me-2 text-info"></i>
                      <span id="contador-seleccion">1 documento(s) seleccionado(s)</span>
                    </span>
                    <div id="codigos-seleccionados" class="small text-muted"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {{/if}}

        {{!-- ============== 3. FORMULARIO DE ENTREGA CORREGIDO ============== --}}
        <form id="formEntrega" action="/recepcion/documentos/entrega/{{documento.id}}" method="POST">
          {{!-- Campos ocultos para entrega grupal --}}
          <input type="hidden" id="documentos_seleccionados" name="documentosAdicionales" value="">
          <input type="hidden" id="entrega_grupal" name="entregaGrupal" value="false">
          <input type="hidden" name="tipoEntregaGrupal" value="recepcion_completa">

          {{!-- SECCIÓN: VALIDACIÓN DE CÓDIGO CORREGIDA --}}
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-key me-2"></i>
                Validación de Código
              </h6>
            </div>
            <div class="card-body">
              {{!-- Mostrar códigos válidos dinámicamente --}}
              <div class="alert alert-info" id="alert-codigos-validos">
                <strong>Códigos válidos para esta entrega:</strong>
                <div id="lista-codigos-validos">
                  {{#if documento.codigoVerificacion}}
                    {{#unless (eq documento.codigoVerificacion 'sin_codigo')}}
                      <code class="bg-dark text-light px-2 py-1 rounded me-2">{{documento.codigoVerificacion}}</code>
                      <small class="text-muted">(documento principal)</small>
                    {{/unless}}
                  {{/if}}
                </div>
              </div>

              {{!-- Input de código con validación mejorada --}}
              <div class="row">
                <div class="col-md-6">
                  <label for="codigoVerificacion" class="form-label">
                    <strong>Código de Verificación</strong>
                    <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="codigoVerificacion" name="codigoVerificacion" 
                           placeholder="Ingrese código de 4 dígitos" maxlength="6" required>
                    <button type="button" class="btn btn-outline-primary" id="validarCodigo">
                      <i class="fas fa-check me-1"></i>Validar
                    </button>
                  </div>
                  <div id="mensaje-validacion-codigo" class="mt-2"></div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Método de verificación alternativo</label>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="tipoVerificacion" value="llamada" id="verificacionLlamada">
                    <label class="form-check-label" for="verificacionLlamada">
                      Verificación por llamada telefónica
                    </label>
                  </div>
                  <div id="div-observaciones" class="mt-2 d-none">
                    <textarea class="form-control" id="observaciones" name="observaciones" rows="2" 
                              placeholder="Detalles de la verificación por llamada..."></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {{!-- SECCIÓN: INFORMACIÓN DEL RECEPTOR --}}
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-user-check me-2"></i>
                Información del Receptor
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="nombreReceptor" class="form-label">
                    <strong>Nombre completo del receptor</strong>
                    <span class="text-danger">*</span>
                  </label>
                  <input type="text" class="form-control" id="nombreReceptor" name="nombreReceptor" 
                         placeholder="Nombre completo de quien recibe" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="identificacionReceptor" class="form-label">
                    <strong>Identificación del receptor</strong>
                    <span class="text-danger">*</span>
                  </label>
                  <input type="text" class="form-control" id="identificacionReceptor" name="identificacionReceptor" 
                         placeholder="Cédula o identificación" required>
                </div>
              </div>
              <div class="mb-3">
                <label for="relacionReceptor" class="form-label">
                  <strong>Relación con el cliente</strong>
                  <span class="text-danger">*</span>
                </label>
                <select class="form-select" id="relacionReceptor" name="relacionReceptor" required>
                  <option value="">Seleccione la relación</option>
                  <option value="titular">Titular del documento</option>
                  <option value="representante_legal">Representante legal</option>
                  <option value="apoderado">Apoderado</option>
                  <option value="familiar">Familiar autorizado</option>
                  <option value="empleado">Empleado autorizado</option>
                  <option value="tercero_autorizado">Tercero autorizado</option>
                </select>
              </div>
            </div>
          </div>

          {{!-- ============== NUEVA SECCIÓN: AUTORIZACIÓN PARA DOCUMENTOS PENDIENTES ============== --}}
          {{#if documentosGrupales.requiereAutorizacion}}
            <div class="card mb-4 border-warning" id="seccion-autorizacion">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  Autorización Requerida
                </h6>
              </div>
              <div class="card-body">
                <div class="alert alert-warning">
                  <p class="mb-3">
                    <strong>Se detectaron documentos con pago pendiente.</strong> 
                    Para proceder con la entrega, debe confirmar que ha consultado con el matrizador responsable.
                  </p>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="confirmarEntregaPendiente" name="confirmarEntregaPendiente" value="true" required>
                    <label class="form-check-label" for="confirmarEntregaPendiente">
                      <strong>Confirmo que he consultado con el matrizador responsable y autorizo la entrega de documentos con pago pendiente</strong>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          {{/if}}

          {{!-- BOTÓN DE CONFIRMACIÓN --}}
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-info btn-lg" id="btnConfirmarEntrega">
              <i class="fas fa-check-circle me-2"></i>
              Confirmar Entrega
            </button>
          </div>
        </form>

      {{else}}
        {{!-- ============== BÚSQUEDA Y LISTADO DE DOCUMENTOS ============== --}}
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-search me-2"></i>
              Buscar Documento para Entrega
            </h5>
          </div>
          <div class="card-body">
            <form action="/recepcion/documentos/entrega" method="GET">
              <div class="input-group mb-3">
                <input type="text" class="form-control form-control-lg" name="codigo" 
                       placeholder="Escanee o ingrese el código de barras del documento" 
                       value="{{filtros.codigo}}" autofocus>
                <button class="btn btn-primary btn-lg" type="submit">
                  <i class="fas fa-search me-1"></i>Buscar
                </button>
              </div>
            </form>
          </div>
        </div>

        {{!-- LISTA DE DOCUMENTOS LISTOS CON ESTADO DE PAGO VISIBLE --}}
        {{#if documentosListos.length}}
          <div class="card mt-4">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-list me-2"></i>
                Documentos Listos para Entrega ({{documentosListos.length}})
              </h6>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Código</th>
                      <th>Cliente</th>
                      <th>Tipo</th>
                      <th>Matrizador</th>
                      <th>Valor</th>
                      <th>Estado Pago</th>
                      <th>Fecha</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    {{#each documentosListos}}
                      <tr>
                        <td>
                          <strong>{{this.codigoBarras}}</strong>
                        </td>
                        <td>
                          <div>
                            <strong>{{this.nombreCliente}}</strong>
                            <br><small class="text-muted">{{this.identificacionCliente}}</small>
                          </div>
                        </td>
                        <td>
                          <span class="badge bg-secondary">{{this.tipoDocumento}}</span>
                        </td>
                        <td>
                          <span class="badge bg-info">{{#if this.matrizador}}{{this.matrizador.nombre}}{{else}}Sin asignar{{/if}}</span>
                        </td>
                        <td>
                          <strong>${{formatMoney this.valorFactura}}</strong>
                        </td>
                        <td>
                          <span class="badge {{estadoPagoClass this.estadoPago}}">
                            {{estadoPagoTexto this.estadoPago}}
                          </span>
                        </td>
                        <td>
                          <small>{{formatDate this.created_at}}</small>
                        </td>
                        <td>
                          <a href="/recepcion/documentos/entrega/{{this.id}}" class="btn btn-sm btn-primary">
                            <i class="fas fa-handshake me-1"></i>Entregar
                          </a>
                        </td>
                      </tr>
                    {{/each}}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        {{/if}}
      {{/if}}
    </div>
  </div>
</div>

{{!-- ============== JAVASCRIPT MEJORADO PARA ENTREGA GRUPAL JERÁRQUICA ============== --}}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Configuración global
  window.documentoPrincipal = {{{json documento}}};
  window.documentosDisponibles = {{{json documentosGrupales.documentos}}};
  window.gruposRelacionados = {{{json documentosGrupales.gruposRelacionados}}};
  window.documentosIndependientes = {{{json documentosGrupales.documentosIndependientes}}};
  window.usuarioActual = { rol: 'recepcion' };
  
  // Variables del DOM
  const selectAll = document.getElementById('selectAll');
  const documentoCheckboxes = document.querySelectorAll('.documento-checkbox');
  const contadorSeleccion = document.getElementById('contador-seleccion');
  const codigoInput = document.getElementById('codigoVerificacion');
  const btnValidar = document.getElementById('validarCodigo');
  const listaCodigosValidos = document.getElementById('lista-codigos-validos');
  const verificacionLlamada = document.getElementById('verificacionLlamada');
  const divObservaciones = document.getElementById('div-observaciones');
  const btnConfirmar = document.getElementById('btnConfirmarEntrega');
  
  // ============== GESTIÓN DE SELECCIÓN JERÁRQUICA ==============
  
  function actualizarSeleccion() {
    const seleccionados = Array.from(documentoCheckboxes).filter(cb => cb.checked);
    const totalSeleccionados = seleccionados.length + 1; // +1 por documento principal
    
    // Actualizar contador
    if (contadorSeleccion) {
      contadorSeleccion.textContent = `${totalSeleccionados} documento(s) seleccionado(s)`;
    }
    
    // Actualizar códigos válidos
    actualizarCodigosValidos(seleccionados);
    
    // Actualizar campos ocultos
    const idsSeleccionados = seleccionados.map(cb => cb.value);
    document.getElementById('documentos_seleccionados').value = idsSeleccionados.join(',');
    document.getElementById('entrega_grupal').value = idsSeleccionados.length > 0 ? 'true' : 'false';
    
    // Aplicar estilos visuales
    aplicarEstilosSeleccion(seleccionados);
  }
  
  function actualizarCodigosValidos(seleccionados) {
    if (!listaCodigosValidos) return;
    
    let codigosHTML = '';
    
    // Código del documento principal
    if (window.documentoPrincipal && window.documentoPrincipal.codigoVerificacion && 
        window.documentoPrincipal.codigoVerificacion !== 'sin_codigo') {
      codigosHTML += `<code class="bg-dark text-light px-2 py-1 rounded me-2">${window.documentoPrincipal.codigoVerificacion}</code>`;
      codigosHTML += `<small class="text-muted me-3">(documento principal)</small>`;
    }
    
    // Códigos de documentos seleccionados
    seleccionados.forEach(checkbox => {
      const codigo = checkbox.dataset.codigo;
      if (codigo && codigo !== 'sin_codigo') {
        codigosHTML += `<code class="bg-info text-light px-2 py-1 rounded me-2">${codigo}</code>`;
        codigosHTML += `<small class="text-muted me-3">(seleccionado)</small>`;
      }
    });
    
    if (codigosHTML === '') {
      codigosHTML = '<span class="text-warning">⚠️ Documentos sin código - usar verificación alternativa</span>';
    }
    
    listaCodigosValidos.innerHTML = codigosHTML;
  }
  
  function aplicarEstilosSeleccion(seleccionados) {
    // Remover estilos previos
    document.querySelectorAll('.grupo-seleccionado, .individual-seleccionado').forEach(el => {
      el.classList.remove('grupo-seleccionado', 'individual-seleccionado');
    });
    
    // Aplicar estilos a elementos seleccionados
    seleccionados.forEach(checkbox => {
      const esGrupo = checkbox.dataset.esGrupo === 'true';
      const esIndividual = checkbox.dataset.esIndividual === 'true';
      
      if (esGrupo) {
        const grupoElement = checkbox.closest('.grupo-documentos');
        if (grupoElement) {
          grupoElement.classList.add('grupo-seleccionado');
        }
      } else if (esIndividual) {
        const individualElement = checkbox.closest('.documento-individual');
        if (individualElement) {
          individualElement.classList.add('individual-seleccionado');
        }
      }
    });
  }
  
  // ============== EVENT LISTENERS ==============
  
  // Seleccionar todos
  if (selectAll) {
    selectAll.addEventListener('change', function() {
      documentoCheckboxes.forEach(cb => {
        cb.checked = this.checked;
      });
      actualizarSeleccion();
    });
  }
  
  // Checkboxes individuales
  documentoCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      // Si es un grupo, seleccionar todos los documentos del grupo
      if (this.dataset.esGrupo === 'true') {
        const grupoId = this.dataset.grupoId;
        const grupo = window.gruposRelacionados[grupoId];
        
        if (grupo && this.checked) {
          // Agregar habilitantes a la selección (simulado)
          console.log(`Grupo ${grupoId} seleccionado: incluye ${grupo.totalDocumentos} documentos`);
        }
      }
      
      actualizarSeleccion();
    });
  });
  
  // Validación de código
  if (btnValidar) {
    btnValidar.addEventListener('click', function() {
      const codigo = codigoInput.value.trim();
      const mensajeDiv = document.getElementById('mensaje-validacion-codigo');
      
      if (!codigo) {
        mostrarMensajeValidacion('Debe ingresar un código de verificación', 'error');
        return;
      }
      
      // Obtener códigos válidos
      const codigosValidos = obtenerCodigosValidos();
      
      if (codigosValidos.includes(codigo)) {
        mostrarMensajeValidacion('✅ Código válido. Puede proceder con la entrega', 'success');
      } else {
        mostrarMensajeValidacion('❌ Código incorrecto. Use cualquier código de los documentos seleccionados', 'error');
      }
    });
  }
  
  function obtenerCodigosValidos() {
    const codigos = [];
    
    // Código del documento principal
    if (window.documentoPrincipal && window.documentoPrincipal.codigoVerificacion && 
        window.documentoPrincipal.codigoVerificacion !== 'sin_codigo') {
      codigos.push(window.documentoPrincipal.codigoVerificacion);
    }
    
    // Códigos de documentos seleccionados
    const seleccionados = Array.from(documentoCheckboxes).filter(cb => cb.checked);
    seleccionados.forEach(checkbox => {
      const codigo = checkbox.dataset.codigo;
      if (codigo && codigo !== 'sin_codigo') {
        codigos.push(codigo);
      }
    });
    
    return codigos;
  }
  
  function mostrarMensajeValidacion(mensaje, tipo) {
    const mensajeDiv = document.getElementById('mensaje-validacion-codigo');
    if (!mensajeDiv) return;
    
    const claseColor = tipo === 'success' ? 'text-success' : 'text-danger';
    mensajeDiv.innerHTML = `<div class="${claseColor}">${mensaje}</div>`;
  }
  
  // Verificación por llamada
  if (verificacionLlamada) {
    verificacionLlamada.addEventListener('change', function() {
      if (divObservaciones) {
        divObservaciones.classList.toggle('d-none', !this.checked);
      }
    });
  }
  
  // Validación del formulario
  if (btnConfirmar) {
    document.getElementById('formEntrega').addEventListener('submit', function(e) {
      // ============== NUEVA VALIDACIÓN: AUTORIZACIÓN PARA DOCUMENTOS PENDIENTES ==============
      const checkboxAutorizacion = document.getElementById('confirmarEntregaPendiente');
      if (checkboxAutorizacion && !checkboxAutorizacion.checked) {
        e.preventDefault();
        alert('Debe confirmar que ha consultado con el matrizador responsable para proceder con la entrega de documentos con pago pendiente.');
        checkboxAutorizacion.focus();
        return false;
      }
      
      const entregaGrupal = document.getElementById('entrega_grupal').value === 'true';
      const numDocumentos = entregaGrupal ? 
        document.getElementById('documentos_seleccionados').value.split(',').length + 1 : 1;
      
      if (entregaGrupal) {
        btnConfirmar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Procesando entrega grupal (${numDocumentos} documentos)...`;
      } else {
        btnConfirmar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Procesando entrega...`;
      }
      
      btnConfirmar.disabled = true;
    });
  }
  
  // Inicializar selección
  actualizarSeleccion();
  
  // Funciones específicas para recepción
  window.ocultarEntregaGrupal = function() {
    document.getElementById('alerta-entrega-grupal').style.display = 'none';
    document.getElementById('seccion-entrega-grupal').style.display = 'none';
  };
});
</script> 