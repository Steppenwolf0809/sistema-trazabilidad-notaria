<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>üëÅÔ∏è Control de Notificaciones</h2>
                    <p class="text-muted mb-0">Busque por c√≥digo de documento, nombre de cliente o n√∫mero de factura</p>
                </div>
                <span class="badge bg-info fs-6">{{notificaciones.length}} notificaciones</span>
            </div>
            
            <style>
                .bg-purple {
                    background-color: #6f42c1 !important;
                    color: white;
                }
            </style>

            {{!-- Filtros avanzados para recepci√≥n --}}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">üîç Filtros de Control</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="/recepcion/notificaciones/historial">
                        <div class="row mb-3">
                            <div class="col-md-2">
                                <label class="form-label">üìÖ Desde:</label>
                                <input type="date" class="form-control" name="fechaDesde" value="{{filtros.fechaDesde}}">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">üìÖ Hasta:</label>
                                <input type="date" class="form-control" name="fechaHasta" value="{{filtros.fechaHasta}}">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">üì± Tipo:</label>
                                <select class="form-control" name="tipo">
                                    <option value="">Todos</option>
                                    <option value="documento_listo" {{#if (eq filtros.tipo 'documento_listo')}}selected{{/if}}>üìã Listo</option>
                                    <option value="entrega_confirmada" {{#if (eq filtros.tipo 'entrega_confirmada')}}selected{{/if}}>‚úÖ Entregado</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">üìß Canal:</label>
                                <select class="form-control" name="canal">
                                    <option value="">Todos</option>
                                    <option value="whatsapp" {{#if (eq filtros.canal 'whatsapp')}}selected{{/if}}>WhatsApp</option>
                                    <option value="email" {{#if (eq filtros.canal 'email')}}selected{{/if}}>Email</option>
                                    <option value="ambos" {{#if (eq filtros.canal 'ambos')}}selected{{/if}}>Ambos</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">üë®‚Äçüíº Matrizador:</label>
                                <select class="form-control" name="matrizador">
                                    <option value="">Todos</option>
                                    {{#each matrizadores}}
                                    <option value="{{this.id}}" {{#if (eq ../filtros.matrizador this.id)}}selected{{/if}}>
                                        {{this.nombre}}
                                    </option>
                                    {{/each}}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">üîç Filtrar</button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <h6 class="text-muted mb-2">üîç B√∫squeda R√°pida:</h6>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">üìÑ C√≥digo Documento:</label>
                                <input type="text" class="form-control" name="codigoDocumento" 
                                       value="{{filtros.codigoDocumento}}" placeholder="Ej: 20251701018P01150">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">üë§ Nombre Cliente:</label>
                                <input type="text" class="form-control" name="cliente" 
                                       value="{{filtros.cliente}}" placeholder="Nombre completo o parcial">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">üßæ N√∫mero Factura:</label>
                                <input type="text" class="form-control" name="numeroFactura" 
                                       value="{{filtros.numeroFactura}}" placeholder="Ej: 001-002-000118113">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary flex-fill">üîç Buscar</button>
                                    <a href="/recepcion/notificaciones/historial" class="btn btn-outline-secondary flex-fill">
                                        üîÑ Limpiar
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-success" onclick="exportarCSV()">
                                        üìä Exportar CSV
                                    </button>
                                    <button type="button" class="btn btn-info" onclick="busquedaAvanzada()">
                                        ‚öôÔ∏è B√∫squeda Avanzada
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            {{!-- Estad√≠sticas r√°pidas --}}
            {{#if stats}}
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h3>{{stats.total}}</h3>
                            <p class="mb-0">üìä Total</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h3>{{stats.enviadas}}</h3>
                            <p class="mb-0">‚úÖ Enviadas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center">
                            <h3>{{stats.fallidas}}</h3>
                            <p class="mb-0">‚ùå Fallidas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h3>{{stats.pendientes}}</h3>
                            <p class="mb-0">‚è≥ Pendientes</p>
                        </div>
                    </div>
                </div>
            </div>
            {{/if}}

            {{!-- Tabla de control de notificaciones --}}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìã Historial Completo de Notificaciones</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>üìÖ Fecha/Hora</th>
                                    <th>üìÑ Documento</th>
                                    <th>üë§ Cliente</th>
                                    <th>üë®‚Äçüíº Matrizador</th>
                                    <th>üì± Tipo</th>
                                    <th>üìß Canal</th>
                                    <th>üì± Destinatario</th>
                                    <th>‚úÖ Estado</th>
                                    <th>üîç Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each notificaciones}}
                                <tr>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <span class="fw-bold fecha-evento" data-fecha="{{this.created_at}}">
                                                Cargando...
                                            </span>
                                            <small class="text-muted hora-evento" data-fecha="{{this.created_at}}">
                                                -
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        {{#if (or (eq this.tipo 'entrega_grupal') (eq this.tipo 'notificacion_grupal'))}}
                                            {{!-- Para entrega grupal, mostrar resumen de documentos --}}
                                            <div class="d-flex flex-column">
                                                <span class="fw-bold text-success">üì¶ ENTREGA GRUPAL</span>
                                                {{#if this.metadatos.totalDocumentos}}
                                                    <small class="text-info">{{this.metadatos.totalDocumentos}} documentos entregados</small>
                                                {{/if}}
                                                {{#if this.metadatos.codigosDocumentos}}
                                                    <div class="mt-1">
                                                        {{#each this.metadatos.codigosDocumentos}}
                                                            {{#if (lt @index 3)}}
                                                                <small class="badge bg-light text-dark me-1">{{this}}</small>
                                                            {{/if}}
                                                        {{/each}}
                                                        {{#if (gt this.metadatos.codigosDocumentos.length 3)}}
                                                            <small class="text-muted">+{{subtract this.metadatos.codigosDocumentos.length 3}} m√°s</small>
                                                        {{/if}}
                                                    </div>
                                                {{/if}}
                                            </div>
                                        {{else}}
                                            {{!-- Para notificaciones individuales --}}
                                            <div class="d-flex flex-column">
                                                <span class="fw-bold text-primary">{{this.documento.codigoBarras}}</span>
                                                <small class="text-muted">{{this.documento.tipoDocumento}}</small>
                                                {{#if this.documento.numeroFactura}}
                                                <small class="text-info">üßæ {{this.documento.numeroFactura}}</small>
                                                {{/if}}
                                                <small class="badge bg-{{#if (eq this.documento.estado 'entregado')}}success{{else if (eq this.documento.estado 'listo_para_entrega')}}warning{{else}}secondary{{/if}}">
                                                    {{this.documento.estado}}
                                                </small>
                                            </div>
                                        {{/if}}
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            {{#if (or (eq this.tipo 'entrega_grupal') (eq this.tipo 'notificacion_grupal'))}}
                                                {{!-- Para entrega grupal, mostrar informaci√≥n del receptor --}}
                                                <div class="d-flex flex-column">
                                                    {{#if this.metadatos.nombreReceptor}}
                                                        <small class="fw-bold">üë§ {{this.metadatos.nombreReceptor}}</small>
                                                    {{/if}}
                                                    {{#if this.metadatos.identificacionReceptor}}
                                                        <small class="text-muted">üÜî {{this.metadatos.identificacionReceptor}}</small>
                                                    {{/if}}
                                                    {{#if this.metadatos.relacionReceptor}}
                                                        <small class="text-info">üîó {{this.metadatos.relacionReceptor}}</small>
                                                    {{/if}}
                                                    {{!-- Mostrar canales de contacto del cliente --}}
                                                    {{#if this.documento.emailCliente}}
                                                    <small class="text-muted">üìß {{substring this.documento.emailCliente 0 15}}{{#if (gt this.documento.emailCliente.length 15)}}...{{/if}}</small>
                                                    {{/if}}
                                                    {{#if this.documento.telefonoCliente}}
                                                    <small class="text-muted">üì± {{this.documento.telefonoCliente}}</small>
                                                    {{/if}}
                                                </div>
                                            {{else}}
                                                {{!-- Para notificaciones individuales --}}
                                                <span class="fw-bold">{{this.documento.nombreCliente}}</span>
                                                {{#if this.documento.emailCliente}}
                                                <small class="text-muted">üìß {{substring this.documento.emailCliente 0 20}}{{#if (gt this.documento.emailCliente.length 20)}}...{{/if}}</small>
                                                {{/if}}
                                                {{#if this.documento.telefonoCliente}}
                                                <small class="text-muted">üì± {{this.documento.telefonoCliente}}</small>
                                                {{/if}}
                                            {{/if}}
                                        </div>
                                    </td>
                                    <td>
                                        {{#if (or (eq this.tipo 'entrega_grupal') (eq this.tipo 'notificacion_grupal'))}}
                                            {{!-- Para entrega grupal, mostrar matrizadores de los documentos --}}
                                            {{#if this.metadatos.documentosIncluidos}}
                                                <div class="d-flex flex-column">
                                                    {{#each this.metadatos.documentosIncluidos}}
                                                        {{#if (lt @index 3)}}
                                                            {{#if this.matrizador}}
                                                                {{#if (ne this.matrizador "Sin asignar")}}
                                                                    <small class="badge bg-info mb-1">{{this.matrizador}}</small>
                                                                {{else}}
                                                                    <small class="badge bg-secondary mb-1">üìã Sin Matrizador</small>
                                                                {{/if}}
                                                            {{else}}
                                                                <small class="badge bg-secondary mb-1">üìã Sin Matrizador</small>
                                                            {{/if}}
                                                        {{/if}}
                                                    {{/each}}
                                                    {{#if (gt this.metadatos.documentosIncluidos.length 3)}}
                                                        <small class="text-muted">+{{subtract this.metadatos.documentosIncluidos.length 3}} m√°s</small>
                                                    {{/if}}
                                                </div>
                                            {{else if this.metadatos.entregadoPor}}
                                                <span class="badge bg-warning">üë®‚Äçüíº {{this.metadatos.entregadoPor}}</span>
                                            {{else}}
                                                <span class="text-muted">-</span>
                                            {{/if}}
                                        {{else}}
                                            {{!-- Para notificaciones individuales --}}
                                            {{#if this.documento.matrizador}}
                                                <span class="badge bg-info">üë®‚Äçüíº {{this.documento.matrizador.nombre}}</span>
                                            {{else}}
                                                <span class="badge bg-secondary">üìã Sin Matrizador</span>
                                            {{/if}}
                                        {{/if}}
                                    </td>
                                    <td>
                                        {{#if (eq this.tipo 'documento_listo')}}
                                            <span class="badge bg-info">üìã Listo para Retiro</span>
                                        {{else if (eq this.tipo 'entrega_confirmada')}}
                                            <span class="badge bg-success">‚úÖ Entregado</span>
                                        {{else if (eq this.tipo 'entrega_grupal')}}
                                            <div class="d-flex flex-column">
                                                <span class="badge bg-purple mb-1">üì¶ Entrega Grupal</span>
                                                {{#if this.metadatos.totalDocumentos}}
                                                    <small class="text-muted">{{this.metadatos.totalDocumentos}} documentos</small>
                                                {{/if}}
                                            </div>
                                        {{else if (eq this.tipo 'notificacion_grupal')}}
                                            <div class="d-flex flex-column">
                                                <span class="badge bg-purple mb-1">üì¶ Entrega Grupal</span>
                                                {{#if this.metadatos.totalDocumentos}}
                                                    <small class="text-muted">{{this.metadatos.totalDocumentos}} documentos</small>
                                                {{/if}}
                                            </div>
                                        {{else}}
                                            <span class="badge bg-secondary">{{this.tipo}}</span>
                                        {{/if}}
                                    </td>
                                    <td>
                                        {{#if this.metadatos.canal}}
                                            {{#if (eq this.metadatos.canal 'whatsapp')}}
                                                <span class="badge bg-success">üì± WhatsApp</span>
                                            {{else if (eq this.metadatos.canal 'email')}}
                                                <span class="badge bg-primary">üìß Email</span>
                                            {{else if (eq this.metadatos.canal 'ambos')}}
                                                <span class="badge bg-info">üì±üìß Ambos</span>
                                            {{else}}
                                                <span class="badge bg-secondary">{{this.metadatos.canal}}</span>
                                            {{/if}}
                                        {{else}}
                                            <span class="badge bg-secondary">No especificado</span>
                                        {{/if}}
                                    </td>
                                    <td>
                                        {{#if (or (eq this.tipo 'entrega_grupal') (eq this.tipo 'notificacion_grupal'))}}
                                            {{!-- Para entrega grupal, mostrar informaci√≥n del receptor --}}
                                            <div class="d-flex flex-column">
                                                {{#if this.metadatos.nombreReceptor}}
                                                    <small class="fw-bold">üë§ {{this.metadatos.nombreReceptor}}</small>
                                                {{/if}}
                                                {{#if this.metadatos.identificacionReceptor}}
                                                    <small class="text-muted">üÜî {{this.metadatos.identificacionReceptor}}</small>
                                                {{/if}}
                                                {{#if this.metadatos.relacionReceptor}}
                                                    <small class="text-info">üîó {{this.metadatos.relacionReceptor}}</small>
                                                {{/if}}
                                            </div>
                                        {{else}}
                                            {{!-- Para notificaciones individuales --}}
                                            <div class="d-flex flex-column">
                                                {{#if this.documento.emailCliente}}
                                                <small>üìß {{substring this.documento.emailCliente 0 15}}{{#if (gt this.documento.emailCliente.length 15)}}...{{/if}}</small>
                                                {{/if}}
                                                {{#if this.documento.telefonoCliente}}
                                                <small>üì± {{this.documento.telefonoCliente}}</small>
                                                {{/if}}
                                            </div>
                                        {{/if}}
                                    </td>
                                    <td>
                                        {{#if this.metadatos.estado}}
                                            {{#if (eq this.metadatos.estado 'enviado')}}
                                                <span class="badge bg-success">‚úÖ Enviado</span>
                                            {{else if (eq this.metadatos.estado 'error')}}
                                                <span class="badge bg-danger">‚ùå Error</span>
                                            {{else if (eq this.metadatos.estado 'simulado')}}
                                                <span class="badge bg-warning">üîÑ Simulado</span>
                                            {{else}}
                                                <span class="badge bg-secondary">{{this.metadatos.estado}}</span>
                                            {{/if}}
                                        {{else}}
                                            <span class="badge bg-secondary">Sin estado</span>
                                        {{/if}}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    onclick="verDetalleNotificacion({{this.id}})">
                                                üëÅÔ∏è Detalle
                                            </button>
                                            <a href="/recepcion/documentos/detalle/{{this.documento.id}}" 
                                               class="btn btn-sm btn-outline-secondary">
                                                üìÑ Documento
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {{else}}
                                <tr>
                                    <td colspan="9" class="text-center text-muted py-4">
                                        üì≠ No se encontraron notificaciones con los filtros aplicados
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                    
                    {{#if notificaciones.length}}
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">
                            Mostrando {{notificaciones.length}} notificaciones (m√°ximo 100 resultados)
                        </small>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-info" onclick="actualizarVista()">
                                üîÑ Actualizar Vista
                            </button>
                        </div>
                    </div>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>
</div>

{{!-- Modal para detalle de notificaci√≥n --}}
<div class="modal fade" id="modalDetalleNotificacion" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üì± Detalles de Notificaci√≥n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contenidoDetalleNotificacion">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function verDetalleNotificacion(id) {
    const modal = new bootstrap.Modal(document.getElementById('modalDetalleNotificacion'));
    const contenido = document.getElementById('contenidoDetalleNotificacion');
    
    // Mostrar loading
    contenido.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    fetch(`/recepcion/notificaciones/detalle/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.exito) {
                contenido.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>üìÑ Informaci√≥n del Documento</h6>
                            <table class="table table-sm">
                                <tr><td><strong>C√≥digo:</strong></td><td>${data.datos.documento.codigo}</td></tr>
                                <tr><td><strong>Tipo:</strong></td><td>${data.datos.documento.tipo}</td></tr>
                                <tr><td><strong>Cliente:</strong></td><td>${data.datos.documento.cliente}</td></tr>
                                <tr><td><strong>Estado:</strong></td><td><span class="badge bg-info">${data.datos.documento.estado}</span></td></tr>
                                <tr><td><strong>Matrizador:</strong></td><td>${data.datos.documento.matrizador || 'No asignado'}</td></tr>
                                ${data.datos.documento.numeroFactura ? `<tr><td><strong>Factura:</strong></td><td>${data.datos.documento.numeroFactura}</td></tr>` : ''}
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>üì± Informaci√≥n de la Notificaci√≥n</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Tipo:</strong></td><td><span class="badge bg-primary">${data.datos.tipo}</span></td></tr>
                                <tr><td><strong>Canal:</strong></td><td><span class="badge bg-success">${data.datos.metadatos.canal || 'No especificado'}</span></td></tr>
                                <tr><td><strong>Estado:</strong></td><td><span class="badge bg-info">${data.datos.metadatos.estado || 'Sin estado'}</span></td></tr>
                                <tr><td><strong>Fecha:</strong></td><td>${formatearFechaModal(data.datos.fecha)}</td></tr>
                                <tr><td><strong>Usuario:</strong></td><td>${data.datos.usuario}</td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>üìû Canales de Contacto</h6>
                            <div class="alert alert-info">
                                ${data.datos.canales.email ? `üìß <strong>Email:</strong> ${data.datos.canales.email}<br>` : ''}
                                ${data.datos.canales.telefono ? `üì± <strong>Tel√©fono:</strong> ${data.datos.canales.telefono}` : ''}
                                ${!data.datos.canales.email && !data.datos.canales.telefono ? 'Sin datos de contacto' : ''}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>‚ÑπÔ∏è Detalles del Evento</h6>
                            <div class="alert alert-secondary">
                                ${data.datos.detalles || 'Sin detalles adicionales'}
                            </div>
                        </div>
                    </div>
                    ${data.datos.mensajeEnviado ? `
                    <div class="mt-3">
                        <h6>üí¨ Mensaje Enviado al Cliente</h6>
                        <div class="alert alert-success" style="white-space: pre-line; font-family: monospace; background-color: #f8f9fa; border: 1px solid #dee2e6; color: #333;">
${data.datos.mensajeEnviado}
                        </div>
                    </div>
                    ` : ''}
                `;
            } else {
                contenido.innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå Error al cargar detalles: ${data.mensaje}
                    </div>
                `;
            }
        })
        .catch(error => {
            contenido.innerHTML = `
                <div class="alert alert-danger">
                    ‚ùå Error de conexi√≥n: ${error.message}
                </div>
            `;
        });
}

function actualizarVista() {
    window.location.reload();
}

function exportarCSV() {
    const params = new URLSearchParams(window.location.search);
    params.set('formato', 'csv');
    window.open(`/recepcion/notificaciones/historial?${params.toString()}`);
}

function busquedaAvanzada() {
    // Mostrar/ocultar filtros avanzados (fechas, tipo, canal, matrizador)
    const filtrosAvanzados = document.querySelector('.row:first-child');
    if (filtrosAvanzados.style.display === 'none') {
        filtrosAvanzados.style.display = 'flex';
    } else {
        filtrosAvanzados.style.display = 'none';
    }
}

// Funci√≥n para b√∫squeda en tiempo real
function busquedaRapida() {
    const codigo = document.querySelector('input[name="codigoDocumento"]').value;
    const cliente = document.querySelector('input[name="cliente"]').value;
    const factura = document.querySelector('input[name="numeroFactura"]').value;
    
    // Si tiene al menos 3 caracteres en alg√∫n campo, realizar b√∫squeda autom√°tica
    if (codigo.length >= 3 || cliente.length >= 3 || factura.length >= 3) {
        document.querySelector('form').submit();
    }
}

// Auto-b√∫squeda mientras escribe
document.addEventListener('DOMContentLoaded', function() {
    const inputs = ['codigoDocumento', 'cliente', 'numeroFactura'];
    inputs.forEach(inputName => {
        const input = document.querySelector(`input[name="${inputName}"]`);
        if (input) {
            let timeout;
            input.addEventListener('input', function() {
                clearTimeout(timeout);
                timeout = setTimeout(busquedaRapida, 1000); // Buscar despu√©s de 1 segundo sin escribir
            });
        }
    });
});

// ============== FORMATEAR FECHAS AL CARGAR LA P√ÅGINA ==============
document.addEventListener('DOMContentLoaded', function() {
    console.log('üïí Iniciando formateo de fechas en historial de notificaciones...');
    
    // Funci√≥n para formatear fecha de manera robusta
    function formatearFechaSegura(fechaRaw) {
        if (!fechaRaw || fechaRaw === 'null' || fechaRaw === '' || fechaRaw === 'undefined') {
            return 'Sin fecha';
        }
        
        try {
            // Intentar diferentes formatos de fecha
            let fecha;
            
            // Si ya es un objeto Date
            if (fechaRaw instanceof Date) {
                fecha = fechaRaw;
            }
            // Si es un string ISO
            else if (typeof fechaRaw === 'string') {
                // Limpiar la fecha de caracteres extra√±os
                const fechaLimpia = fechaRaw.trim();
                fecha = new Date(fechaLimpia);
            }
            // Si es un timestamp
            else if (typeof fechaRaw === 'number') {
                fecha = new Date(fechaRaw);
            }
            else {
                console.warn('Formato de fecha no reconocido:', fechaRaw);
                return 'Formato inv√°lido';
            }
            
            // Verificar si la fecha es v√°lida
            if (isNaN(fecha.getTime())) {
                console.warn('Fecha inv√°lida despu√©s de conversi√≥n:', fechaRaw);
                return 'Fecha inv√°lida';
            }
            
            return fecha;
        } catch (error) {
            console.error('Error procesando fecha:', error, 'Fecha original:', fechaRaw);
            return 'Error en fecha';
        }
    }
    
    // Formatear fechas principales (fecha completa)
    document.querySelectorAll('.fecha-evento').forEach(function(elemento) {
        const fechaRaw = elemento.getAttribute('data-fecha');
        console.log('üìÖ Procesando fecha principal:', fechaRaw);
        
        const fechaFormateada = formatearFechaSegura(fechaRaw);
        
        if (fechaFormateada instanceof Date) {
            elemento.textContent = fechaFormateada.toLocaleDateString('es-EC', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            });
            elemento.classList.add('text-success');
        } else {
            elemento.textContent = fechaFormateada;
            elemento.classList.add('text-muted');
        }
    });
    
    // Formatear horas (solo hora)
    document.querySelectorAll('.hora-evento').forEach(function(elemento) {
        const fechaRaw = elemento.getAttribute('data-fecha');
        console.log('üïí Procesando hora:', fechaRaw);
        
        const fechaFormateada = formatearFechaSegura(fechaRaw);
        
        if (fechaFormateada instanceof Date) {
            elemento.textContent = fechaFormateada.toLocaleTimeString('es-EC', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        } else {
            elemento.textContent = '-';
        }
    });
    
    console.log('‚úÖ Formateo de fechas completado');
});

function formatearFechaModal(fechaRaw) {
    if (!fechaRaw || fechaRaw === 'null' || fechaRaw === '' || fechaRaw === 'undefined') {
        return 'Sin fecha';
    }
    
    try {
        // Intentar diferentes formatos de fecha
        let fecha;
        
        // Si ya es un objeto Date
        if (fechaRaw instanceof Date) {
            fecha = fechaRaw;
        }
        // Si es un string ISO
        else if (typeof fechaRaw === 'string') {
            // Limpiar la fecha de caracteres extra√±os
            const fechaLimpia = fechaRaw.trim();
            fecha = new Date(fechaLimpia);
        }
        // Si es un timestamp
        else if (typeof fechaRaw === 'number') {
            fecha = new Date(fechaRaw);
        }
        else {
            console.warn('Formato de fecha no reconocido:', fechaRaw);
            return 'Formato inv√°lido';
        }
        
        // Verificar si la fecha es v√°lida
        if (isNaN(fecha.getTime())) {
            console.warn('Fecha inv√°lida despu√©s de conversi√≥n:', fechaRaw);
            return 'Fecha inv√°lida';
        }
        
        return fecha.toLocaleString('es-EC', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
    } catch (error) {
        console.error('Error procesando fecha:', error, 'Fecha original:', fechaRaw);
        return 'Error en fecha';
    }
}
</script> 