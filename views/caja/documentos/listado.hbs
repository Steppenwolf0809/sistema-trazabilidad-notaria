<div class="card">
  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <i class="fas fa-list me-2"></i> Listado de Documentos
      </div>
      <a href="/caja/documentos/registro" class="btn btn-sm btn-primary">
        <i class="fas fa-plus-circle me-1"></i> Nuevo Documento
      </a>
    </div>
  </div>
  <div class="card-body">
    <!-- Filtros -->
    <div class="mb-4">
      <form action="/caja/documentos" method="GET" class="row g-3">
        <div class="col-md-2">
          <label for="busqueda" class="form-label">Buscar</label>
          <input type="text" class="form-control" id="busqueda" name="busqueda" value="{{filtros.busqueda}}" placeholder="Código o cliente">
        </div>
        <div class="col-md-2">
          <label for="estado" class="form-label">Estado</label>
          <select class="form-select" id="estado" name="estado">
            <option value="">Todos</option>
            <option value="en_proceso" {{#if filtros.estado.en_proceso}}selected{{/if}}>En Proceso</option>
            <option value="listo_para_entrega" {{#if filtros.estado.listo_para_entrega}}selected{{/if}}>Listo para Entrega</option>
            <option value="entregado" {{#if filtros.estado.entregado}}selected{{/if}}>Entregado</option>
            <option value="cancelado" {{#if filtros.estado.cancelado}}selected{{/if}}>Cancelado</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="estadoPago" class="form-label">Estado de Pago</label>
          <select class="form-select" id="estadoPago" name="estadoPago">
            <option value="">Todos</option>
            <option value="pendiente" {{#if (eq filtros.estadoPago "pendiente")}}selected{{/if}}>Pendiente</option>
            <option value="pagado" {{#if (eq filtros.estadoPago "pagado")}}selected{{/if}}>Pagado</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="tipoDocumento" class="form-label">Tipo</label>
          <select class="form-select" id="tipoDocumento" name="tipoDocumento">
            <option value="">Todos</option>
            {{#each tiposDocumento}}
            <option value="{{this}}" {{#if (eq ../filtros.tipoDocumento this)}}selected{{/if}}>{{this}}</option>
            {{/each}}
          </select>
        </div>
        <div class="col-md-2">
          <label for="matrizadorId" class="form-label">Matrizador</label>
          <select class="form-select" id="matrizadorId" name="matrizadorId">
            <option value="">Todos</option>
            {{#each matrizadores}}
            <option value="{{this.id}}" {{#if (eq ../filtros.matrizadorId this.id)}}selected{{/if}}>{{this.nombre}}</option>
            {{/each}}
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-search me-1"></i> Filtrar
          </button>
        </div>
      </form>
    </div>
    
    <!-- Tabla de documentos -->
    <div class="table-responsive">
      <table class="table table-hover table-striped">
        <thead class="table-light">
          <tr>
            <th>Código</th>
            <th>Tipo</th>
            <th>Cliente</th>
            <th>Estado</th>
            <th>Factura</th>
            <th>Matrizador</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {{#each documentos}}
          <tr>
            <td>
              <a href="/caja/documentos/detalle/{{this.id}}" class="text-primary fw-bold">
                {{this.codigoBarras}}
              </a>
            </td>
            <td>{{this.tipoDocumento}}</td>
            <td>{{this.nombreCliente}}</td>
            <td>
              {{#if (eq this.estado "en_proceso")}}
              <span class="badge bg-warning text-dark">En Proceso</span>
              {{else if (eq this.estado "listo_para_entrega")}}
              <span class="badge bg-info">Listo</span>
              {{else if (eq this.estado "entregado")}}
              <span class="badge bg-success">Entregado</span>
              {{else}}
              <span class="badge bg-secondary">Cancelado</span>
              {{/if}}
              
              {{#if (eq this.estadoPago "pagado")}}
              <span class="badge bg-success ms-1">Pagado</span>
              {{else}}
              <span class="badge bg-danger ms-1">Pendiente</span>
              {{/if}}
            </td>
            <td>
              {{#if this.numeroFactura}}
              {{this.numeroFactura}}
              <div class="small text-muted">${{this.valorFactura}}</div>
              {{else}}
              <span class="text-muted">Sin factura</span>
              {{/if}}
            </td>
            <td>
              {{#if this.matrizador}}
              <div class="d-flex align-items-center">
                <span>{{this.matrizador.nombre}}</span>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" 
                        data-bs-toggle="modal" data-bs-target="#cambiarMatrizadorModal" 
                        data-documento-id="{{this.id}}"
                        data-matrizador-actual-id="{{this.matrizador.id}}"
                        data-matrizador-actual-nombre="{{this.matrizador.nombre}}">
                  <i class="fas fa-edit"></i>
                </button>
              </div>
              {{else}}
              <button type="button" class="btn btn-sm btn-outline-primary" 
                      data-bs-toggle="modal" data-bs-target="#cambiarMatrizadorModal" 
                      data-documento-id="{{this.id}}">
                <i class="fas fa-user-plus me-1"></i> Asignar
              </button>
              {{/if}}
            </td>
            <td>
              <div class="btn-group">
                <a href="/caja/documentos/detalle/{{this.id}}" class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-eye"></i>
                </a>
                <a href="/caja/documentos/detalle/{{this.id}}#pago" class="btn btn-sm btn-outline-success" title="Registrar pago">
                  <i class="fas fa-money-bill-wave"></i>
                </a>
              </div>
            </td>
          </tr>
          {{else}}
          <tr>
            <td colspan="7" class="text-center py-3">No se encontraron documentos con los filtros seleccionados</td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
    
    <!-- Paginación -->
    {{#if pagination.pages.length}}
    <nav aria-label="Paginación de documentos">
      <ul class="pagination justify-content-center mt-4">
        {{#if pagination.prev}}
        <li class="page-item">
          <a class="page-link" href="{{pagination.prev}}" aria-label="Anterior">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
        {{else}}
        <li class="page-item disabled">
          <a class="page-link" href="#" aria-label="Anterior">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
        {{/if}}
        
        {{#each pagination.pages}}
        <li class="page-item {{#if this.active}}active{{/if}}">
          <a class="page-link" href="{{this.url}}">{{this.num}}</a>
        </li>
        {{/each}}
        
        {{#if pagination.next}}
        <li class="page-item">
          <a class="page-link" href="{{pagination.next}}" aria-label="Siguiente">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
        {{else}}
        <li class="page-item disabled">
          <a class="page-link" href="#" aria-label="Siguiente">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
        {{/if}}
      </ul>
    </nav>
    {{/if}}
  </div>
</div>

<!-- Modal para cambiar matrizador -->
<div class="modal fade" id="cambiarMatrizadorModal" tabindex="-1" aria-labelledby="cambiarMatrizadorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formCambiarMatrizador" action="/caja/documentos/cambiar-matrizador" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="cambiarMatrizadorModalLabel">Cambiar Matrizador</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="documentoId" name="documentoId">
          
          <div class="mb-3">
            <label for="matrizadorActual" class="form-label">Matrizador Actual</label>
            <input type="text" class="form-control bg-light" id="matrizadorActual" readonly>
          </div>
          
          <div class="mb-3">
            <label for="matrizadorId" class="form-label">Nuevo Matrizador</label>
            <select class="form-select" id="matrizadorIdModal" name="matrizadorId" required>
              <option value="" selected disabled>Seleccionar matrizador...</option>
              {{#each matrizadores}}
              <option value="{{this.id}}">{{this.nombre}}</option>
              {{/each}}
            </select>
          </div>
          
          <div class="mb-3">
            <label for="justificacion" class="form-label">Justificación</label>
            <textarea class="form-control" id="justificacion" name="justificacion" rows="3" required></textarea>
            <div class="form-text">Por favor, explique brevemente el motivo del cambio de matrizador.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Manejar el modal de cambio de matrizador
    const cambiarMatrizadorModal = document.getElementById('cambiarMatrizadorModal');
    if (cambiarMatrizadorModal) {
      cambiarMatrizadorModal.addEventListener('show.bs.modal', function (event) {
        // Botón que activó el modal
        const button = event.relatedTarget;
        // Extraer información de los atributos data-*
        const documentoId = button.getAttribute('data-documento-id');
        const matrizadorActualId = button.getAttribute('data-matrizador-actual-id');
        const matrizadorActualNombre = button.getAttribute('data-matrizador-actual-nombre');
        
        // Actualizar los campos del modal
        document.getElementById('documentoId').value = documentoId;
        
        if (matrizadorActualNombre) {
          document.getElementById('matrizadorActual').value = matrizadorActualNombre;
        } else {
          document.getElementById('matrizadorActual').value = 'Sin matrizador asignado';
        }
      });
    }
  });
</script> 