{{! Detalle de Documento - Caja - VISTA LIMPIA SIN ERRORES }}
{{#if documento}}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div>
      <i class="fas fa-file-alt me-2"></i> Detalle de Documento
    </div>
    <div>
      <a href="/caja/documentos" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </a>
    </div>
  </div>
  <div class="card-body">
    <!-- Informaci√≥n general -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="mb-3">
          <h5 class="border-bottom pb-2">Informaci√≥n General</h5>
          <p><strong>C√≥digo:</strong> <span class="badge bg-primary">{{documento.codigoBarras}}</span></p>
          <p><strong>Tipo:</strong> {{documento.tipoDocumento}}</p>
          <p><strong>Estado:</strong> 
            {{#if (eq documento.estado "en_proceso")}}
            <span class="badge bg-warning text-dark">En Proceso</span>
            {{else if (eq documento.estado "listo_para_entrega")}}
            <span class="badge bg-info">Listo para Entrega</span>
            {{else if (eq documento.estado "entregado")}}
            <span class="badge bg-success">Entregado</span>
            {{else if (eq documento.estado "nota_credito")}}
            <span class="badge bg-secondary">Nota de Cr√©dito</span>
            {{else if (eq documento.estado "eliminado")}}
            <span class="badge bg-danger">Eliminado</span>
            {{else}}
            <span class="badge bg-secondary">{{translateEstado documento.estado}}</span>
            {{/if}}
          </p>
          <p><strong>üìÖ Fecha Registro Sistema:</strong> {{formatDate documento.created_at}}</p>
          <small class="text-muted">Cu√°ndo se subi√≥ al sistema</small>
          {{#if documento.fechaFactura}}
          <p><strong>üìÑ Fecha Documento:</strong> {{formatDateDocument documento.fechaFactura}}</p>
          <small class="text-muted">Fecha original del documento (XML)</small>
          {{/if}}
          {{#if documento.fechaEntrega}}
          <p><strong>üöÄ Fecha Entrega:</strong> {{formatDate documento.fechaEntrega}}</p>
          {{/if}}
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="mb-3">
          <h5 class="border-bottom pb-2">Cliente</h5>
          <p><strong>Nombre:</strong> {{documento.nombreCliente}}</p>
          <p><strong>Identificaci√≥n:</strong> {{documento.identificacionCliente}}</p>
          {{#if documento.emailCliente}}
          <p><strong>Email:</strong> {{documento.emailCliente}}</p>
          {{/if}}
          {{#if documento.telefonoCliente}}
          <p><strong>Tel√©fono:</strong> {{documento.telefonoCliente}}</p>
          {{/if}}
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="mb-3">
          <h5 class="border-bottom pb-2">Matrizador Asignado</h5>
          {{#if documento.matrizador}}
          <p><strong>Nombre:</strong> {{documento.matrizador.nombre}}</p>
          <p><strong>Email:</strong> {{documento.matrizador.email}}</p>
          <button class="btn btn-sm btn-outline-secondary mt-2" 
                  data-bs-toggle="modal" data-bs-target="#cambiarMatrizadorModal"
                  data-documento-id="{{documento.id}}"
                  data-matrizador-actual-id="{{documento.matrizador.id}}"
                  data-matrizador-actual-nombre="{{documento.matrizador.nombre}}">
            <i class="fas fa-exchange-alt me-1"></i> Cambiar Matrizador
          </button>
          {{else}}
          <p>No hay matrizador asignado</p>
          <button class="btn btn-sm btn-primary mt-2" 
                  data-bs-toggle="modal" data-bs-target="#cambiarMatrizadorModal"
                  data-documento-id="{{documento.id}}">
            <i class="fas fa-user-plus me-1"></i> Asignar Matrizador
          </button>
          {{/if}}
        </div>
      </div>
    </div>
    
    <!-- Informaci√≥n de facturaci√≥n y pagos -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center" id="pago">
            <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Informaci√≥n de Facturaci√≥n y Pagos</h5>
            {{#if (and (neq documento.estado "eliminado") (neq documento.estado "nota_credito") (neq documento.estadoPago "pagado_completo"))}}
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#registrarPagoModal">
              <i class="fas fa-plus-circle me-1"></i> Registrar Pago
            </button>
            {{/if}}
          </div>
          <div class="card-body">
            <!-- Informaci√≥n b√°sica de facturaci√≥n -->
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="card border-primary">
                  <div class="card-header bg-primary text-white py-2">
                    <h6 class="mb-0"><i class="fas fa-file-invoice me-1"></i>Datos de Facturaci√≥n</h6>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-12 mb-2">
                        <strong>üìÑ N¬∞ Factura:</strong> 
                        <span class="badge bg-secondary">{{#if documento.numeroFactura}}{{documento.numeroFactura}}{{else}}No registrado{{/if}}</span>
                      </div>
                      <div class="col-12 mb-2">
                        <strong>üí∞ Valor Total:</strong> 
                        <span class="fs-5 text-primary">${{#if documento.valorFactura}}{{formatMoney documento.valorFactura}}{{else}}0.00{{/if}}</span>
                      </div>
                      {{#if documento.fechaFactura}}
                      <div class="col-12">
                        <strong>üìÖ Fecha Factura:</strong> {{formatDateDocument documento.fechaFactura}}
                      </div>
                      {{/if}}
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="card border-{{#if (eq documento.estadoPago "pagado_completo")}}success{{else if (eq documento.estadoPago "pagado_con_retencion")}}info{{else if (eq documento.estadoPago "pago_parcial")}}warning{{else}}danger{{/if}}">
                  <div class="card-header bg-{{#if (eq documento.estadoPago "pagado_completo")}}success{{else if (eq documento.estadoPago "pagado_con_retencion")}}info{{else if (eq documento.estadoPago "pago_parcial")}}warning{{else}}danger{{/if}} text-white py-2">
                    <h6 class="mb-0"><i class="fas fa-credit-card me-1"></i>Estado de Pago</h6>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-12 mb-2">
                        <strong>üè∑Ô∏è Estado:</strong> 
                        {{#if (eq documento.estadoPago "pagado_completo")}}
                        <span class="badge bg-success fs-6">‚úÖ Pagado Completo</span>
                        {{else if (eq documento.estadoPago "pagado_con_retencion")}}
                        <span class="badge bg-info fs-6">üßæ Pagado con Retenci√≥n</span>
                        {{else if (eq documento.estadoPago "pago_parcial")}}
                        <span class="badge bg-warning text-dark fs-6">‚ö†Ô∏è Pago Parcial</span>
                        {{else}}
                        <span class="badge bg-danger fs-6">‚ùå Pendiente</span>
                        {{/if}}
                      </div>
                      <div class="col-12 mb-2">
                        <strong>üí≥ M√©todo:</strong> 
                        <span class="badge bg-secondary">{{#if documento.metodoPago}}{{documento.metodoPago}}{{else}}No registrado{{/if}}</span>
                      </div>
                      {{#if (or (eq documento.estadoPago "pagado_completo") (eq documento.estadoPago "pagado_con_retencion") (eq documento.estadoPago "pago_parcial"))}}
                      <div class="col-12">
                        <strong>üìÖ √öltimo Pago:</strong> 
                        <span class="badge bg-success-subtle text-success-emphasis px-2 py-1">
                          {{#if documento.fechaUltimoPago}}
                          {{formatDateTime documento.fechaUltimoPago}}
                          {{else if documento.fechaPago}}
                          {{formatDateTime documento.fechaPago}}
                          {{else}}
                          No registrada
                          {{/if}}
                        </span>
                      </div>
                      {{/if}}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Desglose financiero detallado -->
            {{#if (neq documento.estadoPago "pendiente")}}
            <div class="row">
              <div class="col-12">
                <div class="card border-info">
                  <div class="card-header bg-info text-white py-2">
                    <h6 class="mb-0"><i class="fas fa-calculator me-1"></i>Desglose Financiero</h6>
                  </div>
                  <div class="card-body">
                    <div class="row text-center">
                      <div class="col-md-3">
                        <div class="border-end">
                          <div class="text-muted small">VALOR TOTAL</div>
                          <div class="fs-4 text-primary">${{#if documento.valorFactura}}{{formatMoney documento.valorFactura}}{{else}}0.00{{/if}}</div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="border-end">
                          <div class="text-muted small">PAGADO</div>
                          <div class="fs-4 text-success">${{#if documento.valorPagado}}{{formatMoney documento.valorPagado}}{{else}}0.00{{/if}}</div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="{{#if documento.tieneRetencion}}border-end{{/if}}">
                          <div class="text-muted small">PENDIENTE</div>
                          <div class="fs-4 text-danger">${{#if documento.valorPendiente}}{{formatMoney documento.valorPendiente}}{{else}}0.00{{/if}}</div>
                        </div>
                      </div>
                      {{#if documento.tieneRetencion}}
                      <div class="col-md-3">
                        <div class="text-muted small">RETENCI√ìN</div>
                        <div class="fs-4 text-warning">${{#if documento.valorRetenido}}{{formatMoney documento.valorRetenido}}{{else}}0.00{{/if}}</div>
                        {{#if documento.numeroComprobanteRetencion}}
                        <div class="small text-muted">Comp: {{documento.numeroComprobanteRetencion}}</div>
                        {{/if}}
                      </div>
                      {{/if}}
                    </div>
                    
                    <!-- Informaci√≥n del usuario que registr√≥ el pago -->
                    {{#if usuarioPago}}
                    <hr class="my-3">
                    <div class="text-center">
                      <small class="text-muted">
                        <i class="fas fa-user me-1"></i><strong>Registrado por:</strong> 
                        <span class="badge bg-info-subtle text-info-emphasis px-2 py-1">
                          {{usuarioPago.nombre}} ({{usuarioPago.rol}})
                        </span>
                      </small>
                    </div>
                    {{/if}}
                  </div>
                </div>
              </div>
            </div>
            {{/if}}
          </div>
        </div>
      </div>
    </div>
    
    <!-- Notas -->
    {{#if documento.notas}}
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Notas</h5>
          </div>
          <div class="card-body">
            <p>{{documento.notas}}</p>
          </div>
        </div>
      </div>
    </div>
    {{/if}}
    
    <!-- Comparecientes -->
    {{#if documento.comparecientes.length}}
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Comparecientes</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Identificaci√≥n</th>
                    <th>Rol</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each documento.comparecientes}}
                  <tr>
                    <td>{{this.nombre}}</td>
                    <td>{{this.identificacion}}</td>
                    <td>{{this.rol}}</td>
                  </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    {{/if}}
    
    <!-- üÜï HISTORIAL UNIVERSAL -->
    {{> historial-universal eventos=eventos}}
  </div>
</div>

<!-- Modal para cambiar matrizador -->
<div class="modal fade" id="cambiarMatrizadorModal" tabindex="-1" aria-labelledby="cambiarMatrizadorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formCambiarMatrizador" action="/caja/documentos/cambiar-matrizador" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="cambiarMatrizadorModalLabel">Cambiar Matrizador</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="documentoId" name="documentoId" value="{{documento.id}}">
          
          <div class="mb-3">
            <label for="matrizadorActual" class="form-label">Matrizador Actual</label>
            <input type="text" class="form-control bg-light" id="matrizadorActual" readonly 
                   value="{{#if documento.matrizador}}{{documento.matrizador.nombre}}{{else}}No asignado{{/if}}">
          </div>
          
          <div class="mb-3">
            <label for="matrizadorId" class="form-label">Nuevo Matrizador</label>
            <select class="form-select" id="matrizadorIdModal" name="matrizadorId" required>
              <option value="" selected disabled>Seleccionar matrizador...</option>
              {{#each matrizadores}}
              <option value="{{this.id}}">{{this.nombre}}</option>
              {{/each}}
            </select>
          </div>
          
          <div class="mb-3">
            <label for="justificacion" class="form-label">Justificaci√≥n</label>
            <textarea class="form-control" id="justificacion" name="justificacion" rows="3" required></textarea>
            <div class="form-text">Por favor, explique brevemente el motivo del cambio de matrizador.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para registrar pago (COMPLETO CON TODAS LAS FUNCIONALIDADES) -->
<div class="modal fade" id="registrarPagoModal" tabindex="-1" aria-labelledby="registrarPagoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white py-3">
        <h5 class="modal-title" id="registrarPagoModalLabel">
          <i class="fas fa-credit-card me-2"></i>üí∞ Registrar Pago
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <form id="formRegistrarPago" action="/caja/registrar-pago" method="POST" enctype="multipart/form-data">
        <div class="modal-body">
          <input type="hidden" name="documentoId" value="{{documento.id}}">
          <input type="hidden" id="xml-retencion-data" name="xmlRetencionData" value="">
          
          <!-- Informaci√≥n del documento -->
          <div class="alert alert-info mb-4">
            <div class="row">
              <div class="col-md-6">
                <h6><i class="fas fa-file-alt text-primary"></i> Informaci√≥n del Documento</h6>
                <p class="mb-1"><strong>C√≥digo:</strong> {{documento.codigoBarras}}</p>
                <p class="mb-1"><strong>Cliente:</strong> {{documento.nombreCliente}}</p>
                <p class="mb-1"><strong>Tipo:</strong> {{documento.tipoDocumento}}</p>
              </div>
              <div class="col-md-6">
                <h6><i class="fas fa-dollar-sign text-success"></i> Informaci√≥n Financiera</h6>
                <p class="mb-1"><strong>Factura:</strong> {{documento.numeroFactura}}</p>
                <p class="mb-1"><strong>Valor Total:</strong> ${{#if documento.valorFactura}}{{formatMoney documento.valorFactura}}{{else}}0.00{{/if}}</p>
                <p class="mb-1"><strong>Pendiente:</strong> <span class="text-danger">${{#if documento.valorPendiente}}{{formatMoney documento.valorPendiente}}{{else if documento.valorFactura}}{{formatMoney documento.valorFactura}}{{else}}0.00{{/if}}</span></p>
              </div>
            </div>
          </div>

          <!-- üöÄ BOTONES DE PAGO R√ÅPIDO -->
          <div class="card mb-3">
            <div class="card-header bg-success text-white py-2">
              <h6 class="mb-0">
                <i class="fas fa-bolt me-2"></i>üöÄ Botones de Pago R√°pido
              </h6>
            </div>
            <div class="card-body py-3">
              <div class="row text-center">
                <div class="col-md-4 mb-2">
                  <button type="button" class="btn btn-lg w-100 py-3 btn-outline-success" id="btn-pago-total" onclick="pagarTotalCompleto()">
                    <div class="d-flex flex-column align-items-center">
                      <i class="fas fa-money-bill-wave fa-2x text-success mb-2"></i>
                      <h6 class="text-success mb-1">üü¢ PAGO TOTAL</h6>
                      <span class="badge bg-success" id="valor-pago-total">${{#if documento.valorPendiente}}{{formatMoney documento.valorPendiente}}{{else if documento.valorFactura}}{{formatMoney documento.valorFactura}}{{else}}0.00{{/if}}</span>
                      <div class="small text-muted mt-1">Sin retenciones</div>
                    </div>
                  </button>
                </div>
                
                <div class="col-md-4 mb-2">
                  <button type="button" class="btn btn-lg w-100 py-3 btn-outline-info" id="btn-pago-retencion" onclick="pagarConRetencion()">
                    <div class="d-flex flex-column align-items-center">
                      <i class="fas fa-calculator fa-2x text-info mb-2"></i>
                      <h6 class="text-info mb-1">üîµ CON RETENCI√ìN</h6>
                      <span class="badge bg-info" id="valor-pago-retencion">~$0.00</span>
                      <div class="small text-muted mt-1">C√°lculo aproximado</div>
                    </div>
                  </button>
                </div>
                
                <div class="col-md-4 mb-2">
                  <button type="button" class="btn btn-lg w-100 py-3 btn-outline-secondary" id="btn-monto-personalizado" onclick="mostrarFormularioPersonalizado()">
                    <div class="d-flex flex-column align-items-center">
                      <i class="fas fa-edit fa-2x text-secondary mb-2"></i>
                      <h6 class="text-secondary mb-1">‚ö™ PERSONALIZADO</h6>
                      <span class="badge bg-secondary">$0.00</span>
                      <div class="small text-muted mt-1">Monto espec√≠fico</div>
                    </div>
                  </button>
                </div>
              </div>
              
              <!-- Informaci√≥n del c√°lculo con retenci√≥n -->
              <div id="info-calculo-retencion" class="alert alert-info mt-2 py-2" style="display: none;">
                <div class="row small">
                  <div class="col-md-6">
                    <p class="mb-1"><strong>Valor Total:</strong> $<span id="calc-total">0.00</span></p>
                    <p class="mb-1"><strong>Subtotal sin IVA:</strong> $<span id="calc-subtotal">0.00</span></p>
                    <p class="mb-0"><strong>IVA (15%):</strong> $<span id="calc-iva">0.00</span></p>
                  </div>
                  <div class="col-md-6">
                    <p class="mb-1"><strong>Retenci√≥n IVA (100%):</strong> -$<span id="calc-ret-iva">0.00</span></p>
                    <p class="mb-1"><strong>Retenci√≥n Renta (10%):</strong> -$<span id="calc-ret-renta">0.00</span></p>
                    <p class="mb-0"><strong>üéØ Neto Aproximado:</strong> <span class="text-success fw-bold">$<span id="calc-neto">0.00</span></span></p>
                  </div>
                </div>
                <div class="alert alert-warning mt-2 mb-0 py-1">
                  <small><i class="fas fa-exclamation-triangle me-1"></i><strong>Nota:</strong> Este es un c√°lculo aproximado. Algunos items pueden no gravar IVA, causando peque√±as diferencias.</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Formulario de pago (inicialmente oculto) -->
          <div id="formulario-pago" style="display: none;">
            
            <!-- Monto del pago -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="monto" class="form-label">
                  <i class="fas fa-money-bill-wave text-success"></i> Monto del Pago ($)
                </label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" class="form-control" id="monto" name="monto" 
                         step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-text">
                  üí° Puede ser $0.00 si solo registra retenci√≥n
                </div>
              </div>
              
              <div class="col-md-6">
                <label for="formaPago" class="form-label">
                  <i class="fas fa-credit-card text-primary"></i> Forma de Pago
                </label>
                <select class="form-select" id="formaPago" name="formaPago">
                  <option value="">Seleccionar forma de pago</option>
                  <option value="efectivo">üíµ Efectivo</option>
                  <option value="tarjeta_credito">üí≥ Tarjeta de Cr√©dito</option>
                  <option value="tarjeta_debito">üí≥ Tarjeta de D√©bito</option>
                  <option value="transferencia">üè¶ Transferencia Bancaria</option>
                  <option value="cheque">üìù Cheque</option>
                </select>
                <div class="form-text">
                  ‚ö†Ô∏è Requerido solo si hay monto de pago
                </div>
              </div>
            </div>

            <!-- Retenci√≥n - INTERFAZ MEJORADA -->
            <div class="card mb-3">
              <div class="card-header bg-light py-2">
                <h6 class="mb-0">
                  <i class="fas fa-receipt text-warning"></i> ¬øEl cliente tiene retenci√≥n?
                </h6>
              </div>
              <div class="card-body py-3">
                <!-- Botones grandes para selecci√≥n de retenci√≥n -->
                <div class="row text-center mb-3">
                  <div class="col-md-4">
                    <div class="card border-2 retencion-card" id="card-sin-retencion" style="cursor: pointer;">
                      <div class="card-body py-3">
                        <input type="radio" name="tieneRetencion" id="sin-retencion" value="false" checked style="display: none;">
                        <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                        <h6 class="card-title text-danger">NO</h6>
                        <p class="card-text small mb-0">Sin retenci√≥n</p>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <div class="card border-2 retencion-card" id="card-con-xml" style="cursor: pointer;">
                      <div class="card-body py-3">
                        <input type="radio" name="tieneRetencion" id="con-retencion-xml" value="xml" style="display: none;">
                        <i class="fas fa-file-code fa-2x text-success mb-2"></i>
                        <h6 class="card-title text-success">S√ç - Tengo XML</h6>
                        <p class="card-text small mb-0">Archivo del SRI</p>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <div class="card border-2 retencion-card" id="card-manual" style="cursor: pointer;">
                      <div class="card-body py-3">
                        <input type="radio" name="tieneRetencion" id="con-retencion-manual" value="manual" style="display: none;">
                        <i class="fas fa-edit fa-2x text-primary mb-2"></i>
                        <h6 class="card-title text-primary">S√ç - Ingreso Manual</h6>
                        <p class="card-text small mb-0">Capturar datos</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Secci√≥n XML de retenci√≥n -->
                <div id="seccion-xml-retencion" style="display: none;" class="mt-4">
                  <div class="alert alert-success">
                    <div class="row align-items-center">
                      <div class="col-md-8">
                        <h6><i class="fas fa-file-code text-primary"></i> Comprobante de Retenci√≥n XML</h6>
                        <p class="mb-2">
                          <strong>üìã Formato √∫nico:</strong> Archivo XML autorizado por el SRI<br>
                          <small class="text-success">‚úÖ 100% preciso - Sin errores de procesamiento</small>
                        </p>
                        
                        <div class="mb-3">
                          <input type="file" class="form-control" id="xml-retencion" 
                                 accept=".xml" aria-describedby="xml-help">
                          <div id="xml-help" class="form-text">
                            üìÅ Solo archivos .xml del SRI | M√°ximo 5MB
                          </div>
                        </div>
                      </div>
                      
                      <div class="col-md-4 text-center">
                        <button type="button" class="btn btn-success btn-lg" onclick="procesarXMLRetencion()">
                          <i class="fas fa-cogs me-1"></i>Procesar XML
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Resultado del procesamiento XML -->
                  <div id="resultado-xml" class="alert alert-success" style="display: none;">
                    <h6><i class="fas fa-check-circle text-success"></i> XML Procesado Correctamente</h6>
                    <div class="row small">
                      <div class="col-md-6">
                        <p class="mb-1"><strong>Comprobante:</strong> <span id="xml-comprobante">N/A</span></p>
                        <p class="mb-1"><strong>Empresa:</strong> <span id="xml-empresa">N/A</span></p>
                        <p class="mb-1"><strong>Factura:</strong> <span id="xml-factura">N/A</span></p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-1"><strong>Retenci√≥n IVA:</strong> $<span id="xml-ret-iva">0.00</span></p>
                        <p class="mb-1"><strong>Retenci√≥n Renta:</strong> $<span id="xml-ret-renta">0.00</span></p>
                        <p class="mb-1"><strong>Total Retenido:</strong> $<span id="xml-total">0.00</span></p>
                      </div>
                    </div>
                  </div>
                  
                  <div id="error-xml" class="alert alert-danger" style="display: none;">
                    <h6><i class="fas fa-exclamation-triangle text-danger"></i> Error al Procesar XML</h6>
                    <p id="mensaje-error-xml"></p>
                  </div>
                </div>

                <!-- Secci√≥n retenci√≥n manual -->
                <div id="seccion-manual-retencion" style="display: none;" class="mt-4">
                  <div class="alert alert-info">
                    <h6><i class="fas fa-edit text-primary"></i> Ingreso Manual de Retenci√≥n</h6>
                    <small class="text-info">üí° √ötil cuando no se dispone del XML del SRI</small>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="manual-comprobante" class="form-label">N√∫mero de Comprobante</label>
                        <input type="text" class="form-control" id="manual-comprobante" 
                               placeholder="001-001-000123456" pattern="[0-9]{3}-[0-9]{3}-[0-9]{9}">
                        <div class="form-text">Formato: 001-001-000123456</div>
                      </div>
                      
                      <div class="mb-3">
                        <label for="manual-empresa" class="form-label">Empresa que Retiene</label>
                        <input type="text" class="form-control" id="manual-empresa" 
                               placeholder="Raz√≥n social completa">
                      </div>
                      
                      <div class="mb-3">
                        <label for="manual-fecha" class="form-label">Fecha de Retenci√≥n</label>
                        <input type="date" class="form-control" id="manual-fecha">
                      </div>
                    </div>
                    
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="manual-ret-iva" class="form-label">Retenci√≥n IVA ($)</label>
                        <div class="input-group">
                          <span class="input-group-text">$</span>
                          <input type="number" class="form-control" id="manual-ret-iva" 
                                 step="0.01" min="0" placeholder="0.00" onchange="calcularTotalManual()">
                        </div>
                      </div>
                      
                      <div class="mb-3">
                        <label for="manual-ret-renta" class="form-label">Retenci√≥n Renta ($)</label>
                        <div class="input-group">
                          <span class="input-group-text">$</span>
                          <input type="number" class="form-control" id="manual-ret-renta" 
                                 step="0.01" min="0" placeholder="0.00" onchange="calcularTotalManual()">
                        </div>
                      </div>
                      
                      <div class="mb-3">
                        <label for="manual-total" class="form-label">Total Retenido ($)</label>
                        <div class="input-group">
                          <span class="input-group-text">$</span>
                          <input type="number" class="form-control bg-light" id="manual-total" 
                                 step="0.01" readonly placeholder="0.00">
                        </div>
                        <div class="form-text">Se calcula autom√°ticamente</div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="text-center">
                    <button type="button" class="btn btn-primary btn-lg" onclick="confirmarRetencionManual()">
                      <i class="fas fa-check me-1"></i>Confirmar Retenci√≥n Manual
                    </button>
                  </div>
                  
                  <!-- Resultado de retenci√≥n manual -->
                  <div id="resultado-manual" class="alert alert-success mt-3" style="display: none;">
                    <h6><i class="fas fa-check-circle text-success"></i> Retenci√≥n Manual Confirmada</h6>
                    <div class="row small">
                      <div class="col-md-6">
                        <p class="mb-1"><strong>Comprobante:</strong> <span id="manual-comprobante-result">N/A</span></p>
                        <p class="mb-1"><strong>Empresa:</strong> <span id="manual-empresa-result">N/A</span></p>
                        <p class="mb-1"><strong>Fecha:</strong> <span id="manual-fecha-result">N/A</span></p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-1"><strong>Retenci√≥n IVA:</strong> $<span id="manual-ret-iva-result">0.00</span></p>
                        <p class="mb-1"><strong>Retenci√≥n Renta:</strong> $<span id="manual-ret-renta-result">0.00</span></p>
                        <p class="mb-1"><strong>Total Retenido:</strong> $<span id="manual-total-result">0.00</span></p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Resumen de retenci√≥n -->
                <div id="resumen-retencion" class="mt-4" style="display: none;">
                  <div class="card border-info">
                    <div class="card-header bg-info text-white">
                      <h6 class="mb-0">
                        <i class="fas fa-calculator"></i> Resumen de Retenci√≥n
                      </h6>
                    </div>
                    <div class="card-body">
                      <div class="row text-center">
                        <div class="col-md-3">
                          <div class="text-muted small">RETENCI√ìN IVA</div>
                          <div class="fs-5 text-warning">$<span id="resumen-ret-iva">0.00</span></div>
                        </div>
                        <div class="col-md-3">
                          <div class="text-muted small">RETENCI√ìN RENTA</div>
                          <div class="fs-5 text-warning">$<span id="resumen-ret-renta">0.00</span></div>
                        </div>
                        <div class="col-md-3">
                          <div class="text-muted small">TOTAL RETENIDO</div>
                          <div class="fs-5 text-danger" id="retencion-total-display">$0.00</div>
                        </div>
                        <div class="col-md-3">
                          <div class="text-muted small">NETO A RECIBIR</div>
                          <div class="fs-5 text-success" id="neto-recibir-display">$0.00</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Informaci√≥n adicional -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="numeroComprobante" class="form-label">
                  <i class="fas fa-hashtag text-info"></i> N√∫mero de Comprobante (Opcional)
                </label>
                <input type="text" class="form-control" id="numeroComprobante" 
                       name="numeroComprobante" placeholder="Ej: 001-001-000123456">
              </div>
              
              <div class="col-md-6">
                <label for="observaciones" class="form-label">
                  <i class="fas fa-sticky-note text-secondary"></i> Observaciones (Opcional)
                </label>
                <textarea class="form-control" id="observaciones" name="observaciones" 
                          rows="1" placeholder="Notas adicionales sobre el pago..."></textarea>
              </div>
            </div>

            <!-- Resumen del pago -->
            <div class="card mb-3">
              <div class="card-header bg-info text-white py-2">
                <h6 class="mb-0">
                  <i class="fas fa-calculator"></i> Resumen del Pago
                </h6>
              </div>
              <div class="card-body py-3">
                <div class="row">
                  <div class="col-md-4">
                    <div class="text-center">
                      <h6 class="text-muted small">Monto Pago</h6>
                      <h4 id="monto-pago-display" class="text-primary">$0.00</h4>
                    </div>
                  </div>
                  <div class="col-md-4" id="columna-retencion" style="display: none;">
                    <div class="text-center">
                      <h6 class="text-muted small">Retenci√≥n</h6>
                      <h4 id="retencion-resumen-display" class="text-warning">$0.00</h4>
                      <small class="text-muted">
                        IVA: $<span id="resumen-iva-final">0.00</span> | 
                        Renta: $<span id="resumen-renta-final">0.00</span>
                      </small>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="text-center">
                      <h6 class="text-muted small">Queda Pendiente</h6>
                      <h4 id="queda-pendiente-display" class="text-danger">${{#if documento.valorPendiente}}{{formatMoney documento.valorPendiente}}{{else if documento.valorFactura}}{{formatMoney documento.valorFactura}}{{else}}0.00{{/if}}</h4>
                      <!-- Bot√≥n de auto-ajuste para diferencias m√≠nimas -->
                      <div id="auto-ajuste-container" style="display: none;" class="mt-2">
                        <button type="button" class="btn btn-sm btn-warning" id="btn-auto-ajuste" onclick="autoAjustarDiferencia()">
                          <i class="fas fa-magic me-1"></i>Auto-ajustar
                        </button>
                        <div class="small text-muted mt-1">Diferencia m√≠nima detectada</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Cancelar
          </button>
          
          <!-- Bot√≥n de registro din√°mico -->
          <button type="submit" id="btn-registrar-pago" class="btn btn-secondary btn-lg" disabled>
            <i class="fas fa-check me-1"></i>Seleccione una opci√≥n de pago
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- CSS eliminado - Ahora usa el sistema universal -->

<script>
document.addEventListener('DOMContentLoaded', function() {
  // ============== VARIABLES GLOBALES ==============
  const valorFacturaOriginal = parseFloat('{{#if documento.valorFactura}}{{documento.valorFactura}}{{else}}0{{/if}}') || 0;
  const valorPagadoActual = parseFloat('{{#if documento.valorPagado}}{{documento.valorPagado}}{{else}}0{{/if}}') || 0;
  const valorPendienteActual = parseFloat('{{#if documento.valorPendiente}}{{documento.valorPendiente}}{{else if documento.valorFactura}}{{documento.valorFactura}}{{else}}0{{/if}}') || 0;
  
  // Variables del modal de pago
  let datosRetencionXML = null;
  let datosRetencionManual = null;
  let tipoOperacionActual = 'sin_retencion';
  
  // ============== CONFIGURACI√ìN INICIAL ==============
  const fechaPagoInput = document.getElementById('fechaPago');
  if (fechaPagoInput && !fechaPagoInput.value) {
    const today = new Date().toISOString().split('T')[0];
    fechaPagoInput.value = today;
  }
  
  // Configurar modal de cambio de matrizador
  const cambiarMatrizadorModal = document.getElementById('cambiarMatrizadorModal');
  if (cambiarMatrizadorModal) {
    cambiarMatrizadorModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      const documentoId = button.getAttribute('data-documento-id');
      const matrizadorActualId = button.getAttribute('data-matrizador-actual-id');
      const matrizadorActualNombre = button.getAttribute('data-matrizador-actual-nombre');
      
      const form = this.querySelector('#formCambiarMatrizador');
      if (form) {
        form.querySelector('input[name="documentoId"]').value = documentoId;
        
        const select = form.querySelector('select[name="matrizadorId"]');
        if (select && matrizadorActualId) {
          Array.from(select.options).forEach(option => {
            if (option.value === matrizadorActualId) {
              option.disabled = true;
              option.textContent += ' (Actual)';
            }
          });
        }
      }
      
      const modalTitle = this.querySelector('.modal-title');
      if (modalTitle && matrizadorActualNombre) {
        modalTitle.textContent = `Cambiar Matrizador (Actual: ${matrizadorActualNombre})`;
      }
    });
  }
  
  // ============== MODAL DE PAGO - INICIALIZACI√ìN ==============
  const pagoModal = document.getElementById('registrarPagoModal');
  if (pagoModal) {
    // Inicializar cuando se abre el modal
    pagoModal.addEventListener('shown.bs.modal', function() {
      inicializarModalPago();
    });
    
    // Limpiar cuando se cierra el modal
    pagoModal.addEventListener('hidden.bs.modal', function() {
      limpiarModalPago();
    });
  }
  
  // Detectar si la URL contiene el fragmento #pago
  if (window.location.hash === '#pago') {
    const modal = new bootstrap.Modal(document.getElementById('registrarPagoModal'));
    modal.show();
  }
  
  // Verificar cuando cambie el hash de la URL
  window.addEventListener('hashchange', function() {
    if (window.location.hash === '#pago') {
      const modal = new bootstrap.Modal(document.getElementById('registrarPagoModal'));
      modal.show();
    }
  });
  
  // ============== FUNCIONES DEL MODAL DE PAGO ==============
  
  function inicializarModalPago() {
    console.log('üöÄ Inicializando modal de pago');
    console.log('üí∞ Valores del documento:', {
      valorFactura: valorFacturaOriginal,
      valorPagado: valorPagadoActual,
      valorPendiente: valorPendienteActual
    });
    
    // Configurar eventos de los botones de pago r√°pido
    configurarBotonesRapidos();
    
    // Configurar eventos de retenci√≥n
    configurarEventosRetencion();
    
    // Configurar eventos del formulario
    configurarEventosFormulario();
    
    // Actualizar valores iniciales
    actualizarCalculoRetencion();
    actualizarResumenPago();
    
    // Establecer fecha actual por defecto
    const fechaManual = document.getElementById('manual-fecha');
    if (fechaManual) {
      fechaManual.value = new Date().toISOString().split('T')[0];
    }
  }
  
  function limpiarModalPago() {
    console.log('üßπ Limpiando modal de pago');
    
    // Resetear variables globales
    datosRetencionXML = null;
    datosRetencionManual = null;
    tipoOperacionActual = 'sin_retencion';
    
    // Limpiar formulario
    const form = document.getElementById('formRegistrarPago');
    if (form) {
      form.reset();
    }
    
    // Ocultar secciones
    const formularioPago = document.getElementById('formulario-pago');
    if (formularioPago) formularioPago.style.display = 'none';
    
    const seccionXML = document.getElementById('seccion-xml-retencion');
    if (seccionXML) seccionXML.style.display = 'none';
    
    const seccionManual = document.getElementById('seccion-manual-retencion');
    if (seccionManual) seccionManual.style.display = 'none';
    
    // Limpiar tarjetas de retenci√≥n
    const tarjetas = document.querySelectorAll('.retencion-card');
    tarjetas.forEach(tarjeta => {
      tarjeta.classList.remove('selected', 'border-danger', 'border-success', 'border-primary');
    });
    
    // Resetear bot√≥n
    const btnRegistrar = document.getElementById('btn-registrar-pago');
    if (btnRegistrar) {
      btnRegistrar.className = 'btn btn-secondary btn-lg';
      btnRegistrar.disabled = true;
      btnRegistrar.innerHTML = '<i class="fas fa-check me-1"></i>Seleccione una opci√≥n de pago';
    }
  }
  
  function configurarBotonesRapidos() {
    // Bot√≥n Pago Total
    const btnPagoTotal = document.getElementById('btn-pago-total');
    if (btnPagoTotal) {
      btnPagoTotal.addEventListener('click', pagarTotalCompleto);
    }
    
    // Bot√≥n Pago con Retenci√≥n
    const btnPagoRetencion = document.getElementById('btn-pago-retencion');
    if (btnPagoRetencion) {
      btnPagoRetencion.addEventListener('click', pagarConRetencion);
    }
    
    // Bot√≥n Monto Personalizado
    const btnPersonalizado = document.getElementById('btn-monto-personalizado');
    if (btnPersonalizado) {
      btnPersonalizado.addEventListener('click', mostrarFormularioPersonalizado);
    }
  }
  
  function configurarEventosRetencion() {
    // Tarjetas de retenci√≥n
    const cardSinRetencion = document.getElementById('card-sin-retencion');
    const cardConXML = document.getElementById('card-con-xml');
    const cardManual = document.getElementById('card-manual');
    
    if (cardSinRetencion) {
      cardSinRetencion.addEventListener('click', () => seleccionarTipoRetencion('sin_retencion'));
    }
    if (cardConXML) {
      cardConXML.addEventListener('click', () => seleccionarTipoRetencion('con_xml'));
    }
    if (cardManual) {
      cardManual.addEventListener('click', () => seleccionarTipoRetencion('manual'));
    }
    
    // Radio buttons (backup)
    const radioSin = document.getElementById('sin-retencion');
    const radioXML = document.getElementById('con-retencion-xml');
    const radioManual = document.getElementById('con-retencion-manual');
    
    if (radioSin) radioSin.addEventListener('change', () => seleccionarTipoRetencion('sin_retencion'));
    if (radioXML) radioXML.addEventListener('change', () => seleccionarTipoRetencion('con_xml'));
    if (radioManual) radioManual.addEventListener('change', () => seleccionarTipoRetencion('manual'));
    
    // Campos de retenci√≥n manual
    const retIva = document.getElementById('manual-ret-iva');
    const retRenta = document.getElementById('manual-ret-renta');
    
    if (retIva) retIva.addEventListener('input', calcularTotalManual);
    if (retRenta) retRenta.addEventListener('input', calcularTotalManual);
  }
  
  function configurarEventosFormulario() {
    // Campo de monto
    const montoInput = document.getElementById('monto');
    if (montoInput) {
      montoInput.addEventListener('input', actualizarResumenPago);
    }
    
    // Campo de forma de pago
    const formaPagoSelect = document.getElementById('formaPago');
    if (formaPagoSelect) {
      formaPagoSelect.addEventListener('change', actualizarResumenPago);
    }
    
    // Formulario de env√≠o
    const form = document.getElementById('formRegistrarPago');
    if (form) {
      form.addEventListener('submit', procesarFormularioPago);
    }
  }
  
  // ============== BOTONES DE PAGO R√ÅPIDO ==============
  
  window.pagarTotalCompleto = function() {
    console.log('üü¢ Pago total completo seleccionado');
    
    // Mostrar formulario
    mostrarFormularioPago();
    
    // Configurar sin retenci√≥n
    seleccionarTipoRetencion('sin_retencion');
    
    // Establecer monto total
    const montoInput = document.getElementById('monto');
    if (montoInput) {
      montoInput.value = valorPendienteActual.toFixed(2);
    }
    
    // Preseleccionar efectivo
    const formaPagoSelect = document.getElementById('formaPago');
    if (formaPagoSelect) {
      formaPagoSelect.value = 'efectivo';
    }
    
    actualizarResumenPago();
  };
  
  window.pagarConRetencion = function() {
    console.log('üîµ Pago con retenci√≥n seleccionado');
    
    // Mostrar formulario
    mostrarFormularioPago();
    
    // Calcular retenci√≥n autom√°tica
    const calculo = calcularRetencionAutomatica(valorPendienteActual);
    
    // Mostrar informaci√≥n del c√°lculo
    mostrarInfoCalculoRetencion(calculo);
    
    // Configurar campos autom√°ticamente
    const montoInput = document.getElementById('monto');
    if (montoInput) {
      montoInput.value = calculo.netoRecibir.toFixed(2);
    }
    
    // Seleccionar retenci√≥n manual con datos precargados
    seleccionarTipoRetencion('manual');
    precargarDatosRetencion(calculo);
    
    // Preseleccionar transferencia para pagos con retenci√≥n
    const formaPagoSelect = document.getElementById('formaPago');
    if (formaPagoSelect) {
      formaPagoSelect.value = 'transferencia';
    }
    
    actualizarResumenPago();
  };
  
  window.mostrarFormularioPersonalizado = function() {
    console.log('‚ö™ Monto personalizado seleccionado');
    
    // Mostrar formulario
    mostrarFormularioPago();
    
    // Configurar sin retenci√≥n por defecto
    seleccionarTipoRetencion('sin_retencion');
    
    // Enfocar en el campo de monto
    const montoInput = document.getElementById('monto');
    if (montoInput) {
      montoInput.focus();
    }
    
    actualizarResumenPago();
  };
  
  function mostrarFormularioPago() {
    const formularioPago = document.getElementById('formulario-pago');
    if (formularioPago) {
      formularioPago.style.display = 'block';
    }
  }
  
  // ============== C√ÅLCULOS DE RETENCI√ìN ==============
  
  function calcularRetencionAutomatica(valorTotal) {
    // C√°lculos seg√∫n normativa ecuatoriana
    const subtotalSinIva = valorTotal / 1.15; // 15% IVA
    const iva = valorTotal - subtotalSinIva;
    const retencionIva = iva; // 100% del IVA
    const retencionRenta = subtotalSinIva * 0.10; // 10% del subtotal
    const totalRetenido = retencionIva + retencionRenta;
    const netoRecibir = valorTotal - totalRetenido;
    
    return {
      valorTotal: valorTotal,
      subtotalSinIva: subtotalSinIva,
      iva: iva,
      retencionIva: retencionIva,
      retencionRenta: retencionRenta,
      totalRetenido: totalRetenido,
      netoRecibir: netoRecibir
    };
  }
  
  function actualizarCalculoRetencion() {
    const calculo = calcularRetencionAutomatica(valorPendienteActual);
    
    // Actualizar bot√≥n de retenci√≥n
    const btnRetencion = document.getElementById('btn-pago-retencion');
    const valorRetencionBtn = document.getElementById('valor-pago-retencion');
    
    if (btnRetencion && valorRetencionBtn) {
      valorRetencionBtn.textContent = `~$${calculo.netoRecibir.toFixed(2)}`;
    }
  }
  
  function mostrarInfoCalculoRetencion(calculo) {
    const infoCalculo = document.getElementById('info-calculo-retencion');
    if (infoCalculo) {
      // Actualizar valores
      document.getElementById('calc-total').textContent = calculo.valorTotal.toFixed(2);
      document.getElementById('calc-subtotal').textContent = calculo.subtotalSinIva.toFixed(2);
      document.getElementById('calc-iva').textContent = calculo.iva.toFixed(2);
      document.getElementById('calc-ret-iva').textContent = calculo.retencionIva.toFixed(2);
      document.getElementById('calc-ret-renta').textContent = calculo.retencionRenta.toFixed(2);
      document.getElementById('calc-neto').textContent = calculo.netoRecibir.toFixed(2);
      
      infoCalculo.style.display = 'block';
    }
  }
  
  function precargarDatosRetencion(calculo) {
    // Precargar datos en retenci√≥n manual
    document.getElementById('manual-ret-iva').value = calculo.retencionIva.toFixed(2);
    document.getElementById('manual-ret-renta').value = calculo.retencionRenta.toFixed(2);
    document.getElementById('manual-total').value = calculo.totalRetenido.toFixed(2);
    
    // Simular confirmaci√≥n autom√°tica
    setTimeout(() => {
      confirmarRetencionManual();
    }, 500);
  }
  
  // ============== MANEJO DE RETENCI√ìN ==============
  
  function seleccionarTipoRetencion(tipo) {
    console.log('üîÑ Seleccionando tipo de retenci√≥n:', tipo);
    
    tipoOperacionActual = tipo;
    
    // Limpiar tarjetas
    const tarjetas = document.querySelectorAll('.retencion-card');
    tarjetas.forEach(tarjeta => {
      tarjeta.classList.remove('selected', 'border-danger', 'border-success', 'border-primary');
    });
    
    // Ocultar secciones
    document.getElementById('seccion-xml-retencion').style.display = 'none';
    document.getElementById('seccion-manual-retencion').style.display = 'none';
    document.getElementById('info-calculo-retencion').style.display = 'none';
    
    // Limpiar datos de retenci√≥n
    datosRetencionXML = null;
    datosRetencionManual = null;
    
    // Configurar seg√∫n el tipo
    switch(tipo) {
      case 'sin_retencion':
        document.getElementById('card-sin-retencion').classList.add('selected', 'border-danger');
        document.getElementById('sin-retencion').checked = true;
        break;
        
      case 'con_xml':
        document.getElementById('card-con-xml').classList.add('selected', 'border-success');
        document.getElementById('con-retencion-xml').checked = true;
        document.getElementById('seccion-xml-retencion').style.display = 'block';
        break;
        
      case 'manual':
        document.getElementById('card-manual').classList.add('selected', 'border-primary');
        document.getElementById('con-retencion-manual').checked = true;
        document.getElementById('seccion-manual-retencion').style.display = 'block';
        break;
    }
    
    actualizarResumenPago();
  }
  
  function calcularTotalManual() {
    const retIva = parseFloat(document.getElementById('manual-ret-iva').value) || 0;
    const retRenta = parseFloat(document.getElementById('manual-ret-renta').value) || 0;
    const total = retIva + retRenta;
    
    document.getElementById('manual-total').value = total.toFixed(2);
    
    // Si hay datos, actualizar resumen
    if (datosRetencionManual) {
      datosRetencionManual.retencionIva = retIva;
      datosRetencionManual.retencionRenta = retRenta;
      datosRetencionManual.totalRetenido = total;
      actualizarResumenPago();
    }
  }
  
  window.confirmarRetencionManual = function() {
    const comprobante = document.getElementById('manual-comprobante').value.trim();
    const empresa = document.getElementById('manual-empresa').value.trim();
    const retIva = parseFloat(document.getElementById('manual-ret-iva').value) || 0;
    const retRenta = parseFloat(document.getElementById('manual-ret-renta').value) || 0;
    const total = retIva + retRenta;
    const fecha = document.getElementById('manual-fecha').value;
    
    // Validaciones b√°sicas
    if (total <= 0) {
      alert('‚ùå Debe ingresar al menos una retenci√≥n (IVA o Renta)');
      return;
    }
    
    if (total > valorPendienteActual) {
      alert(`‚ùå El total retenido ($${total.toFixed(2)}) no puede exceder el valor pendiente ($${valorPendienteActual.toFixed(2)})`);
      return;
    }
    
    // Crear objeto de retenci√≥n manual
    datosRetencionManual = {
      numeroComprobanteRetencion: comprobante || 'MANUAL-' + Date.now(),
      razonSocialRetenedora: empresa || 'Cliente',
      retencionIva: retIva,
      retencionRenta: retRenta,
      totalRetenido: total,
      fechaRetencion: fecha || new Date().toISOString().split('T')[0],
      tipoIngreso: 'manual'
    };
    
    // Mostrar resultado
    const resultadoManual = document.getElementById('resultado-manual');
    if (resultadoManual) {
      document.getElementById('manual-comprobante-result').textContent = datosRetencionManual.numeroComprobanteRetencion;
      document.getElementById('manual-empresa-result').textContent = datosRetencionManual.razonSocialRetenedora;
      document.getElementById('manual-fecha-result').textContent = new Date(datosRetencionManual.fechaRetencion).toLocaleDateString();
      document.getElementById('manual-ret-iva-result').textContent = retIva.toFixed(2);
      document.getElementById('manual-ret-renta-result').textContent = retRenta.toFixed(2);
      document.getElementById('manual-total-result').textContent = total.toFixed(2);
      
      resultadoManual.style.display = 'block';
    }
    
    // Actualizar resumen de retenci√≥n
    actualizarResumenRetencion();
    
    // Actualizar resumen del pago
    actualizarResumenPago();
    
    console.log('‚úÖ Retenci√≥n manual confirmada:', datosRetencionManual);
  };
  
  function actualizarResumenRetencion() {
    const datos = datosRetencionXML || datosRetencionManual;
    
    if (datos && datos.totalRetenido > 0) {
      document.getElementById('resumen-ret-iva').textContent = datos.retencionIva.toFixed(2);
      document.getElementById('resumen-ret-renta').textContent = datos.retencionRenta.toFixed(2);
      document.getElementById('retencion-total-display').textContent = '$' + datos.totalRetenido.toFixed(2);
      document.getElementById('neto-recibir-display').textContent = '$' + (valorPendienteActual - datos.totalRetenido).toFixed(2);
      
      document.getElementById('resumen-retencion').style.display = 'block';
    } else {
      document.getElementById('resumen-retencion').style.display = 'none';
    }
  }
  
  // ============== PROCESAMIENTO XML ==============
  
  window.procesarXMLRetencion = function() {
    const fileInput = document.getElementById('xml-retencion');
    const file = fileInput.files[0];
    
    if (!file) {
      alert('‚ùå Por favor seleccione un archivo XML');
      return;
    }
    
    if (!file.name.toLowerCase().endsWith('.xml')) {
      alert('‚ùå El archivo debe ser un XML v√°lido del SRI');
      return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
      alert('‚ùå El archivo es demasiado grande (m√°ximo 5MB)');
      return;
    }
    
    const formData = new FormData();
    formData.append('xmlRetencion', file);
    formData.append('documentoId', '{{documento.id}}');
    
    // Mostrar loading
    const btnProcesar = event.target;
    const textoOriginal = btnProcesar.innerHTML;
    btnProcesar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
    btnProcesar.disabled = true;
    
    fetch('/caja/procesar-xml-retencion', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`Error del servidor: ${response.status}`);
      }
      return response.json();
    })
    .then(resultado => {
      if (resultado.success) {
        datosRetencionXML = resultado.data;
        mostrarResultadoXML(resultado.data);
        document.getElementById('error-xml').style.display = 'none';
        actualizarResumenRetencion();
        actualizarResumenPago();
      } else {
        throw new Error(resultado.message || 'Error desconocido al procesar XML');
      }
    })
    .catch(error => {
      console.error('‚ùå Error procesando XML:', error);
      document.getElementById('mensaje-error-xml').textContent = error.message;
      document.getElementById('error-xml').style.display = 'block';
      document.getElementById('resultado-xml').style.display = 'none';
    })
    .finally(() => {
      btnProcesar.innerHTML = textoOriginal;
      btnProcesar.disabled = false;
    });
  };
  
  function mostrarResultadoXML(datos) {
    document.getElementById('xml-comprobante').textContent = datos.numeroComprobanteRetencion || 'N/A';
    document.getElementById('xml-empresa').textContent = datos.razonSocialRetenedora || 'N/A';
    document.getElementById('xml-factura').textContent = datos.numeroFactura || 'N/A';
    document.getElementById('xml-ret-iva').textContent = (datos.retencionIva || 0).toFixed(2);
    document.getElementById('xml-ret-renta').textContent = (datos.retencionRenta || 0).toFixed(2);
    document.getElementById('xml-total').textContent = (datos.totalRetenido || 0).toFixed(2);
    
    document.getElementById('resultado-xml').style.display = 'block';
    
    // Guardar datos para env√≠o
    document.getElementById('xml-retencion-data').value = JSON.stringify(datos);
    
    // Auto-ajustar monto si es necesario
    setTimeout(() => {
      autoAjustarConXML(datos);
    }, 500);
  }
  
  // ============== RESUMEN Y VALIDACI√ìN ==============
  
  function actualizarResumenPago() {
    const monto = parseFloat(document.getElementById('monto').value) || 0;
    const formaPago = document.getElementById('formaPago').value;
    const datosRetencion = datosRetencionXML || datosRetencionManual;
    const montoRetencion = datosRetencion ? datosRetencion.totalRetenido : 0;
    
    // Actualizar displays
    document.getElementById('monto-pago-display').textContent = '$' + monto.toFixed(2);
    
    if (montoRetencion > 0) {
      document.getElementById('columna-retencion').style.display = 'block';
      document.getElementById('retencion-resumen-display').textContent = '$' + montoRetencion.toFixed(2);
      document.getElementById('resumen-iva-final').textContent = datosRetencion.retencionIva.toFixed(2);
      document.getElementById('resumen-renta-final').textContent = datosRetencion.retencionRenta.toFixed(2);
    } else {
      document.getElementById('columna-retencion').style.display = 'none';
    }
    
    const totalMovimiento = monto + montoRetencion;
    const quedaPendiente = Math.max(0, valorPendienteActual - totalMovimiento);
    
    document.getElementById('queda-pendiente-display').textContent = '$' + quedaPendiente.toFixed(2);
    
    // Cambiar color seg√∫n el estado
    const pendienteDisplay = document.getElementById('queda-pendiente-display');
    if (quedaPendiente <= 0) {
      pendienteDisplay.className = 'text-success';
    } else if (quedaPendiente < valorPendienteActual) {
      pendienteDisplay.className = 'text-warning';
    } else {
      pendienteDisplay.className = 'text-danger';
    }
    
    // Mostrar bot√≥n de auto-ajuste para diferencias m√≠nimas
    mostrarAutoAjusteSiEsNecesario(quedaPendiente, monto);
    
    // Actualizar estado del bot√≥n
    actualizarEstadoBoton(monto, formaPago, datosRetencion);
  }
  
  function mostrarAutoAjusteSiEsNecesario(quedaPendiente, montoActual) {
    const autoAjusteContainer = document.getElementById('auto-ajuste-container');
    
    // Mostrar auto-ajuste si la diferencia es m√≠nima (menos de $0.50)
    if (quedaPendiente > 0 && quedaPendiente < 0.50 && montoActual > 0) {
      autoAjusteContainer.style.display = 'block';
      const btnAutoAjuste = document.getElementById('btn-auto-ajuste');
      btnAutoAjuste.textContent = `Auto-ajustar +$${quedaPendiente.toFixed(2)}`;
    } else {
      autoAjusteContainer.style.display = 'none';
    }
  }
  
  // ============== FUNCIONES DE AUTO-AJUSTE ==============
  
  window.autoAjustarDiferencia = function() {
    const monto = parseFloat(document.getElementById('monto').value) || 0;
    const datosRetencion = datosRetencionXML || datosRetencionManual;
    const montoRetencion = datosRetencion ? datosRetencion.totalRetenido : 0;
    const totalMovimiento = monto + montoRetencion;
    const diferencia = valorPendienteActual - totalMovimiento;
    
    if (diferencia > 0 && diferencia < 0.50) {
      const nuevoMonto = monto + diferencia;
      
      // Confirmar con el usuario
      const mensaje = `¬øAjustar el monto de pago para completar el documento?\\n\\n` +
                     `üí∞ Monto actual: $${monto.toFixed(2)}\\n` +
                     `‚ûï Ajuste: +$${diferencia.toFixed(2)}\\n` +
                     `üéØ Nuevo monto: $${nuevoMonto.toFixed(2)}\\n\\n` +
                     `‚úÖ Esto dejar√° el documento completamente pagado.`;
      
      if (confirm(mensaje)) {
        document.getElementById('monto').value = nuevoMonto.toFixed(2);
        actualizarResumenPago();
        
        // Mostrar notificaci√≥n de √©xito
        mostrarNotificacion(
          `‚úÖ Monto ajustado autom√°ticamente\\nüí∞ Nuevo monto: $${nuevoMonto.toFixed(2)}\\nüéØ Documento completamente pagado`, 
          'success', 
          3000
        );
      }
    }
  };
  
  function mostrarNotificacion(mensaje, tipo = 'info', duracion = 4000) {
    // Remover notificaciones anteriores
    const notificacionesAnteriores = document.querySelectorAll('.notificacion-toast');
    notificacionesAnteriores.forEach(n => n.remove());
    
    // Crear contenedor de notificaci√≥n mejorado
    const toast = document.createElement('div');
    toast.className = `notificacion-toast alert alert-${tipo} alert-dismissible fade show shadow-lg`;
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      min-width: 350px;
      max-width: 500px;
      border-radius: 8px;
      animation: slideInRight 0.3s ease-out;
    `;
    
    // Iconos seg√∫n el tipo
    const iconos = {
      success: 'fas fa-check-circle text-success',
      error: 'fas fa-exclamation-circle text-danger',
      warning: 'fas fa-exclamation-triangle text-warning',
      info: 'fas fa-info-circle text-info'
    };
    
    toast.innerHTML = `
      <div class="d-flex align-items-center">
        <i class="${iconos[tipo] || iconos.info} me-2 fa-lg"></i>
        <div class="flex-grow-1">
          ${mensaje.replace(/\\n/g, '<br>')}
        </div>
        <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remover despu√©s del tiempo especificado
    setTimeout(() => {
      if (toast.parentNode) {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 300);
      }
    }, duracion);
  }
  
  // Mejorar el procesamiento XML con auto-ajuste
  function autoAjustarConXML(datosXML) {
    const montoActual = parseFloat(document.getElementById('monto').value) || 0;
    const totalConRetencion = montoActual + datosXML.totalRetenido;
    const diferencia = valorPendienteActual - totalConRetencion;
    
    // Si hay XML del SRI y la diferencia es m√≠nima (menos de $0.20), auto-ajustar
    if (Math.abs(diferencia) < 0.20 && Math.abs(diferencia) > 0.01) {
      const montoSugerido = valorPendienteActual - datosXML.totalRetenido;
      
      if (montoSugerido > 0) {
        document.getElementById('monto').value = montoSugerido.toFixed(2);
        actualizarResumenPago();
        
        mostrarNotificacion(
          `‚úÖ Monto ajustado autom√°ticamente con datos precisos del SRI\\nüí∞ Ajuste: ${diferencia > 0 ? '+' : ''}$${diferencia.toFixed(2)}\\nüéØ Ahora el documento coincide exactamente`,
          'success',
          4000
        );
      }
    }
  }
  
  function actualizarEstadoBoton(monto, formaPago, datosRetencion) {
    const btnRegistrar = document.getElementById('btn-registrar-pago');
    const montoRetencion = datosRetencion ? datosRetencion.totalRetenido : 0;
    
    let puedeRegistrar = false;
    let textoBoton = 'Seleccione una opci√≥n de pago';
    let claseBoton = 'btn btn-secondary btn-lg';
    
    // Validar diferentes escenarios
    if (monto > 0 && tipoOperacionActual === 'sin_retencion' && formaPago) {
      // Pago simple
      puedeRegistrar = true;
      textoBoton = `Registrar Pago ($${monto.toFixed(2)})`;
      claseBoton = 'btn btn-success btn-lg';
    } else if (monto > 0 && montoRetencion > 0 && formaPago) {
      // Pago con retenci√≥n
      puedeRegistrar = true;
      const total = monto + montoRetencion;
      textoBoton = `Registrar Pago + Retenci√≥n ($${total.toFixed(2)})`;
      claseBoton = 'btn btn-success btn-lg';
    } else if (monto === 0 && montoRetencion > 0) {
      // Solo retenci√≥n
      puedeRegistrar = true;
      textoBoton = `Registrar Solo Retenci√≥n ($${montoRetencion.toFixed(2)})`;
      claseBoton = 'btn btn-warning btn-lg';
    } else if (monto > 0 && !formaPago) {
      textoBoton = 'Seleccione forma de pago';
    } else if (tipoOperacionActual === 'con_xml' && !datosRetencion) {
      textoBoton = 'Procese el XML de retenci√≥n';
    } else if (tipoOperacionActual === 'manual' && !datosRetencion) {
      textoBoton = 'Confirme la retenci√≥n manual';
    }
    
    btnRegistrar.disabled = !puedeRegistrar;
    btnRegistrar.innerHTML = `<i class="fas fa-check me-1"></i>${textoBoton}`;
    btnRegistrar.className = claseBoton;
  }
  
  // ============== ENV√çO DEL FORMULARIO ==============
  
  function procesarFormularioPago(e) {
    e.preventDefault();
    
    const monto = parseFloat(document.getElementById('monto').value) || 0;
    const formaPago = document.getElementById('formaPago').value;
    const datosRetencion = datosRetencionXML || datosRetencionManual;
    const montoRetencion = datosRetencion ? datosRetencion.totalRetenido : 0;
    
    // Validaciones finales
    if (monto <= 0 && montoRetencion <= 0) {
      mostrarNotificacion('‚ùå Debe ingresar un monto de pago o configurar una retenci√≥n', 'error');
      return;
    }
    
    if (monto > 0 && !formaPago) {
      mostrarNotificacion('‚ùå Seleccione una forma de pago', 'error');
      return;
    }
    
    const totalMovimiento = monto + montoRetencion;
    if (totalMovimiento > valorPendienteActual) {
      mostrarNotificacion(`‚ùå El total ($${totalMovimiento.toFixed(2)}) excede el valor pendiente ($${valorPendienteActual.toFixed(2)})`, 'error');
      return;
    }
    
    // Confirmaci√≥n
    let mensaje = `¬øConfirmar registro de pago?

üí∞ Monto: $${monto.toFixed(2)}`;
    if (montoRetencion > 0) {
      mensaje += `
üìÑ Retenci√≥n: $${montoRetencion.toFixed(2)}`;
    }
    mensaje += `
üßÆ Total: $${totalMovimiento.toFixed(2)}
üìä Quedar√° pendiente: $${(valorPendienteActual - totalMovimiento).toFixed(2)}`;
    
    if (!confirm(mensaje)) {
      return;
    }
    
    // Preparar datos
    if (datosRetencion) {
      document.getElementById('xml-retencion-data').value = JSON.stringify(datosRetencion);
    }
    
    // Mostrar loading
    const btnRegistrar = document.getElementById('btn-registrar-pago');
    const textoOriginal = btnRegistrar.innerHTML;
    btnRegistrar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando pago...';
    btnRegistrar.disabled = true;
    
    // CORREGIDO: Enviar formulario como form normal en lugar de fetch
    // Esto evita el error JSON porque el servidor manejar√° la redirecci√≥n
    mostrarNotificacion('üîÑ Procesando pago, por favor espere...', 'info', 2000);
    
    // Enviar el formulario normalmente
    setTimeout(() => {
      e.target.submit();
    }, 100);
  }
  
  console.log('üìñ Vista caja con modal de pago completo cargada para documento {{documento.codigoBarras}}');
});
</script>
{{else}}
<div class="alert alert-warning">
  <i class="fas fa-exclamation-triangle me-2"></i> El documento solicitado no existe o no tienes permisos para verlo.
</div>
{{/if}} 