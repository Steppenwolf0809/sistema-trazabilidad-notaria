{{!-- VISTA DE ENTREGA ARCHIVO - INTERFAZ UNIFICADA --}}
<div class="container-fluid" data-user-role="archivo">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-handshake me-2"></i>Entrega de Documentos - Archivo</h2>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/archivo">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/archivo/documentos/mis-documentos">Mis Documentos</a></li>
            <li class="breadcrumb-item active">Entrega</li>
          </ol>
        </nav>
      </div>

      {{!-- Mensajes de estado --}}
      {{#if error}}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fas fa-exclamation-triangle me-2"></i>{{error}}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {{/if}}

      {{#if success}}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="fas fa-check-circle me-2"></i>{{success}}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {{/if}}

      {{#if documento}}
        {{!-- ============== 1. DOCUMENTO PRINCIPAL CON INFORMACIÓN COMPLETA ============== --}}
        <div class="card mb-3">
          <div class="card-header bg-purple text-white">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h5 class="mb-1">
                  <i class="fas fa-file-alt me-2"></i>📄 Documento Principal: {{documento.codigoBarras}}
                </h5>
                <small class="opacity-75">
                  <strong>Código de Verificación:</strong> 
                  {{#if documento.codigoVerificacion}}
                    {{#if (eq documento.codigoVerificacion 'sin_codigo')}}
                      <span class="badge bg-warning text-dark">Sin código</span>
                    {{else}}
                      <code class="bg-light text-dark px-2 py-1 rounded">{{documento.codigoVerificacion}}</code>
                    {{/if}}
                  {{else}}
                    <span class="badge bg-warning text-dark">Sin código</span>
                  {{/if}}
                </small>
              </div>
              <span class="badge bg-light text-dark fs-6">{{documento.tipoDocumento}}</span>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <h6><i class="fas fa-user me-1"></i> Cliente</h6>
                <p class="mb-1"><strong>{{documento.nombreCliente}}</strong></p>
                <p class="text-muted mb-0"><small>{{documento.identificacionCliente}}</small></p>
              </div>
              <div class="col-md-3">
                <h6><i class="fas fa-user-tie me-1"></i> Responsable</h6>
                <p class="mb-1"><strong>{{documento.matrizador.nombre}}</strong></p>
                <p class="text-muted mb-0"><small>Archivo</small></p>
              </div>
              <div class="col-md-3">
                <h6><i class="fas fa-dollar-sign me-1"></i> Valor</h6>
                <p class="mb-1"><strong>${{formatMoney documento.valorFactura}}</strong></p>
                <p class="text-muted mb-0"><small>{{#if documento.numeroFactura}}Fact: {{documento.numeroFactura}}{{else}}Sin factura{{/if}}</small></p>
              </div>
              <div class="col-md-2">
                <h6><i class="fas fa-credit-card me-1"></i> Estado Pago</h6>
                <span class="badge {{estadoPagoClass documento.estadoPago}} fs-6">
                  {{estadoPagoTexto documento.estadoPago}}
                </span>
              </div>
            </div>
          </div>
        </div>

        {{!-- ============== 3. FORMULARIO DE ENTREGA ============== --}}
        <div class="card">
          <div class="card-header bg-light">
            <h5 class="mb-0">
              <i class="fas fa-clipboard-check me-2"></i>
              Datos de Entrega
            </h5>
          </div>
          <div class="card-body">
            <form id="entregaForm" method="POST" action="/archivo/documentos/entrega/{{documento.id}}">
              
              {{!-- Información de quien recibe --}}
              <div class="row mb-4">
                <div class="col-12 mb-3">
                  <h6 class="border-bottom pb-2">
                    <i class="fas fa-user-check me-2"></i>Información de quien recibe
                  </h6>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="nombreReceptor" class="form-label">
                    <strong>Nombre completo de quien recibe <span class="text-danger">*</span></strong>
                  </label>
                  <input type="text" class="form-control" id="nombreReceptor" name="nombreReceptor" required>
                  <div class="form-text">Persona que físicamente recibe el documento</div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="identificacionReceptor" class="form-label">
                    <strong>Identificación de quien recibe <span class="text-danger">*</span></strong>
                  </label>
                  <input type="text" class="form-control" id="identificacionReceptor" name="identificacionReceptor" required>
                  <div class="form-text">Cédula o documento de identidad</div>
                </div>
              </div>
              
              {{!-- Relación con el cliente --}}
              <div class="row mb-4">
                <div class="col-md-6 mb-3">
                  <label for="relacionReceptor" class="form-label">
                    <strong>Relación con el cliente <span class="text-danger">*</span></strong>
                  </label>
                  <select class="form-select" id="relacionReceptor" name="relacionReceptor" required>
                    <option value="" selected disabled>Seleccione la relación...</option>
                    <option value="titular">Titular del documento</option>
                    <option value="representante_legal">Representante legal</option>
                    <option value="apoderado">Apoderado</option>
                    <option value="familiar">Familiar autorizado</option>
                    <option value="empleado">Empleado autorizado</option>
                    <option value="tercero_autorizado">Tercero autorizado</option>
                    <option value="otro">Otro</option>
                  </select>
                </div>
                
                <div class="col-md-6 mb-3" id="detalleOtraRelacion" style="display: none;">
                  <label for="detalleRelacion" class="form-label">
                    <strong>Especifique la relación</strong>
                  </label>
                  <input type="text" class="form-control" id="detalleRelacion" name="detalleRelacion">
                </div>
              </div>
              
              {{!-- CÓDIGO DE VERIFICACIÓN - CAMPO CRÍTICO DE SEGURIDAD --}}
              <div class="row mb-4">
                <div class="col-12 mb-3">
                  <h6 class="border-bottom pb-2">
                    <i class="fas fa-key me-2"></i>Verificación de Seguridad
                  </h6>
                </div>
                
                <div class="col-md-6 mb-3">
                  <label for="codigoVerificacion" class="form-label">
                    <strong>Código de Verificación <span class="text-danger">*</span></strong>
                  </label>
                  <input type="text" class="form-control form-control-lg text-center" 
                         id="codigoVerificacion" name="codigoVerificacion" 
                         placeholder="Ingrese el código de 4 dígitos" 
                         maxlength="4" pattern="[0-9]{4}" required
                         style="font-size: 1.5rem; letter-spacing: 0.3rem; font-weight: bold;">
                  <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>
                    El cliente debe proporcionar el código de 4 dígitos que recibió por notificación
                  </div>
                </div>
                
                <div class="col-md-6 mb-3">
                  <div class="alert alert-warning mb-0">
                    <h6 class="alert-heading mb-2">
                      <i class="fas fa-shield-alt me-1"></i>Código del Sistema
                    </h6>
                    <p class="mb-1">
                      <strong>Código esperado:</strong> 
                      {{#if documento.codigoVerificacion}}
                        {{#if (eq documento.codigoVerificacion 'sin_codigo')}}
                          <span class="badge bg-danger">Sin código generado</span>
                        {{else}}
                          <code class="bg-light text-dark px-2 py-1 rounded fs-5">{{documento.codigoVerificacion}}</code>
                        {{/if}}
                      {{else}}
                        <span class="badge bg-danger">Sin código generado</span>
                      {{/if}}
                    </p>
                    <small class="text-muted">
                      Solo para verificación del personal - NO mostrar al cliente
                    </small>
                  </div>
                </div>
              </div>
              
              {{!-- Observaciones --}}
              <div class="row mb-4">
                <div class="col-12 mb-3">
                  <label for="observacionesEntrega" class="form-label">
                    <strong>Observaciones de la entrega</strong>
                  </label>
                  <textarea class="form-control" id="observacionesEntrega" name="observacionesEntrega" rows="3" 
                    placeholder="Cualquier observación relevante sobre la entrega..."></textarea>
                </div>
              </div>
              
              {{!-- Confirmación --}}
              <div class="row mb-4">
                <div class="col-12">
                  <div class="alert alert-info">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="confirmarEntrega" required>
                      <label class="form-check-label" for="confirmarEntrega">
                        <strong>Confirmo que he verificado la identidad de la persona que recibe el documento y que está autorizada para recibirlo.</strong>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              
              {{!-- Botones de acción --}}
              <div class="d-flex justify-content-between">
                <a href="/archivo/documentos/mis-documentos" class="btn btn-outline-secondary">
                  <i class="fas fa-arrow-left me-1"></i> Cancelar
                </a>
                
                <button type="submit" class="btn btn-purple" id="btnEntregarDocumento">
                  <i class="fas fa-handshake me-1"></i> Entregar Documento
                </button>
              </div>
            </form>
          </div>
        </div>
      {{else}}
        <div class="alert alert-danger">
          <h4>Documento no encontrado</h4>
          <p>El documento solicitado no existe o no está listo para entrega.</p>
          <a href="/archivo/documentos/mis-documentos" class="btn btn-primary">Volver a mis documentos</a>
        </div>
      {{/if}}
    </div>
  </div>
</div>

<style>
.bg-purple {
  background-color: #6f42c1 !important;
}

.btn-purple {
  background-color: #6f42c1;
  border-color: #6f42c1;
  color: white;
}

.btn-purple:hover {
  background-color: #5a2d91;
  border-color: #5a2d91;
  color: white;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Manejar cambio en relación del receptor
  const relacionSelect = document.getElementById('relacionReceptor');
  const detalleOtraRelacion = document.getElementById('detalleOtraRelacion');
  
  relacionSelect.addEventListener('change', function() {
    if (this.value === 'otro') {
      detalleOtraRelacion.style.display = 'block';
      document.getElementById('detalleRelacion').required = true;
    } else {
      detalleOtraRelacion.style.display = 'none';
      document.getElementById('detalleRelacion').required = false;
    }
  });
  
  // Validaciones del formulario
  const form = document.getElementById('entregaForm');
  form.addEventListener('submit', function(e) {
    const nombreReceptor = document.getElementById('nombreReceptor').value.trim();
    const identificacionReceptor = document.getElementById('identificacionReceptor').value.trim();
    const relacionReceptor = document.getElementById('relacionReceptor').value;
    const codigoVerificacion = document.getElementById('codigoVerificacion').value.trim();
    const confirmarEntrega = document.getElementById('confirmarEntrega').checked;
    
    // Validar campos obligatorios
    if (!nombreReceptor || !identificacionReceptor || !relacionReceptor || !codigoVerificacion || !confirmarEntrega) {
      e.preventDefault();
      alert('Por favor complete todos los campos obligatorios, incluyendo el código de verificación.');
      return false;
    }
    
    // Validar formato del código (4 dígitos numéricos)
    if (!/^\d{4}$/.test(codigoVerificacion)) {
      e.preventDefault();
      alert('El código de verificación debe ser exactamente 4 dígitos numéricos.');
      document.getElementById('codigoVerificacion').focus();
      return false;
    }
    
    // Confirmación final
    if (!confirm('¿Está seguro de entregar este documento? Esta acción no se puede deshacer.')) {
      e.preventDefault();
      return false;
    }
  });
  
  // Validación en tiempo real del código de verificación
  const codigoInput = document.getElementById('codigoVerificacion');
  codigoInput.addEventListener('input', function(e) {
    // Solo permitir números
    this.value = this.value.replace(/[^0-9]/g, '');
    
    // Limitar a 4 dígitos
    if (this.value.length > 4) {
      this.value = this.value.slice(0, 4);
    }
    
    // Cambiar color según validez
    if (this.value.length === 4) {
      this.classList.remove('is-invalid');
      this.classList.add('is-valid');
    } else {
      this.classList.remove('is-valid');
      if (this.value.length > 0) {
        this.classList.add('is-invalid');
      }
    }
  });
});
</script> 