{{!-- 🎯 VISTA MIS DOCUMENTOS ARCHIVO - MIGRACIÓN COMPLETA AL SISTEMA UNIVERSAL --}}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span><i class="fas fa-folder-open me-2"></i> Mis Documentos de Archivo</span>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/archivo">Dashboard</a></li>
        <li class="breadcrumb-item active">Mis Documentos</li>
      </ol>
    </nav>
  </div>
  <div class="card-body">
    <!-- Filtros -->
    <div class="mb-4">
      <form id="filtrosFormArchivoMis" action="/archivo/documentos/mis-documentos" method="GET" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label for="buscar" class="form-label">Buscar</label>
          <input type="text" class="form-control" id="buscar" name="buscar" value="{{filtros.buscar}}" placeholder="Código, cliente, identificación">
        </div>
        <div class="col-md-2">
          <label for="estado" class="form-label">Estado Doc.</label>
          <select class="form-select" id="estado" name="estado">
            <option value="">Todos</option>
            <option value="en_proceso" {{#if (eq filtros.estado "en_proceso")}}selected{{/if}}>En Proceso</option>
            <option value="listo_para_entrega" {{#if (eq filtros.estado "listo_para_entrega")}}selected{{/if}}>Listo</option>
            <option value="entregado" {{#if (eq filtros.estado "entregado")}}selected{{/if}}>Entregado</option>
            <option value="cancelado" {{#if (eq filtros.estado "cancelado")}}selected{{/if}}>Cancelado</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="estadoPago" class="form-label">Estado Pago</label>
          <select class="form-select" id="estadoPago" name="estadoPago">
            <option value="">Todos</option>
            <option value="pendiente" {{#if (eq filtros.estadoPago "pendiente")}}selected{{/if}}>Pendiente</option>
            <option value="pago_parcial" {{#if (eq filtros.estadoPago "pago_parcial")}}selected{{/if}}>Pago Parcial</option>
            <option value="pagado_completo" {{#if (eq filtros.estadoPago "pagado_completo")}}selected{{/if}}>Pagado Completo</option>
            <option value="pagado_con_retencion" {{#if (eq filtros.estadoPago "pagado_con_retencion")}}selected{{/if}}>Con Retención</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="tipoDocumento" class="form-label">Tipo Doc.</label>
          <select class="form-select" id="tipoDocumento" name="tipoDocumento">
            <option value="">Todos</option>
            <option value="Protocolo" {{#if (eq filtros.tipoDocumento "Protocolo")}}selected{{/if}}>Protocolo</option>
            <option value="Diligencias" {{#if (eq filtros.tipoDocumento "Diligencias")}}selected{{/if}}>Diligencias</option>
            <option value="Certificaciones" {{#if (eq filtros.tipoDocumento "Certificaciones")}}selected{{/if}}>Certificaciones</option>
            <option value="Arrendamientos" {{#if (eq filtros.tipoDocumento "Arrendamientos")}}selected{{/if}}>Arrendamientos</option>
            <option value="Otros" {{#if (eq filtros.tipoDocumento "Otros")}}selected{{/if}}>Otros</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="fechaDesde" class="form-label">Fecha Desde</label>
          <input type="date" class="form-control" id="fechaDesde" name="fechaDesde" value="{{filtros.fechaDesde}}">
        </div>
        <div class="col-md-1 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-search me-1"></i> Buscar
          </button>
        </div>
      </form>
    </div>
    
    <!-- 🎯 TABLA UNIVERSAL ARCHIVO MIS DOCUMENTOS - MIGRACIÓN COMPLETA -->
    <div class="table-responsive">
      <table class="table table-hover tabla-ordenable table-documentos" id="tablaArchivoMisDocumentos">
        <thead>
          <tr>
            <th class="col-codigo ordenable" data-columna="codigoBarras" data-tipo="texto">
              <span>Código</span>
              <i class="fas fa-sort ms-1 sort-icon"></i>
            </th>
            <th class="col-cliente ordenable" data-columna="nombreCliente" data-tipo="texto">
              <span>Cliente</span>
              <i class="fas fa-sort ms-1 sort-icon"></i>
            </th>
            <th class="col-fecha ordenable" data-columna="fechaFactura" data-tipo="fecha">
              <span>Fecha</span>
              <i class="fas fa-sort ms-1 sort-icon"></i>
            </th>
            <th class="col-estado ordenable" data-columna="estado" data-tipo="texto">
              <span>Estado Entrega</span>
              <i class="fas fa-sort ms-1 sort-icon"></i>
            </th>
            <th class="col-pago ordenable" data-columna="estadoPago" data-tipo="texto">
              <span>Estado Pago</span>
              <i class="fas fa-sort ms-1 sort-icon"></i>
            </th>
            <th class="col-valor ordenable" data-columna="valorFactura" data-tipo="numero">
              <span>Valor</span>
              <i class="fas fa-sort ms-1 sort-icon"></i>
            </th>
            <th class="col-acciones">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {{#each documentos}}
          <tr>
            <!-- Código con formato mejorado -->
            <td class="col-codigo">
                <span class="codigo-documento">{{this.codigoBarras}}</span>
                <div class="tipo-documento">
                    <small class="text-muted">{{this.tipoDocumento}}</small>
                </div>
            </td>
            
            <!-- Cliente con formato mejorado (sin truncar) -->
            <td class="col-cliente">
              <div class="cliente-nombre">{{this.nombreCliente}}</div>
              <div class="cliente-identificacion">{{this.identificacionCliente}}</div>
            </td>
            
            <!-- Fecha (sin cambios) -->
            <td class="col-fecha">
              {{#if this.fechaFactura}}
              <span class="fecha-universal">{{formatFechaCorta this.fechaFactura}}</span>
              {{else}}
              <span class="fecha-universal sin-fecha">--/--/--</span>
              {{/if}}
            </td>
            
            <!-- Estado de Entrega (NUEVO BADGE) -->
            <td class="col-estado text-center">
              {{{badgeEstadoEntrega this.estado}}}
            </td>
            
            <!-- Estado de Pago (NUEVO BADGE) -->
            <td class="col-pago text-center">
              {{#if this.numeroFactura}}
                {{{badgeEstadoPago this.estadoPago}}}
              {{else}}
                <span class="badge bg-secondary" title="Documento sin factura asociada">
                    <i class="fas fa-file-invoice-dollar me-1"></i> S/F
                </span>
              {{/if}}
            </td>
            
            <!-- Valor con formato mejorado -->
            <td class="col-valor text-right">
              {{#if this.valorFactura}}
              <span class="valor-monetario">{{formatDineroCompleto this.valorFactura}}</span>
              {{else}}
              <span class="valor-monetario text-muted">$0.00</span>
              {{/if}}
            </td>
            
            <!-- Acciones específicas de ARCHIVO -->
            <td class="col-acciones text-center">
              <div class="btn-group btn-group-sm">
                <!-- Ver Detalle - Siempre disponible -->
                <a href="/archivo/documentos/detalle/{{this.id}}" class="btn btn-outline-primary btn-universal" title="Ver Detalle">
                  <i class="fas fa-eye"></i>
                </a>
                
                <!-- Editar - Solo para documentos en proceso -->
                {{#if (eq this.estado 'en_proceso')}}
                <a href="/archivo/documentos/editar/{{this.id}}" class="btn btn-outline-warning btn-universal" title="Editar">
                  <i class="fas fa-edit"></i>
                </a>
                {{/if}}
                
                <!-- Marcar como Listo - Solo para documentos en proceso -->
                {{#if (eq this.estado 'en_proceso')}}
                <button class="btn btn-outline-success btn-universal" onclick="marcarComoListo({{this.id}})" title="Marcar como Listo">
                  <i class="fas fa-check-circle"></i>
                </button>
                {{/if}}
                
                <!-- Ver Código - Solo para documentos listos -->
                {{#if (eq this.estado 'listo_para_entrega')}}
                <button class="btn btn-outline-info btn-universal" onclick="mostrarCodigo('{{this.codigoVerificacion}}')" title="Ver Código">
                  <i class="fas fa-key"></i>
                </button>
                {{/if}}
                
                <!-- Entregar - Solo para documentos listos -->
                {{#if (eq this.estado 'listo_para_entrega')}}
                <a href="/archivo/documentos/entrega/{{this.id}}" class="btn btn-outline-success btn-universal" title="Entregar">
                  <i class="fas fa-hand-holding"></i>
                </a>
                {{/if}}
              </div>
            </td>
          </tr>
          {{else}}
          <tr>
            <td colspan="7" class="text-center py-5">
              <div class="sin-resultados">
                <i class="fas fa-folder-open fa-2x mb-3 text-muted"></i>
                <h5 class="text-muted">No tienes documentos de archivo asignados</h5>
                <p class="mb-0 text-muted">Los documentos se crean desde caja y se asignan al archivo</p>
              </div>
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
    
    <!-- Paginación -->
    {{#if (gt paginacion.totalPages 1)}}
    <nav aria-label="Paginación de documentos" class="mt-4">
      <div class="row align-items-center">
        <div class="col-md-6">
          <p class="text-muted mb-0">
            Mostrando {{paginacion.totalDocuments}} documentos
            {{#if paginacion.totalPages}}de página {{paginacion.currentPage}} de {{paginacion.totalPages}}{{/if}}
          </p>
        </div>
        <div class="col-md-6">
          <ul class="pagination pagination-sm justify-content-end mb-0">
            {{#if paginacion.hasPrevPage}}
            <li class="page-item">
              <a class="page-link" href="?page={{paginacion.prevPage}}&{{buildQueryString filtros}}" title="Página anterior">
                <i class="fas fa-angle-left"></i>
              </a>
            </li>
            {{else}}
            <li class="page-item disabled">
              <span class="page-link">
                <i class="fas fa-angle-left"></i>
              </span>
            </li>
            {{/if}}
            
            {{#each (range 1 paginacion.totalPages)}}
            <li class="page-item {{#if (eq this ../paginacion.currentPage)}}active{{/if}}">
              <a class="page-link" href="?page={{this}}&{{buildQueryString ../filtros}}">
                {{this}}
              </a>
            </li>
            {{/each}}
            
            {{#if paginacion.hasNextPage}}
            <li class="page-item">
              <a class="page-link" href="?page={{paginacion.nextPage}}&{{buildQueryString filtros}}" title="Página siguiente">
                <i class="fas fa-angle-right"></i>
              </a>
            </li>
            {{else}}
            <li class="page-item disabled">
              <span class="page-link">
                <i class="fas fa-angle-right"></i>
              </span>
            </li>
            {{/if}}
          </ul>
        </div>
      </div>
    </nav>
    {{/if}}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('🎯 Inicializando tabla ARCHIVO MIS DOCUMENTOS - Sistema Universal v1.0');
    
    // Inicializar ordenamiento manual corregido
    inicializarOrdenamientoManual();
    
    console.log('✅ Vista ARCHIVO MIS DOCUMENTOS migrada al sistema universal - Funcionalidad completa');
  });

  // Función de ordenamiento manual específica para ARCHIVO MIS DOCUMENTOS
  function inicializarOrdenamientoManual() {
    console.log('🔧 Inicializando ordenamiento manual para ARCHIVO MIS DOCUMENTOS');
    
    // Buscar todos los headers ordenables
    const headersOrdenables = document.querySelectorAll('.tabla-ordenable th.ordenable');
    
    headersOrdenables.forEach(header => {
      header.style.cursor = 'pointer';
      header.addEventListener('click', function() {
        const columna = this.getAttribute('data-columna');
        const tipoColumna = this.getAttribute('data-tipo') || 'texto';
        
        console.log('📊 Click en columna ARCHIVO MIS DOCUMENTOS:', columna, tipoColumna);
        
        // Obtener dirección actual
        let direccion = 'asc';
        if (this.classList.contains('asc')) {
          direccion = 'desc';
        } else if (this.classList.contains('desc')) {
          direccion = 'asc';
        }
        
        // Limpiar otros headers
        headersOrdenables.forEach(h => {
          h.classList.remove('asc', 'desc', 'active');
          const icono = h.querySelector('.sort-icon');
          if (icono) {
            icono.className = 'fas fa-sort ms-1 sort-icon';
          }
        });
        
        // Marcar header actual
        this.classList.add(direccion, 'active');
        const icono = this.querySelector('.sort-icon');
        if (icono) {
          icono.className = `fas fa-sort-${direccion} ms-1 sort-icon`;
        }
        
        // Ejecutar ordenamiento por servidor
        const params = new URLSearchParams(window.location.search);
        params.set('ordenarPor', columna);
        params.set('ordenDireccion', direccion);
        
        window.location.search = params.toString();
      });
    });
    
    console.log('✅ Ordenamiento manual configurado para ARCHIVO MIS DOCUMENTOS:', headersOrdenables.length, 'columnas');
  }

  // Función para marcar documento como listo
  function marcarComoListo(documentoId) {
    if (!confirm('¿Está seguro de marcar este documento como listo para entrega?\n\nSe generará un código de verificación y se enviará una notificación automática al cliente.')) {
      return;
    }
    
    // Mostrar indicador de carga
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    fetch(`/archivo/documentos/marcar-listo/${documentoId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.exito) {
        // Mostrar código generado
        alert(`✅ Documento marcado como listo exitosamente!\n\n🔑 Código de verificación: ${data.codigoVerificacion}\n\n📱 Se ha enviado notificación automática al cliente.`);
        location.reload();
      } else {
        alert('❌ Error: ' + data.mensaje);
        // Restaurar botón
        button.innerHTML = originalHTML;
        button.disabled = false;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('❌ Error de conexión. Intente nuevamente.');
      // Restaurar botón
      button.innerHTML = originalHTML;
      button.disabled = false;
    });
  }

  // Función para mostrar código de verificación
  function mostrarCodigo(codigo) {
    if (!codigo) {
      alert('⚠️ No hay código de verificación disponible para este documento.');
      return;
    }
    
    alert(`🔑 Código de verificación: ${codigo}\n\n📋 Este código debe proporcionarse al cliente para autorizar la entrega por terceros.\n\n💡 El cliente debe presentar este código junto con su identificación para retirar el documento.`);
  }

  function limpiarFiltrosArchivoMis() {
    document.getElementById('buscar').value = '';
    document.getElementById('estado').value = '';
    document.getElementById('estadoPago').value = '';
    document.getElementById('tipoDocumento').value = '';
    document.getElementById('fechaDesde').value = '';
    document.getElementById('filtrosFormArchivoMis').submit(); 
  }
</script>

{{!-- Estilos específicos --}}
<style>
  .btn-purple {
    background-color: #6f42c1;
    border-color: #6f42c1;
    color: white;
  }
  
  .btn-purple:hover {
    background-color: #5a2d91;
    border-color: #5a2d91;
    color: white;
  }
  
  .text-purple {
    color: #6f42c1 !important;
  }

  /* 🎨 ESTILOS MEJORADOS PARA BADGES DE ESTADO - MIS DOCUMENTOS */
  
  /* Mejoras para badges de estado - tamaños balanceados */
  .badge-estado {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    font-weight: 500;
    border-radius: 0.375rem;
    display: inline-block;
    text-align: center;
    line-height: 1.2;
  }
  
  /* Tamaños específicos por longitud de texto */
  .badge-estado-corto {
    min-width: 70px;    /* LISTO, PAGADO */
  }
  
  .badge-estado-medio {
    min-width: 85px;    /* PENDIENTE, PROCESO */
  }
  
  .badge-estado-largo {
    min-width: 80px !important;    /* ENTREGADO, CON RETENCIÓN - OPTIMIZADO */
    font-size: 0.7rem !important;  /* Fuente mejorada para mejor legibilidad */
    padding: 0.3rem 0.5rem !important; /* Padding reducido */
  }

  /* 🔧 CORRECCIÓN ESPECÍFICA PARA BADGES ENTREGADO EN MIS DOCUMENTOS */
  table.tabla-ordenable .badge-estado-largo,
  .table .badge-estado-largo,
  span.badge.badge-estado.badge-estado-largo {
    min-width: 80px !important;
    font-size: 0.7rem !important;
    padding: 0.3rem 0.5rem !important;
  }
  
  .badge-tipo {
    min-width: 80px;
    font-size: 0.7rem;
  }
  
  /* Mejoras a la tabla para mejor balance visual */
  .columna-estado {
    width: 120px;
    text-align: center;
  }
  
  /* Estilos mejorados para headers ordenables */
  .tabla-ordenable th.ordenable {
    cursor: pointer !important;
    user-select: none;
    position: relative;
    transition: background-color 0.2s ease;
  }
  
  .tabla-ordenable th.ordenable:hover {
    background-color: rgba(0, 0, 0, 0.05) !important;
  }
  
  .tabla-ordenable th.ordenable i {
    opacity: 0.6;
    transition: all 0.2s ease;
  }
  
  .tabla-ordenable th.ordenable:hover i {
    opacity: 1;
  }
  
  .tabla-ordenable th.ordenable[data-orden="asc"] i.fa-sort-up,
  .tabla-ordenable th.ordenable[data-orden="desc"] i.fa-sort-down {
    opacity: 1;
    color: #6f42c1 !important;
    transform: scale(1.1);
  }
  
  /* Mejorar visibilidad de botones de acción */
  .btn-group-sm .btn {
    padding: 0.375rem 0.5rem;
    font-size: 0.875rem;
    margin: 0 1px;
  }
  
  /* Efectos hover para botones */
  .btn-outline-primary:hover {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
  }
  
  .btn-outline-success:hover {
    background-color: #198754;
    border-color: #198754;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(25, 135, 84, 0.3);
  }
  
  .btn-outline-warning:hover {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #000;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
  }
  
  .btn-outline-info:hover {
    background-color: #0dcaf0;
    border-color: #0dcaf0;
    color: #000;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(13, 202, 240, 0.3);
  }
  
  /* Espaciado para badges mejorados */
  .badge {
    font-weight: 600;
    font-size: 0.85em;
    padding: 0.5em 0.75em;
    border-radius: 0.5rem;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  
  .badge i {
    font-size: 0.9em;
    margin-right: 0.25rem;
  }
  
  /* Colores específicos para estados de pago */
  .badge.bg-success {
    background-color: #198754 !important;
    color: white;
    box-shadow: 0 2px 4px rgba(25, 135, 84, 0.3);
  }
  
  .badge.bg-danger {
    background-color: #dc3545 !important;
    color: white;
    box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
  }
  
  .badge.bg-warning {
    background-color: #fd7e14 !important;
    color: white;
    box-shadow: 0 2px 4px rgba(253, 126, 20, 0.3);
  }
  
  .badge.bg-info {
    background-color: #0dcaf0 !important;
    color: #000;
    box-shadow: 0 2px 4px rgba(13, 202, 240, 0.3);
  }
  
  .badge.bg-primary {
    background-color: #0d6efd !important;
    color: white;
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
  }
  
  .badge.bg-secondary {
    background-color: #6c757d !important;
    color: white;
    box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
  }
  
  /* Animación para botones con spinner */
  .btn .fa-spinner {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Mejorar tabla responsiva */
  .table-responsive {
    border-radius: 0.5rem;
  }
  
  .table th {
    border-top: none;
    font-weight: 600;
    background-color: #f8f9fa;
    color: #495057;
  }
  
  .table td {
    vertical-align: middle;
  }
  
  /* Mejorar enlaces de código de barras */
  .table td a {
    transition: color 0.2s ease;
  }
  
  .table td a:hover {
    color: #6f42c1 !important;
    text-decoration: underline !important;
  }
</style>

 