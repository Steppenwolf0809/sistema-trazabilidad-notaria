{{!-- Vista de Mis Documentos para rol Archivo --}}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>
        <i class="fas fa-folder-open me-2 text-purple"></i> Mis Documentos de Archivo
      </h2>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/archivo">Dashboard</a></li>
          <li class="breadcrumb-item active">Mis Documentos</li>
        </ol>
      </nav>
    </div>
    <!-- Bot√≥n eliminado - Los documentos se crean desde caja -->
  </div>

  {{!-- Filtros --}}
  <div class="card mb-4">
    <div class="card-body">
      <form method="GET" action="/archivo/documentos/mis-documentos" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Buscar</label>
          <input type="text" name="buscar" class="form-control" value="{{filtros.buscar}}" 
                 placeholder="C√≥digo, cliente, identificaci√≥n...">
        </div>
        <div class="col-md-2">
          <label class="form-label">Estado</label>
          <select name="estado" class="form-select">
            <option value="">Todos</option>
            <option value="en_proceso" {{#if (eq filtros.estado "en_proceso")}}selected{{/if}}>En Proceso</option>
            <option value="listo_para_entrega" {{#if (eq filtros.estado "listo_para_entrega")}}selected{{/if}}>Listo</option>
            <option value="entregado" {{#if (eq filtros.estado "entregado")}}selected{{/if}}>Entregado</option>
            <option value="cancelado" {{#if (eq filtros.estado "cancelado")}}selected{{/if}}>Cancelado</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Estado de Pago</label>
          <select name="estadoPago" class="form-select">
            <option value="">Todos</option>
            <option value="pendiente" {{#if (eq filtros.estadoPago "pendiente")}}selected{{/if}}>Pendiente</option>
            <option value="pago_parcial" {{#if (eq filtros.estadoPago "pago_parcial")}}selected{{/if}}>Pago Parcial</option>
            <option value="pagado_completo" {{#if (eq filtros.estadoPago "pagado_completo")}}selected{{/if}}>Pagado Completo</option>
            <option value="pagado_con_retencion" {{#if (eq filtros.estadoPago "pagado_con_retencion")}}selected{{/if}}>Pagado con Retenci√≥n</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Tipo</label>
          <select name="tipoDocumento" class="form-select">
            <option value="">Todos</option>
            <option value="Protocolo" {{#if (eq filtros.tipoDocumento "Protocolo")}}selected{{/if}}>Protocolo</option>
            <option value="Diligencias" {{#if (eq filtros.tipoDocumento "Diligencias")}}selected{{/if}}>Diligencias</option>
            <option value="Certificaciones" {{#if (eq filtros.tipoDocumento "Certificaciones")}}selected{{/if}}>Certificaciones</option>
            <option value="Arrendamientos" {{#if (eq filtros.tipoDocumento "Arrendamientos")}}selected{{/if}}>Arrendamientos</option>
            <option value="Otros" {{#if (eq filtros.tipoDocumento "Otros")}}selected{{/if}}>Otros</option>
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary me-2">
            <i class="fas fa-search me-1"></i> Buscar
          </button>
          <a href="/archivo/documentos/mis-documentos" class="btn btn-outline-secondary">
            <i class="fas fa-times me-1"></i> Limpiar
          </a>
        </div>
      </form>
    </div>
  </div>

  {{!-- Tabla de documentos --}}
  <div class="card">
    <div class="card-body p-0">
      {{#if documentos.length}}
        <div class="table-responsive">
          <table class="table table-hover mb-0 tabla-ordenable" id="tablaMisDocumentosArchivo">
            <thead class="table-light">
              <tr>
                <th class="ordenable" data-columna="codigoBarras" data-tipo="texto" style="width: 150px;">
                  <span>N√∫mero Documento</span>
                  <i class="fas fa-sort ms-1"></i>
                </th>
                <th class="ordenable" data-columna="tipoDocumento" data-tipo="texto">
                  <span>Tipo</span>
                  <i class="fas fa-sort ms-1"></i>
                </th>
                <th class="ordenable" data-columna="nombreCliente" data-tipo="texto">
                  <span>Cliente</span>
                  <i class="fas fa-sort ms-1"></i>
                </th>
                <th class="ordenable" data-columna="identificacionCliente" data-tipo="texto">
                  <span>Identificaci√≥n</span>
                  <i class="fas fa-sort ms-1"></i>
                </th>
                <th class="ordenable" data-columna="valorFactura" data-tipo="numero">
                  <span>Valor</span>
                  <i class="fas fa-sort ms-1"></i>
                </th>
                <th class="ordenable" data-columna="estadoPago" data-tipo="estado">
                  <span>Estado Pago</span>
                  <i class="fas fa-sort ms-1"></i>
                </th>
                <th class="ordenable" data-columna="estado" data-tipo="estado">
                  <span>Estado</span>
                  <i class="fas fa-sort ms-1"></i>
                </th>
                <th class="ordenable" data-columna="updated_at" data-tipo="fecha">
                  <span>√öltima Actualizaci√≥n</span>
                  <i class="fas fa-sort ms-1"></i>
                </th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {{#each documentos}}
                <tr>
                  <td>
                    <a href="/archivo/documentos/detalle/{{this.id}}" class="fw-bold text-decoration-none" style="font-size: 1.1em;">
                      {{this.codigoBarras}}
                    </a>
                  </td>
                  <td>
                    <span class="badge badge-estado badge-tipo bg-info">{{this.tipoDocumento}}</span>
                  </td>
                  <td>{{this.nombreCliente}}</td>
                  <td>{{this.identificacionCliente}}</td>
                  <td>${{formatMoney this.valorFactura}}</td>
                  <td class="columna-estado">
                    {{#if (eq this.estadoPago "pendiente")}}
                      <span class="badge badge-estado badge-estado-medio bg-danger">
                        <i class="fas fa-clock me-1"></i>Pendiente
                      </span>
                    {{else if (eq this.estadoPago "pago_parcial")}}
                      <span class="badge badge-estado badge-estado-largo bg-warning text-dark">
                        <i class="fas fa-coins me-1"></i>Pago Parcial
                      </span>
                    {{else if (eq this.estadoPago "pagado_completo")}}
                      <span class="badge badge-estado badge-estado-largo bg-success">
                        <i class="fas fa-check-circle me-1"></i>Pagado Completo
                      </span>
                    {{else if (eq this.estadoPago "pagado_con_retencion")}}
                      <span class="badge badge-estado badge-estado-largo bg-info">
                        <i class="fas fa-receipt me-1"></i>Pagado con Retenci√≥n
                      </span>
                    {{else}}
                      <span class="badge badge-estado bg-secondary">
                        <i class="fas fa-question-circle me-1"></i>{{this.estadoPago}}
                      </span>
                    {{/if}}
                  </td>
                  <td class="columna-estado">
                    {{#if (eq this.estado "en_proceso")}}
                      <span class="badge badge-estado badge-estado-medio bg-warning text-dark">En Proceso</span>
                    {{else if (eq this.estado "listo_para_entrega")}}
                      <span class="badge badge-estado badge-estado-corto bg-success">Listo</span>
                    {{else if (eq this.estado "entregado")}}
                      <span class="badge badge-estado badge-estado-largo bg-primary">Entregado</span>
                    {{else if (eq this.estado "cancelado")}}
                      <span class="badge badge-estado badge-estado-medio bg-danger">Cancelado</span>
                    {{else}}
                      <span class="badge badge-estado bg-secondary">{{this.estado}}</span>
                    {{/if}}
                  </td>
                  <td data-sort-value="{{this.updated_at}}">{{formatDateTime this.updated_at}}</td>
                  <td class="text-center">
                    {{#if (eq ../userRole "archivo")}}
                        {{! Solo mostrar botones si es el usuario archivo }}
                        <div class="btn-group btn-group-sm" role="group" aria-label="Acciones del documento">
                            <!-- Bot√≥n Ver Detalle - Siempre disponible -->
                            <a href="/archivo/documentos/detalle/{{this.id}}" 
                               class="btn btn-outline-info btn-sm" 
                               title="Ver detalle completo"
                               data-bs-toggle="tooltip">
                                <i class="fas fa-eye"></i>
                            </a>
                            
                            <!-- Bot√≥n Editar - Solo para documentos en proceso -->
                            {{#if (eq this.estado "en_proceso")}}
                            <a href="/archivo/documentos/editar/{{this.id}}" 
                               class="btn btn-outline-primary btn-sm" 
                               title="Editar documento"
                               data-bs-toggle="tooltip">
                                <i class="fas fa-edit"></i>
                            </a>
                            {{/if}}
                            
                            <!-- Bot√≥n Marcar como Listo - Solo para documentos en proceso -->
                            {{#if (eq this.estado "en_proceso")}}
                            <button type="button" 
                                    class="btn btn-outline-success btn-sm" 
                                    onclick="marcarListo({{this.id}})" 
                                    title="Marcar como listo para entrega"
                                    data-bs-toggle="tooltip">
                                <i class="fas fa-check-circle"></i>
                            </button>
                            {{/if}}
                            
                            <!-- Bot√≥n Ver C√≥digo - Solo para documentos listos -->
                            {{#if (eq this.estado "listo_para_entrega")}}
                            <button type="button" 
                                    class="btn btn-outline-info btn-sm" 
                                    onclick="mostrarCodigo('{{this.codigoVerificacion}}')" 
                                    title="Ver c√≥digo de verificaci√≥n"
                                    data-bs-toggle="tooltip">
                                <i class="fas fa-key"></i>
                            </button>
                            {{/if}}
                            
                            <!-- Bot√≥n Entregar - Solo para documentos listos -->
                            {{#if (eq this.estado "listo_para_entrega")}}
                            <a href="/archivo/documentos/entrega/{{this.id}}" 
                               class="btn btn-outline-warning btn-sm" 
                               title="Proceder con entrega"
                               data-bs-toggle="tooltip">
                                <i class="fas fa-hand-holding"></i>
                            </a>
                            {{/if}}
                            
                            <!-- Para documentos entregados - Solo ver detalles -->
                            {{#if (eq this.estado "entregado")}}
                            <span class="badge bg-success">
                                <i class="fas fa-check-double me-1"></i>Entregado
                            </span>
                            {{/if}}
                        </div>
                    {{else}}
                        <span class="badge bg-secondary">Solo lectura</span>
                    {{/if}}
                  </td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        </div>

        {{!-- Paginaci√≥n --}}
        {{#if (gt paginacion.totalPages 1)}}
          <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">
                Mostrando {{paginacion.totalDocuments}} documentos
              </small>
              <nav>
                <ul class="pagination pagination-sm mb-0">
                  {{#if paginacion.hasPrevPage}}
                    <li class="page-item">
                      <a class="page-link" href="?page={{paginacion.prevPage}}{{#if filtros.buscar}}&buscar={{filtros.buscar}}{{/if}}{{#if filtros.estado}}&estado={{filtros.estado}}{{/if}}{{#if filtros.estadoPago}}&estadoPago={{filtros.estadoPago}}{{/if}}{{#if filtros.tipoDocumento}}&tipoDocumento={{filtros.tipoDocumento}}{{/if}}">Anterior</a>
                    </li>
                  {{/if}}
                  
                  {{#each (range 1 paginacion.totalPages)}}
                    <li class="page-item {{#if (eq this ../paginacion.currentPage)}}active{{/if}}">
                      <a class="page-link" href="?page={{this}}{{#if ../filtros.buscar}}&buscar={{../filtros.buscar}}{{/if}}{{#if ../filtros.estado}}&estado={{../filtros.estado}}{{/if}}{{#if ../filtros.estadoPago}}&estadoPago={{../filtros.estadoPago}}{{/if}}{{#if ../filtros.tipoDocumento}}&tipoDocumento={{../filtros.tipoDocumento}}{{/if}}">{{this}}</a>
                    </li>
                  {{/each}}
                  
                  {{#if paginacion.hasNextPage}}
                    <li class="page-item">
                      <a class="page-link" href="?page={{paginacion.nextPage}}{{#if filtros.buscar}}&buscar={{filtros.buscar}}{{/if}}{{#if filtros.estado}}&estado={{filtros.estado}}{{/if}}{{#if filtros.estadoPago}}&estadoPago={{filtros.estadoPago}}{{/if}}{{#if filtros.tipoDocumento}}&tipoDocumento={{filtros.tipoDocumento}}{{/if}}">Siguiente</a>
                    </li>
                  {{/if}}
                </ul>
              </nav>
            </div>
          </div>
        {{/if}}
      {{else}}
        <div class="text-center py-5">
          <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">No tienes documentos de archivo asignados</h5>
          <p class="text-muted">Los documentos se crean desde el m√≥dulo de caja y luego se asignan al archivo.</p>
        </div>
      {{/if}}
    </div>
  </div>
</div>

<script>
// Funci√≥n para marcar documento como listo
function marcarListo(documentoId) {
  if (!confirm('¬øEst√° seguro de marcar este documento como listo para entrega?\n\nSe generar√° un c√≥digo de verificaci√≥n y se enviar√° una notificaci√≥n autom√°tica al cliente.')) {
    return;
  }
  
  // Mostrar indicador de carga
  const button = event.target.closest('button');
  const originalHTML = button.innerHTML;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  button.disabled = true;
  
  fetch(`/archivo/documentos/marcar-listo/${documentoId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.exito) {
      // Mostrar c√≥digo generado
      alert(`‚úÖ Documento marcado como listo exitosamente!\n\nüîë C√≥digo de verificaci√≥n: ${data.codigoVerificacion}\n\nüì± Se ha enviado notificaci√≥n autom√°tica al cliente.`);
      location.reload();
    } else {
      alert('‚ùå Error: ' + data.mensaje);
      // Restaurar bot√≥n
      button.innerHTML = originalHTML;
      button.disabled = false;
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('‚ùå Error de conexi√≥n. Intente nuevamente.');
    // Restaurar bot√≥n
    button.innerHTML = originalHTML;
    button.disabled = false;
  });
}

// Funci√≥n para mostrar c√≥digo de verificaci√≥n
function mostrarCodigo(codigo) {
  if (!codigo) {
    alert('‚ö†Ô∏è No hay c√≥digo de verificaci√≥n disponible para este documento.');
    return;
  }
  
  alert(`üîë C√≥digo de verificaci√≥n: ${codigo}\n\nüìã Este c√≥digo debe proporcionarse al cliente para autorizar la entrega por terceros.\n\nüí° El cliente debe presentar este c√≥digo junto con su identificaci√≥n para retirar el documento.`);
}

// Funci√≥n para entregar documento (mantenida para compatibilidad)
function entregarDocumento(documentoId) {
  window.location.href = `/archivo/documentos/entrega/${documentoId}`;
}

// Inicializar tooltips y ordenamiento cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', function() {
  console.log('üóÇÔ∏è Inicializando vista mis documentos de archivo con ordenamiento mejorado');
  
  // Inicializar ordenamiento de tablas
  if (typeof inicializarOrdenamientoTablas === 'function') {
    inicializarOrdenamientoTablas();
    console.log('‚úÖ Ordenamiento de tablas inicializado para mis documentos');
  } else {
    console.warn('‚ö†Ô∏è Funci√≥n inicializarOrdenamientoTablas no encontrada');
  }
  
  // üîß CORRECCI√ìN AUTOM√ÅTICA DE BADGES ENTREGADO
  function corregirBadgesEntregado() {
    const badges = document.querySelectorAll('.badge');
    let badgesCorregidos = 0;
    
    badges.forEach(badge => {
      const texto = badge.textContent.trim().toLowerCase();
      if (texto.includes('entregado') || texto.includes('con retenci√≥n') || texto.includes('pagado completo')) {
        // Aplicar estilos optimizados
        badge.style.minWidth = '80px';
        badge.style.fontSize = '0.7rem';
        badge.style.padding = '0.3rem 0.5rem';
        badgesCorregidos++;
        console.log('üîß Badge corregido:', texto);
      }
    });
    
    if (badgesCorregidos > 0) {
      console.log(`‚úÖ Se corrigieron ${badgesCorregidos} badges en mis documentos`);
    }
  }
  
  // Ejecutar correcci√≥n inmediatamente
  corregirBadgesEntregado();
  
  // Observar cambios din√°micos en la tabla
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'childList') {
        corregirBadgesEntregado();
      }
    });
  });
  
  const tabla = document.querySelector('#tablaMisDocumentosArchivo');
  if (tabla) {
    observer.observe(tabla, { childList: true, subtree: true });
  }

  // Activar tooltips de Bootstrap
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  
  console.log('‚úÖ Vista mis documentos de archivo cargada correctamente - Tooltips, ordenamiento y badges optimizados');
});
</script>

{{!-- Estilos espec√≠ficos --}}
<style>
  .btn-purple {
    background-color: #6f42c1;
    border-color: #6f42c1;
    color: white;
  }
  
  .btn-purple:hover {
    background-color: #5a2d91;
    border-color: #5a2d91;
    color: white;
  }
  
  .text-purple {
    color: #6f42c1 !important;
  }

  /* üé® ESTILOS MEJORADOS PARA BADGES DE ESTADO - MIS DOCUMENTOS */
  
  /* Mejoras para badges de estado - tama√±os balanceados */
  .badge-estado {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    font-weight: 500;
    border-radius: 0.375rem;
    display: inline-block;
    text-align: center;
    line-height: 1.2;
  }
  
  /* Tama√±os espec√≠ficos por longitud de texto */
  .badge-estado-corto {
    min-width: 70px;    /* LISTO, PAGADO */
  }
  
  .badge-estado-medio {
    min-width: 85px;    /* PENDIENTE, PROCESO */
  }
  
  .badge-estado-largo {
    min-width: 80px !important;    /* ENTREGADO, CON RETENCI√ìN - OPTIMIZADO */
    font-size: 0.7rem !important;  /* Fuente mejorada para mejor legibilidad */
    padding: 0.3rem 0.5rem !important; /* Padding reducido */
  }

  /* üîß CORRECCI√ìN ESPEC√çFICA PARA BADGES ENTREGADO EN MIS DOCUMENTOS */
  table.tabla-ordenable .badge-estado-largo,
  .table .badge-estado-largo,
  span.badge.badge-estado.badge-estado-largo {
    min-width: 80px !important;
    font-size: 0.7rem !important;
    padding: 0.3rem 0.5rem !important;
  }
  
  .badge-tipo {
    min-width: 80px;
    font-size: 0.7rem;
  }
  
  /* Mejoras a la tabla para mejor balance visual */
  .columna-estado {
    width: 120px;
    text-align: center;
  }
  
  /* Estilos mejorados para headers ordenables */
  .tabla-ordenable th.ordenable {
    cursor: pointer !important;
    user-select: none;
    position: relative;
    transition: background-color 0.2s ease;
  }
  
  .tabla-ordenable th.ordenable:hover {
    background-color: rgba(0, 0, 0, 0.05) !important;
  }
  
  .tabla-ordenable th.ordenable i {
    opacity: 0.6;
    transition: all 0.2s ease;
  }
  
  .tabla-ordenable th.ordenable:hover i {
    opacity: 1;
  }
  
  .tabla-ordenable th.ordenable[data-orden="asc"] i.fa-sort-up,
  .tabla-ordenable th.ordenable[data-orden="desc"] i.fa-sort-down {
    opacity: 1;
    color: #6f42c1 !important;
    transform: scale(1.1);
  }
  
  /* Mejorar visibilidad de botones de acci√≥n */
  .btn-group-sm .btn {
    padding: 0.375rem 0.5rem;
    font-size: 0.875rem;
    margin: 0 1px;
  }
  
  /* Efectos hover para botones */
  .btn-outline-primary:hover {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
  }
  
  .btn-outline-success:hover {
    background-color: #198754;
    border-color: #198754;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(25, 135, 84, 0.3);
  }
  
  .btn-outline-warning:hover {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #000;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
  }
  
  .btn-outline-info:hover {
    background-color: #0dcaf0;
    border-color: #0dcaf0;
    color: #000;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(13, 202, 240, 0.3);
  }
  
  /* Espaciado para badges mejorados */
  .badge {
    font-weight: 600;
    font-size: 0.85em;
    padding: 0.5em 0.75em;
    border-radius: 0.5rem;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  
  .badge i {
    font-size: 0.9em;
    margin-right: 0.25rem;
  }
  
  /* Colores espec√≠ficos para estados de pago */
  .badge.bg-success {
    background-color: #198754 !important;
    color: white;
    box-shadow: 0 2px 4px rgba(25, 135, 84, 0.3);
  }
  
  .badge.bg-danger {
    background-color: #dc3545 !important;
    color: white;
    box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
  }
  
  .badge.bg-warning {
    background-color: #fd7e14 !important;
    color: white;
    box-shadow: 0 2px 4px rgba(253, 126, 20, 0.3);
  }
  
  .badge.bg-info {
    background-color: #0dcaf0 !important;
    color: #000;
    box-shadow: 0 2px 4px rgba(13, 202, 240, 0.3);
  }
  
  .badge.bg-primary {
    background-color: #0d6efd !important;
    color: white;
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
  }
  
  .badge.bg-secondary {
    background-color: #6c757d !important;
    color: white;
    box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
  }
  
  /* Animaci√≥n para botones con spinner */
  .btn .fa-spinner {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Mejorar tabla responsiva */
  .table-responsive {
    border-radius: 0.5rem;
  }
  
  .table th {
    border-top: none;
    font-weight: 600;
    background-color: #f8f9fa;
    color: #495057;
  }
  
  .table td {
    vertical-align: middle;
  }
  
  /* Mejorar enlaces de c√≥digo de barras */
  .table td a {
    transition: color 0.2s ease;
  }
  
  .table td a:hover {
    color: #6f42c1 !important;
    text-decoration: underline !important;
  }
</style>

 