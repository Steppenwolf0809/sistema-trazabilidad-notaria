{{!-- Vista de Mis Documentos para rol Archivo --}}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>
        <i class="fas fa-folder-open me-2 text-purple"></i> Mis Documentos de Archivo
      </h2>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/archivo">Dashboard</a></li>
          <li class="breadcrumb-item active">Mis Documentos</li>
        </ol>
      </nav>
    </div>
    <!-- Botón eliminado - Los documentos se crean desde caja -->
  </div>

  {{!-- Filtros --}}
  <div class="card mb-4">
    <div class="card-body">
      <form method="GET" action="/archivo/documentos/mis-documentos" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Buscar</label>
          <input type="text" name="buscar" class="form-control" value="{{filtros.buscar}}" 
                 placeholder="Código, cliente, identificación...">
        </div>
        <div class="col-md-2">
          <label class="form-label">Estado</label>
          <select name="estado" class="form-select">
            <option value="">Todos</option>
            <option value="en_proceso" {{#if (eq filtros.estado "en_proceso")}}selected{{/if}}>En Proceso</option>
            <option value="listo_para_entrega" {{#if (eq filtros.estado "listo_para_entrega")}}selected{{/if}}>Listo</option>
            <option value="entregado" {{#if (eq filtros.estado "entregado")}}selected{{/if}}>Entregado</option>
            <option value="cancelado" {{#if (eq filtros.estado "cancelado")}}selected{{/if}}>Cancelado</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Estado de Pago</label>
          <select name="estadoPago" class="form-select">
            <option value="">Todos</option>
            <option value="pendiente" {{#if (eq filtros.estadoPago "pendiente")}}selected{{/if}}>Pendiente</option>
            <option value="pago_parcial" {{#if (eq filtros.estadoPago "pago_parcial")}}selected{{/if}}>Pago Parcial</option>
            <option value="pagado_completo" {{#if (eq filtros.estadoPago "pagado_completo")}}selected{{/if}}>Pagado Completo</option>
            <option value="pagado_con_retencion" {{#if (eq filtros.estadoPago "pagado_con_retencion")}}selected{{/if}}>Pagado con Retención</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Tipo</label>
          <select name="tipoDocumento" class="form-select">
            <option value="">Todos</option>
            <option value="Protocolo" {{#if (eq filtros.tipoDocumento "Protocolo")}}selected{{/if}}>Protocolo</option>
            <option value="Diligencias" {{#if (eq filtros.tipoDocumento "Diligencias")}}selected{{/if}}>Diligencias</option>
            <option value="Certificaciones" {{#if (eq filtros.tipoDocumento "Certificaciones")}}selected{{/if}}>Certificaciones</option>
            <option value="Arrendamientos" {{#if (eq filtros.tipoDocumento "Arrendamientos")}}selected{{/if}}>Arrendamientos</option>
            <option value="Otros" {{#if (eq filtros.tipoDocumento "Otros")}}selected{{/if}}>Otros</option>
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary me-2">
            <i class="fas fa-search me-1"></i> Buscar
          </button>
          <a href="/archivo/documentos/mis-documentos" class="btn btn-outline-secondary">
            <i class="fas fa-times me-1"></i> Limpiar
          </a>
        </div>
      </form>
    </div>
  </div>

  {{!-- Tabla de documentos --}}
  <div class="card">
    <div class="card-body p-0">
      {{#if documentos.length}}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 150px;">Número Documento</th>
                <th>Tipo</th>
                <th>Cliente</th>
                <th>Identificación</th>
                <th>Valor</th>
                <th>Estado Pago</th>
                <th>Estado</th>
                <th>Última Actualización</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {{#each documentos}}
                <tr>
                  <td>
                    <a href="/archivo/documentos/detalle/{{this.id}}" class="fw-bold text-decoration-none" style="font-size: 1.1em;">
                      {{this.codigoBarras}}
                    </a>
                  </td>
                  <td>
                    <span class="badge bg-info">{{this.tipoDocumento}}</span>
                  </td>
                  <td>{{this.nombreCliente}}</td>
                  <td>{{this.identificacionCliente}}</td>
                  <td>${{formatMoney this.valorFactura}}</td>
                  <td>
                    {{#if (eq this.estadoPago "pendiente")}}
                      <span class="badge bg-danger">
                        <i class="fas fa-clock me-1"></i>Pendiente
                      </span>
                    {{else if (eq this.estadoPago "pago_parcial")}}
                      <span class="badge bg-warning">
                        <i class="fas fa-coins me-1"></i>Pago Parcial
                      </span>
                    {{else if (eq this.estadoPago "pagado_completo")}}
                      <span class="badge bg-success">
                        <i class="fas fa-check-circle me-1"></i>Pagado Completo
                      </span>
                    {{else if (eq this.estadoPago "pagado_con_retencion")}}
                      <span class="badge bg-info">
                        <i class="fas fa-receipt me-1"></i>Pagado con Retención
                      </span>
                    {{else}}
                      <span class="badge bg-secondary">
                        <i class="fas fa-question-circle me-1"></i>{{this.estadoPago}}
                      </span>
                    {{/if}}
                  </td>
                  <td>
                    {{#if (eq this.estado "en_proceso")}}
                      <span class="badge bg-warning">En Proceso</span>
                    {{else if (eq this.estado "listo_para_entrega")}}
                      <span class="badge bg-success">Listo</span>
                    {{else if (eq this.estado "entregado")}}
                      <span class="badge bg-primary">Entregado</span>
                    {{else if (eq this.estado "cancelado")}}
                      <span class="badge bg-danger">Cancelado</span>
                    {{else}}
                      <span class="badge bg-secondary">{{this.estado}}</span>
                    {{/if}}
                  </td>
                  <td>{{formatDateTime this.updated_at}}</td>
                  <td class="text-center">
                    {{#if (eq ../userRole "archivo")}}
                        {{! Solo mostrar botones si es el usuario archivo }}
                        <div class="btn-group btn-group-sm" role="group" aria-label="Acciones del documento">
                            <!-- Botón Ver Detalle - Siempre disponible -->
                            <a href="/archivo/documentos/detalle/{{this.id}}" 
                               class="btn btn-outline-info btn-sm" 
                               title="Ver detalle completo"
                               data-bs-toggle="tooltip">
                                <i class="fas fa-eye"></i>
                            </a>
                            
                            <!-- Botón Editar - Solo para documentos en proceso -->
                            {{#if (eq this.estado "en_proceso")}}
                            <a href="/archivo/documentos/editar/{{this.id}}" 
                               class="btn btn-outline-primary btn-sm" 
                               title="Editar documento"
                               data-bs-toggle="tooltip">
                                <i class="fas fa-edit"></i>
                            </a>
                            {{/if}}
                            
                            <!-- Botón Marcar como Listo - Solo para documentos en proceso -->
                            {{#if (eq this.estado "en_proceso")}}
                            <button type="button" 
                                    class="btn btn-outline-success btn-sm" 
                                    onclick="marcarListo({{this.id}})" 
                                    title="Marcar como listo para entrega"
                                    data-bs-toggle="tooltip">
                                <i class="fas fa-check-circle"></i>
                            </button>
                            {{/if}}
                            
                            <!-- Botón Ver Código - Solo para documentos listos -->
                            {{#if (eq this.estado "listo_para_entrega")}}
                            <button type="button" 
                                    class="btn btn-outline-info btn-sm" 
                                    onclick="mostrarCodigo('{{this.codigoVerificacion}}')" 
                                    title="Ver código de verificación"
                                    data-bs-toggle="tooltip">
                                <i class="fas fa-key"></i>
                            </button>
                            {{/if}}
                            
                            <!-- Botón Entregar - Solo para documentos listos -->
                            {{#if (eq this.estado "listo_para_entrega")}}
                            <a href="/archivo/documentos/entrega/{{this.id}}" 
                               class="btn btn-outline-warning btn-sm" 
                               title="Proceder con entrega"
                               data-bs-toggle="tooltip">
                                <i class="fas fa-hand-holding"></i>
                            </a>
                            {{/if}}
                            
                            <!-- Para documentos entregados - Solo ver detalles -->
                            {{#if (eq this.estado "entregado")}}
                            <span class="badge bg-success">
                                <i class="fas fa-check-double me-1"></i>Entregado
                            </span>
                            {{/if}}
                        </div>
                    {{else}}
                        <span class="badge bg-secondary">Solo lectura</span>
                    {{/if}}
                  </td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        </div>

        {{!-- Paginación --}}
        {{#if (gt paginacion.totalPages 1)}}
          <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">
                Mostrando {{paginacion.totalDocuments}} documentos
              </small>
              <nav>
                <ul class="pagination pagination-sm mb-0">
                  {{#if paginacion.hasPrevPage}}
                    <li class="page-item">
                      <a class="page-link" href="?page={{paginacion.prevPage}}{{#if filtros.buscar}}&buscar={{filtros.buscar}}{{/if}}{{#if filtros.estado}}&estado={{filtros.estado}}{{/if}}{{#if filtros.estadoPago}}&estadoPago={{filtros.estadoPago}}{{/if}}{{#if filtros.tipoDocumento}}&tipoDocumento={{filtros.tipoDocumento}}{{/if}}">Anterior</a>
                    </li>
                  {{/if}}
                  
                  {{#each (range 1 paginacion.totalPages)}}
                    <li class="page-item {{#if (eq this ../paginacion.currentPage)}}active{{/if}}">
                      <a class="page-link" href="?page={{this}}{{#if ../filtros.buscar}}&buscar={{../filtros.buscar}}{{/if}}{{#if ../filtros.estado}}&estado={{../filtros.estado}}{{/if}}{{#if ../filtros.estadoPago}}&estadoPago={{../filtros.estadoPago}}{{/if}}{{#if ../filtros.tipoDocumento}}&tipoDocumento={{../filtros.tipoDocumento}}{{/if}}">{{this}}</a>
                    </li>
                  {{/each}}
                  
                  {{#if paginacion.hasNextPage}}
                    <li class="page-item">
                      <a class="page-link" href="?page={{paginacion.nextPage}}{{#if filtros.buscar}}&buscar={{filtros.buscar}}{{/if}}{{#if filtros.estado}}&estado={{filtros.estado}}{{/if}}{{#if filtros.estadoPago}}&estadoPago={{filtros.estadoPago}}{{/if}}{{#if filtros.tipoDocumento}}&tipoDocumento={{filtros.tipoDocumento}}{{/if}}">Siguiente</a>
                    </li>
                  {{/if}}
                </ul>
              </nav>
            </div>
          </div>
        {{/if}}
      {{else}}
        <div class="text-center py-5">
          <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">No tienes documentos de archivo asignados</h5>
          <p class="text-muted">Los documentos se crean desde el módulo de caja y luego se asignan al archivo.</p>
        </div>
      {{/if}}
    </div>
  </div>
</div>

<script>
// Función para marcar documento como listo
function marcarListo(documentoId) {
  if (!confirm('¿Está seguro de marcar este documento como listo para entrega?\n\nSe generará un código de verificación y se enviará una notificación automática al cliente.')) {
    return;
  }
  
  // Mostrar indicador de carga
  const button = event.target.closest('button');
  const originalHTML = button.innerHTML;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  button.disabled = true;
  
  fetch(`/archivo/documentos/marcar-listo/${documentoId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.exito) {
      // Mostrar código generado
      alert(`✅ Documento marcado como listo exitosamente!\n\n🔑 Código de verificación: ${data.codigoVerificacion}\n\n📱 Se ha enviado notificación automática al cliente.`);
      location.reload();
    } else {
      alert('❌ Error: ' + data.mensaje);
      // Restaurar botón
      button.innerHTML = originalHTML;
      button.disabled = false;
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('❌ Error de conexión. Intente nuevamente.');
    // Restaurar botón
    button.innerHTML = originalHTML;
    button.disabled = false;
  });
}

// Función para mostrar código de verificación
function mostrarCodigo(codigo) {
  if (!codigo) {
    alert('⚠️ No hay código de verificación disponible para este documento.');
    return;
  }
  
  alert(`🔑 Código de verificación: ${codigo}\n\n📋 Este código debe proporcionarse al cliente para autorizar la entrega por terceros.\n\n💡 El cliente debe presentar este código junto con su identificación para retirar el documento.`);
}

// Función para entregar documento (mantenida para compatibilidad)
function entregarDocumento(documentoId) {
  window.location.href = `/archivo/documentos/entrega/${documentoId}`;
}

// Inicializar tooltips cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
  // Activar tooltips de Bootstrap
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  
  console.log('✅ Vista de archivo cargada correctamente - Tooltips activados');
});
</script>

{{!-- Estilos específicos --}}
<style>
  .btn-purple {
    background-color: #6f42c1;
    border-color: #6f42c1;
    color: white;
  }
  
  .btn-purple:hover {
    background-color: #5a2d91;
    border-color: #5a2d91;
    color: white;
  }
  
  .text-purple {
    color: #6f42c1 !important;
  }
  
  /* Mejorar visibilidad de botones de acción */
  .btn-group-sm .btn {
    padding: 0.375rem 0.5rem;
    font-size: 0.875rem;
    margin: 0 1px;
  }
  
  /* Efectos hover para botones */
  .btn-outline-primary:hover {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
  }
  
  .btn-outline-success:hover {
    background-color: #198754;
    border-color: #198754;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(25, 135, 84, 0.3);
  }
  
  .btn-outline-warning:hover {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #000;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
  }
  
  .btn-outline-info:hover {
    background-color: #0dcaf0;
    border-color: #0dcaf0;
    color: #000;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(13, 202, 240, 0.3);
  }
  
  /* Espaciado para badges mejorados */
  .badge {
    font-weight: 600;
    font-size: 0.85em;
    padding: 0.5em 0.75em;
    border-radius: 0.5rem;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  
  .badge i {
    font-size: 0.9em;
    margin-right: 0.25rem;
  }
  
  /* Colores específicos para estados de pago */
  .badge.bg-success {
    background-color: #198754 !important;
    color: white;
    box-shadow: 0 2px 4px rgba(25, 135, 84, 0.3);
  }
  
  .badge.bg-danger {
    background-color: #dc3545 !important;
    color: white;
    box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
  }
  
  .badge.bg-warning {
    background-color: #fd7e14 !important;
    color: white;
    box-shadow: 0 2px 4px rgba(253, 126, 20, 0.3);
  }
  
  .badge.bg-info {
    background-color: #0dcaf0 !important;
    color: #000;
    box-shadow: 0 2px 4px rgba(13, 202, 240, 0.3);
  }
  
  .badge.bg-primary {
    background-color: #0d6efd !important;
    color: white;
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
  }
  
  .badge.bg-secondary {
    background-color: #6c757d !important;
    color: white;
    box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
  }
  
  /* Animación para botones con spinner */
  .btn .fa-spinner {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Mejorar tabla responsiva */
  .table-responsive {
    border-radius: 0.5rem;
  }
  
  .table th {
    border-top: none;
    font-weight: 600;
    background-color: #f8f9fa;
    color: #495057;
  }
  
  .table td {
    vertical-align: middle;
  }
  
  /* Mejorar enlaces de código de barras */
  .table td a {
    transition: color 0.2s ease;
  }
  
  .table td a:hover {
    color: #6f42c1 !important;
    text-decoration: underline !important;
  }
</style>

 