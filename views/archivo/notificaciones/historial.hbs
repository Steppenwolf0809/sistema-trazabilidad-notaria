{{!-- Vista de Historial de Notificaciones para rol Archivo --}}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>
        <i class="fas fa-bell me-2 text-purple"></i> Historial de Notificaciones
      </h2>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/archivo">Dashboard</a></li>
          <li class="breadcrumb-item active">Historial de Notificaciones</li>
        </ol>
      </nav>
    </div>
    <div>
      <button class="btn btn-outline-secondary" onclick="window.print()">
        <i class="fas fa-print me-1"></i> Imprimir
      </button>
    </div>
  </div>

  {{!-- Filtros de b√∫squeda --}}
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">üîç Filtros de B√∫squeda</h5>
    </div>
    <div class="card-body">
      <form method="GET" action="/archivo/notificaciones/historial">
        <div class="row">
          <div class="col-md-3">
            <label class="form-label">üîç Buscar:</label>
            <input type="text" class="form-control" name="busqueda" 
                   value="{{filtros.busqueda}}" 
                   placeholder="C√≥digo, factura, nombre o c√©dula">
            <small class="text-muted">Busca por c√≥digo de barras, n√∫mero de factura, nombre del cliente o c√©dula</small>
          </div>
          <div class="col-md-2">
            <label class="form-label">üìÖ Desde:</label>
            <input type="date" class="form-control" name="fechaDesde" value="{{filtros.fechaDesde}}">
          </div>
          <div class="col-md-2">
            <label class="form-label">üìÖ Hasta:</label>
            <input type="date" class="form-control" name="fechaHasta" value="{{filtros.fechaHasta}}">
          </div>
          <div class="col-md-2">
            <label class="form-label">üì± Tipo:</label>
            <select class="form-control" name="tipo">
              <option value="">Todos</option>
              <option value="documento_listo" {{#if (eq filtros.tipo 'documento_listo')}}selected{{/if}}>üìã Listo</option>
              <option value="entrega_confirmada" {{#if (eq filtros.tipo 'entrega_confirmada')}}selected{{/if}}>‚úÖ Entregado</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">üìß Canal:</label>
            <select class="form-control" name="canal">
              <option value="">Todos</option>
              <option value="whatsapp" {{#if (eq filtros.canal 'whatsapp')}}selected{{/if}}>WhatsApp</option>
            </select>
          </div>
          <div class="col-md-1">
            <label class="form-label">&nbsp;</label>
            <button type="submit" class="btn btn-primary w-100">üîç</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  {{!-- Estad√≠sticas r√°pidas --}}
  {{#if stats}}
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h5 class="card-title">{{#if stats.enviadas}}{{stats.enviadas}}{{else}}0{{/if}}</h5>
              <p class="card-text">Enviadas</p>
            </div>
            <div class="align-self-center">
              <i class="fas fa-check-circle fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-danger text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h5 class="card-title">{{#if stats.fallidas}}{{stats.fallidas}}{{else}}0{{/if}}</h5>
              <p class="card-text">Fallidas</p>
            </div>
            <div class="align-self-center">
              <i class="fas fa-exclamation-triangle fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h5 class="card-title">{{#if stats.pendientes}}{{stats.pendientes}}{{else}}0{{/if}}</h5>
              <p class="card-text">Pendientes</p>
            </div>
            <div class="align-self-center">
              <i class="fas fa-clock fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h5 class="card-title">{{#if stats.total}}{{stats.total}}{{else}}0{{/if}}</h5>
              <p class="card-text">Total</p>
            </div>
            <div class="align-self-center">
              <i class="fas fa-bell fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {{/if}}

  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">üì± Historial de Notificaciones</h5>
    </div>
    <div class="card-body p-0">
      {{#if notificaciones.length}}
        <div class="table-responsive">
          <table class="table table-hover table-striped mb-0">
            <thead class="table-dark">
              <tr>
                <th>üìÖ Fecha/Hora</th>
                <th>üìÑ Documento</th>
                <th>üë®‚Äçüíº Matrizador</th>
                <th>üì± Tipo</th>
                <th>üìß Canal</th>
                <th>üì± Destinatario</th>
                <th>‚úÖ Estado</th>
                <th>üîç Acciones</th>
              </tr>
            </thead>
            <tbody>
              {{#each notificaciones}}
                <tr>
                  <td>
                    <div class="d-flex flex-column">
                      <span class="fw-bold fecha-evento" data-fecha="{{this.created_at}}">
                        {{formatDate this.created_at}}
                      </span>
                      <small class="text-muted hora-evento" data-fecha="{{this.created_at}}">
                        {{formatTime this.created_at}}
                      </small>
                    </div>
                  </td>
                  <td>
                    {{#if (or (eq this.tipo 'entrega_grupal') (eq this.tipo 'notificacion_grupal'))}}
                      {{!-- Para entrega grupal, mostrar informaci√≥n detallada --}}
                      <div class="d-flex flex-column">
                        <span class="fw-bold text-success">üì¶ ENTREGA GRUPAL</span>
                        {{#if this.metadatos.totalDocumentos}}
                          <small class="text-info">{{this.metadatos.totalDocumentos}} documentos entregados</small>
                        {{/if}}
                        {{#if this.metadatos.nombreCliente}}
                          <small class="text-primary fw-bold">{{this.metadatos.nombreCliente}}</small>
                        {{/if}}
                      </div>
                    {{else}}
                      {{!-- Para notificaciones individuales --}}
                      <div class="d-flex flex-column">
                        <a href="/archivo/documentos/detalle/{{this.documento.id}}" class="fw-bold text-decoration-none">
                          {{this.documento.codigoBarras}}
                        </a>
                        <small class="text-muted">{{this.documento.tipoDocumento}}</small>
                        <small class="text-primary">{{this.documento.nombreCliente}}</small>
                        {{#if this.documento.numeroFactura}}
                        <small class="text-secondary">Factura: {{this.documento.numeroFactura}}</small>
                        {{/if}}
                      </div>
                    {{/if}}
                  </td>
                  <td>
                    {{#if this.documento.matrizador}}
                      <span class="badge bg-info">üë®‚Äçüíº {{this.documento.matrizador.nombre}}</span>
                    {{else}}
                      <span class="badge bg-secondary">üìã Sin Matrizador</span>
                    {{/if}}
                  </td>
                  <td>
                    {{#if (eq this.tipo 'documento_listo')}}
                      <span class="badge bg-info">üìã Listo para Retiro</span>
                    {{else if (eq this.tipo 'entrega_confirmada')}}
                      <span class="badge bg-success">‚úÖ Entregado</span>
                    {{else if (eq this.tipo 'entrega_grupal')}}
                      <div class="d-flex flex-column">
                        <span class="badge bg-purple mb-1">üì¶ Entrega Grupal</span>
                        {{#if this.metadatos.totalDocumentos}}
                          <small class="text-muted">{{this.metadatos.totalDocumentos}} documentos</small>
                        {{/if}}
                      </div>
                    {{else}}
                      <span class="badge bg-secondary">{{this.tipo}}</span>
                    {{/if}}
                  </td>
                  <td>
                    {{#if this.metadatos.canal}}
                      {{#if (eq this.metadatos.canal 'whatsapp')}}
                        <span class="badge bg-success">üì± WhatsApp</span>
                      {{else if (eq this.metadatos.canal 'email')}}
                        <span class="badge bg-primary">üìß Email</span>
                      {{else if (eq this.metadatos.canal 'ambos')}}
                        <span class="badge bg-info">üì±üìß Ambos</span>
                      {{else}}
                        <span class="badge bg-secondary">{{this.metadatos.canal}}</span>
                      {{/if}}
                    {{else}}
                      <span class="badge bg-secondary">No especificado</span>
                    {{/if}}
                  </td>
                  <td>
                    <div class="d-flex flex-column">
                      {{#if this.documento.emailCliente}}
                      <small>üìß {{substring this.documento.emailCliente 0 15}}{{#if (gt this.documento.emailCliente.length 15)}}...{{/if}}</small>
                      {{/if}}
                      {{#if this.documento.telefonoCliente}}
                      <small>üì± {{this.documento.telefonoCliente}}</small>
                      {{/if}}
                    </div>
                  </td>
                  <td>
                    {{#if this.metadatos.estado}}
                      {{#if (eq this.metadatos.estado 'enviado')}}
                        <span class="badge bg-success">‚úÖ Enviado</span>
                      {{else if (eq this.metadatos.estado 'error')}}
                        <span class="badge bg-danger">‚ùå Error</span>
                      {{else if (eq this.metadatos.estado 'simulado')}}
                        <span class="badge bg-warning">üîÑ Simulado</span>
                      {{else}}
                        <span class="badge bg-secondary">{{this.metadatos.estado}}</span>
                      {{/if}}
                    {{else}}
                      <span class="badge bg-secondary">Sin estado</span>
                    {{/if}}
                  </td>
                  <td>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="verDetalleNotificacion({{this.id}})" title="Ver detalles">
                      üëÅÔ∏è Ver Detalle
                    </button>
                  </td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        </div>
      {{else}}
        <div class="text-center py-5">
          <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">üì≠ No se encontraron notificaciones</h5>
          <p class="text-muted">No hay notificaciones con los filtros aplicados o a√∫n no se han enviado notificaciones para tus documentos.</p>
        </div>
      {{/if}}
    </div>
  </div>
</div>

{{!-- Modal para ver detalles de notificaci√≥n --}}
<div class="modal fade" id="modalDetalleNotificacion" tabindex="-1" aria-labelledby="modalDetalleNotificacionLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-purple text-white">
        <h5 class="modal-title" id="modalDetalleNotificacionLabel">
          <i class="fas fa-bell me-2"></i>Detalles de Notificaci√≥n
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="detalleNotificacion">
          <!-- Contenido din√°mico -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

{{!-- Estilos espec√≠ficos --}}
<style>
  .text-purple {
    color: #6f42c1 !important;
  }
  
  .bg-purple {
    background-color: #6f42c1 !important;
  }
  
  .table th {
    border-top: none;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    color: #495057;
  }
  
  .table td {
    vertical-align: middle;
  }
  
  .badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
  }
</style>

{{!-- Scripts --}}
<script>
  function verDetalleNotificacion(notificacionId) {
    const detalleContainer = document.getElementById('detalleNotificacion');
    detalleContainer.innerHTML = `
      <div class="text-center">
        <div class="spinner-border text-purple" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando detalles de la notificaci√≥n...</p>
      </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('modalDetalleNotificacion'));
    modal.show();
    
    // Hacer llamada AJAX real para obtener los detalles
    fetch(`/archivo/notificaciones/detalle/${notificacionId}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Error al cargar los detalles');
        }
        return response.json();
      })
      .then(data => {
        mostrarDetalleNotificacion(data);
      })
      .catch(error => {
        console.error('Error:', error);
        detalleContainer.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Error al cargar los detalles de la notificaci√≥n
          </div>
        `;
      });
  }
  
  function mostrarDetalleNotificacion(data) {
    const detalleContainer = document.getElementById('detalleNotificacion');
    
    // Formatear el estado con colores
    let estadoBadge = '';
    switch(data.estado) {
      case 'enviado':
        estadoBadge = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Enviado</span>';
        break;
      case 'fallido':
        estadoBadge = '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Fallido</span>';
        break;
      case 'pendiente':
        estadoBadge = '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Pendiente</span>';
        break;
      case 'simulado':
        estadoBadge = '<span class="badge bg-info"><i class="fas fa-flask me-1"></i>Simulado</span>';
        break;
      default:
        estadoBadge = `<span class="badge bg-secondary">${data.estado}</span>`;
    }
    
    // Formatear el canal con iconos
    let canalIcon = '';
    switch(data.canal) {
      case 'whatsapp':
        canalIcon = '<i class="fab fa-whatsapp text-success me-2"></i>WhatsApp';
        break;
      case 'email':
        canalIcon = '<i class="fas fa-envelope text-primary me-2"></i>Email';
        break;
      case 'sms':
        canalIcon = '<i class="fas fa-sms text-info me-2"></i>SMS';
        break;
      default:
        canalIcon = `<i class="fas fa-bell me-2"></i>${data.canal}`;
    }
    
    // Formatear el tipo de evento
    let tipoEventoTexto = '';
    switch(data.tipoEvento) {
      case 'documento_listo':
        tipoEventoTexto = 'Documento Listo para Retirar';
        break;
      case 'entrega_confirmada':
        tipoEventoTexto = 'Confirmaci√≥n de Entrega';
        break;
      case 'entrega_grupal':
        tipoEventoTexto = 'Entrega Grupal';
        break;
      case 'recordatorio':
        tipoEventoTexto = 'Recordatorio';
        break;
      case 'alerta_sin_recoger':
        tipoEventoTexto = 'Alerta Sin Recoger';
        break;
      default:
        tipoEventoTexto = data.tipoEvento;
    }
    
    detalleContainer.innerHTML = `
      <div class="row">
        <div class="col-md-6">
          <h6 class="border-bottom pb-2">
            <i class="fas fa-info-circle me-2"></i>Informaci√≥n de Env√≠o
          </h6>
          <p><strong>ID:</strong> ${data.id}</p>
          <p><strong>Fecha:</strong> ${new Date(data.fechaEnvio).toLocaleString('es-EC')}</p>
          <p><strong>Tipo:</strong> ${tipoEventoTexto}</p>
          <p><strong>Canal:</strong> ${canalIcon}</p>
          <p><strong>Estado:</strong> ${estadoBadge}</p>
          <p><strong>Destinatario:</strong> <code>${data.destinatario || 'No disponible'}</code></p>
          <p><strong>Intentos:</strong> ${data.intentos}</p>
        </div>
        <div class="col-md-6">
          <h6 class="border-bottom pb-2">
            <i class="fas fa-file-alt me-2"></i>Informaci√≥n del Documento
          </h6>
          <p><strong>C√≥digo:</strong> <code>${data.documento.codigoBarras}</code></p>
          <p><strong>Tipo:</strong> ${data.documento.tipoDocumento}</p>
          <p><strong>Cliente:</strong> ${data.documento.nombreCliente}</p>
          ${data.documento.codigoVerificacion ? `<p><strong>C√≥digo Verificaci√≥n:</strong> <code class="bg-warning text-dark px-2 py-1 rounded">${data.documento.codigoVerificacion}</code></p>` : ''}
        </div>
      </div>
      
      ${data.mensajeEnviado ? `
      <div class="row mt-4">
        <div class="col-12">
          <h6 class="border-bottom pb-2">
            <i class="fas fa-comment-alt me-2"></i>Mensaje Enviado
          </h6>
          <div class="alert alert-light border">
            <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">${data.mensajeEnviado}</pre>
          </div>
        </div>
      </div>
      ` : ''}
      
      ${data.ultimoError ? `
      <div class="row mt-3">
        <div class="col-12">
          <h6 class="border-bottom pb-2 text-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>√öltimo Error
          </h6>
          <div class="alert alert-danger">
            <small>${data.ultimoError}</small>
          </div>
        </div>
      </div>
      ` : ''}
      
      ${data.metadatos && Object.keys(data.metadatos).length > 0 ? `
      <div class="row mt-3">
        <div class="col-12">
          <h6 class="border-bottom pb-2">
            <i class="fas fa-cog me-2"></i>Informaci√≥n T√©cnica
          </h6>
          <div class="alert alert-secondary">
            <small><pre>${JSON.stringify(data.metadatos, null, 2)}</pre></small>
          </div>
        </div>
      </div>
      ` : ''}
    `;
  }
</script> 