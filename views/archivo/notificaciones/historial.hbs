{{!-- Vista de Historial de Notificaciones para rol Archivo --}}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>
        <i class="fas fa-bell me-2 text-purple"></i> Historial de Notificaciones
      </h2>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/archivo">Dashboard</a></li>
          <li class="breadcrumb-item active">Historial de Notificaciones</li>
        </ol>
      </nav>
    </div>
    <div>
      <button class="btn btn-outline-secondary" onclick="window.print()">
        <i class="fas fa-print me-1"></i> Imprimir
      </button>
    </div>
  </div>

  <div class="card">
    <div class="card-body p-0">
      {{#if notificaciones.length}}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Fecha</th>
                <th>Documento</th>
                <th>Cliente</th>
                <th>Tipo</th>
                <th>Método</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {{#each notificaciones}}
                <tr>
                  <td>{{formatDateTime this.created_at}}</td>
                  <td>
                    <a href="/archivo/documentos/detalle/{{this.documento.id}}" class="fw-bold text-decoration-none">
                      {{this.documento.codigoBarras}}
                    </a>
                    <div class="small text-muted">{{this.documento.tipoDocumento}}</div>
                  </td>
                  <td>{{this.documento.nombreCliente}}</td>
                  <td>
                    {{#if (eq this.tipoEvento "documento_listo")}}
                      <span class="badge bg-success">Documento Listo</span>
                    {{else if (eq this.tipoEvento "entrega_confirmada")}}
                      <span class="badge bg-primary">Entrega Confirmada</span>
                    {{else if (eq this.tipoEvento "entrega_grupal")}}
                      <span class="badge bg-info">Entrega Grupal</span>
                    {{else if (eq this.tipoEvento "recordatorio")}}
                      <span class="badge bg-warning">Recordatorio</span>
                    {{else if (eq this.tipoEvento "alerta_sin_recoger")}}
                      <span class="badge bg-danger">Alerta Sin Recoger</span>
                    {{else}}
                      <span class="badge bg-info">{{this.tipoEvento}}</span>
                    {{/if}}
                  </td>
                  <td>
                    {{#if (eq this.canal "whatsapp")}}
                      <i class="fab fa-whatsapp text-success me-1"></i> WhatsApp
                    {{else if (eq this.canal "email")}}
                      <i class="fas fa-envelope text-primary me-1"></i> Email
                    {{else if (eq this.canal "sms")}}
                      <i class="fas fa-sms text-info me-1"></i> SMS
                    {{else}}
                      <i class="fas fa-bell text-secondary me-1"></i> {{this.canal}}
                    {{/if}}
                  </td>
                  <td>
                    {{#if (eq this.estado "enviado")}}
                      <span class="badge bg-success">
                        <i class="fas fa-check me-1"></i>Enviado
                      </span>
                    {{else if (eq this.estado "fallido")}}
                      <span class="badge bg-danger">
                        <i class="fas fa-times me-1"></i>Fallido
                      </span>
                    {{else if (eq this.estado "pendiente")}}
                      <span class="badge bg-warning">
                        <i class="fas fa-clock me-1"></i>Pendiente
                      </span>
                    {{else if (eq this.estado "simulado")}}
                      <span class="badge bg-info">
                        <i class="fas fa-flask me-1"></i>Simulado
                      </span>
                    {{else}}
                      <span class="badge bg-secondary">{{this.estado}}</span>
                    {{/if}}
                  </td>
                  <td>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="verDetalleNotificacion({{this.id}})" title="Ver detalles">
                      <i class="fas fa-eye"></i>
                    </button>
                  </td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        </div>

        {{!-- Paginación --}}
        {{#if (gt paginacion.totalPages 1)}}
          <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">
                Mostrando {{paginacion.totalNotifications}} notificaciones
              </small>
              <nav>
                <ul class="pagination pagination-sm mb-0">
                  {{#if paginacion.hasPrevPage}}
                    <li class="page-item">
                      <a class="page-link" href="?page={{paginacion.prevPage}}">Anterior</a>
                    </li>
                  {{/if}}
                  
                  {{#each (range 1 paginacion.totalPages)}}
                    <li class="page-item {{#if (eq this ../paginacion.currentPage)}}active{{/if}}">
                      <a class="page-link" href="?page={{this}}">{{this}}</a>
                    </li>
                  {{/each}}
                  
                  {{#if paginacion.hasNextPage}}
                    <li class="page-item">
                      <a class="page-link" href="?page={{paginacion.nextPage}}">Siguiente</a>
                    </li>
                  {{/if}}
                </ul>
              </nav>
            </div>
          </div>
        {{/if}}
      {{else}}
        <div class="text-center py-5">
          <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">No hay notificaciones</h5>
          <p class="text-muted">Aún no se han enviado notificaciones para tus documentos.</p>
        </div>
      {{/if}}
    </div>
  </div>
</div>

{{!-- Modal para ver detalles de notificación --}}
<div class="modal fade" id="modalDetalleNotificacion" tabindex="-1" aria-labelledby="modalDetalleNotificacionLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-purple text-white">
        <h5 class="modal-title" id="modalDetalleNotificacionLabel">
          <i class="fas fa-bell me-2"></i>Detalles de Notificación
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="detalleNotificacion">
          <!-- Contenido dinámico -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

{{!-- Estilos específicos --}}
<style>
  .text-purple {
    color: #6f42c1 !important;
  }
  
  .bg-purple {
    background-color: #6f42c1 !important;
  }
  
  .table th {
    border-top: none;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    color: #495057;
  }
  
  .table td {
    vertical-align: middle;
  }
  
  .badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
  }
</style>

{{!-- Scripts --}}
<script>
  function verDetalleNotificacion(notificacionId) {
    const detalleContainer = document.getElementById('detalleNotificacion');
    detalleContainer.innerHTML = `
      <div class="text-center">
        <div class="spinner-border text-purple" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando detalles de la notificación...</p>
      </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('modalDetalleNotificacion'));
    modal.show();
    
    // Hacer llamada AJAX real para obtener los detalles
    fetch(`/archivo/notificaciones/detalle/${notificacionId}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Error al cargar los detalles');
        }
        return response.json();
      })
      .then(data => {
        mostrarDetalleNotificacion(data);
      })
      .catch(error => {
        console.error('Error:', error);
        detalleContainer.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Error al cargar los detalles de la notificación
          </div>
        `;
      });
  }
  
  function mostrarDetalleNotificacion(data) {
    const detalleContainer = document.getElementById('detalleNotificacion');
    
    // Formatear el estado con colores
    let estadoBadge = '';
    switch(data.estado) {
      case 'enviado':
        estadoBadge = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Enviado</span>';
        break;
      case 'fallido':
        estadoBadge = '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Fallido</span>';
        break;
      case 'pendiente':
        estadoBadge = '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Pendiente</span>';
        break;
      case 'simulado':
        estadoBadge = '<span class="badge bg-info"><i class="fas fa-flask me-1"></i>Simulado</span>';
        break;
      default:
        estadoBadge = `<span class="badge bg-secondary">${data.estado}</span>`;
    }
    
    // Formatear el canal con iconos
    let canalIcon = '';
    switch(data.canal) {
      case 'whatsapp':
        canalIcon = '<i class="fab fa-whatsapp text-success me-2"></i>WhatsApp';
        break;
      case 'email':
        canalIcon = '<i class="fas fa-envelope text-primary me-2"></i>Email';
        break;
      case 'sms':
        canalIcon = '<i class="fas fa-sms text-info me-2"></i>SMS';
        break;
      default:
        canalIcon = `<i class="fas fa-bell me-2"></i>${data.canal}`;
    }
    
    // Formatear el tipo de evento
    let tipoEventoTexto = '';
    switch(data.tipoEvento) {
      case 'documento_listo':
        tipoEventoTexto = 'Documento Listo para Retirar';
        break;
      case 'entrega_confirmada':
        tipoEventoTexto = 'Confirmación de Entrega';
        break;
      case 'entrega_grupal':
        tipoEventoTexto = 'Entrega Grupal';
        break;
      case 'recordatorio':
        tipoEventoTexto = 'Recordatorio';
        break;
      case 'alerta_sin_recoger':
        tipoEventoTexto = 'Alerta Sin Recoger';
        break;
      default:
        tipoEventoTexto = data.tipoEvento;
    }
    
    detalleContainer.innerHTML = `
      <div class="row">
        <div class="col-md-6">
          <h6 class="border-bottom pb-2">
            <i class="fas fa-info-circle me-2"></i>Información de Envío
          </h6>
          <p><strong>ID:</strong> ${data.id}</p>
          <p><strong>Fecha:</strong> ${new Date(data.fechaEnvio).toLocaleString('es-EC')}</p>
          <p><strong>Tipo:</strong> ${tipoEventoTexto}</p>
          <p><strong>Canal:</strong> ${canalIcon}</p>
          <p><strong>Estado:</strong> ${estadoBadge}</p>
          <p><strong>Destinatario:</strong> <code>${data.destinatario || 'No disponible'}</code></p>
          <p><strong>Intentos:</strong> ${data.intentos}</p>
        </div>
        <div class="col-md-6">
          <h6 class="border-bottom pb-2">
            <i class="fas fa-file-alt me-2"></i>Información del Documento
          </h6>
          <p><strong>Código:</strong> <code>${data.documento.codigoBarras}</code></p>
          <p><strong>Tipo:</strong> ${data.documento.tipoDocumento}</p>
          <p><strong>Cliente:</strong> ${data.documento.nombreCliente}</p>
          ${data.documento.codigoVerificacion ? `<p><strong>Código Verificación:</strong> <code class="bg-warning text-dark px-2 py-1 rounded">${data.documento.codigoVerificacion}</code></p>` : ''}
        </div>
      </div>
      
      ${data.mensajeEnviado ? `
      <div class="row mt-4">
        <div class="col-12">
          <h6 class="border-bottom pb-2">
            <i class="fas fa-comment-alt me-2"></i>Mensaje Enviado
          </h6>
          <div class="alert alert-light border">
            <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">${data.mensajeEnviado}</pre>
          </div>
        </div>
      </div>
      ` : ''}
      
      ${data.ultimoError ? `
      <div class="row mt-3">
        <div class="col-12">
          <h6 class="border-bottom pb-2 text-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>Último Error
          </h6>
          <div class="alert alert-danger">
            <small>${data.ultimoError}</small>
          </div>
        </div>
      </div>
      ` : ''}
      
      ${data.metadatos && Object.keys(data.metadatos).length > 0 ? `
      <div class="row mt-3">
        <div class="col-12">
          <h6 class="border-bottom pb-2">
            <i class="fas fa-cog me-2"></i>Información Técnica
          </h6>
          <div class="alert alert-secondary">
            <small><pre>${JSON.stringify(data.metadatos, null, 2)}</pre></small>
          </div>
        </div>
      </div>
      ` : ''}
    `;
  }
</script> 