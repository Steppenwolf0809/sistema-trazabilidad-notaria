<!-- Estilos CSS para la p√°gina -->
<style>
  .notification-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
  .notification-badge.documento_listo {
    background-color: #007bff;
    color: white;
  }
  .notification-badge.documento_entregado {
    background-color: #28a745;
    color: white;
  }
  .table-responsive {
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }
  .modal-body pre {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.25rem;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  .mensaje-enviado {
    background-color: #e8f5e8;
    border: 1px solid #c3e6c3;
    border-radius: 0.5rem;
    padding: 1rem;
    margin: 1rem 0;
    font-family: monospace;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 400px;
    overflow-y: auto;
  }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i class="fas fa-history me-2"></i> Historial de Notificaciones
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/matrizador">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="/matrizador/documentos">Documentos</a></li>
                    <li class="breadcrumb-item active">Historial de Notificaciones</li>
                </ol>
            </nav>
        </div>
        <div>
            <button class="btn btn-outline-secondary" onclick="window.print()">
                <i class="fas fa-print me-1"></i> Imprimir
            </button>
        </div>
    </div>

    <!-- Filtros de b√∫squeda -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">üîç Filtros de B√∫squeda</h5>
        </div>
        <div class="card-body">
            <form method="GET" action="/matrizador/notificaciones/historial">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">üîç Buscar:</label>
                        <input type="text" class="form-control" name="busqueda" 
                               value="{{filtros.busqueda}}" 
                               placeholder="C√≥digo, factura, nombre o c√©dula">
                        <small class="text-muted">Busca por c√≥digo de barras, n√∫mero de factura, nombre del cliente o c√©dula</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">üìÖ Desde:</label>
                        <input type="date" class="form-control" name="fechaDesde" value="{{filtros.fechaDesde}}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">üìÖ Hasta:</label>
                        <input type="date" class="form-control" name="fechaHasta" value="{{filtros.fechaHasta}}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">üì± Tipo:</label>
                        <select class="form-control" name="tipo">
                            <option value="">Todos</option>
                            <option value="documento_listo" {{#if (eq filtros.tipo 'documento_listo')}}selected{{/if}}>üìã Listo</option>
                            <option value="documento_entregado" {{#if (eq filtros.tipo 'documento_entregado')}}selected{{/if}}>‚úÖ Entregado</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">üìß Canal:</label>
                        <select class="form-control" name="canal">
                            <option value="">Todos</option>
                            <option value="whatsapp" {{#if (eq filtros.canal 'whatsapp')}}selected{{/if}}>WhatsApp</option>
                            <option value="email" {{#if (eq filtros.canal 'email')}}selected{{/if}}>Email</option>
                            <option value="ambos" {{#if (eq filtros.canal 'ambos')}}selected{{/if}}>Ambos</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">üîç</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Estad√≠sticas r√°pidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">{{#if stats.enviadas}}{{stats.enviadas}}{{else}}0{{/if}}</h5>
                            <p class="card-text">Enviadas</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">{{#if stats.fallidas}}{{stats.fallidas}}{{else}}0{{/if}}</h5>
                            <p class="card-text">Fallidas</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">{{#if stats.pendientes}}{{stats.pendientes}}{{else}}0{{/if}}</h5>
                            <p class="card-text">Pendientes</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">{{#if stats.total}}{{stats.total}}{{else}}0{{/if}}</h5>
                            <p class="card-text">Total</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-bell fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de notificaciones -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">üì± Historial de Notificaciones</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>üìÖ Fecha/Hora</th>
                            <th>üìÑ Documento</th>
                            <th>üì± Tipo</th>
                            <th>üìß Canal</th>
                            <th>‚úÖ Estado</th>
                            <th>üîç Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each notificaciones}}
                        <tr>
                            <td>
                                <div class="d-flex flex-column">
                                    <span class="fw-bold fecha-evento" data-fecha="{{this.created_at}}" data-fecha-formateada="{{this.metadatos.fechaFormateada}}">
                                        {{#if this.metadatos.fechaFormateada}}
                                        {{this.metadatos.fechaFormateada}}
                                        {{else}}
                                        Cargando...
                                        {{/if}}
                                    </span>
                                    <small class="text-muted hora-evento" data-fecha="{{this.created_at}}" data-fecha-formateada="{{this.metadatos.fechaFormateada}}">
                                        {{#if this.metadatos.fechaFormateada}}
                                        {{this.metadatos.fechaFormateada}}
                                        {{else}}
                                        -
                                        {{/if}}
                                    </small>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-column">
                                    <span class="fw-bold">{{this.documento.codigoBarras}}</span>
                                    <small class="text-muted">{{this.documento.tipoDocumento}}</small>
                                    <small class="text-primary">{{this.documento.nombreCliente}}</small>
                                    {{#if this.documento.numeroFactura}}
                                    <small class="text-secondary">Factura: {{this.documento.numeroFactura}}</small>
                                    {{/if}}
                                </div>
                            </td>
                            <td>
                                {{#if (eq this.tipo 'documento_listo')}}
                                    <span class="badge bg-info">üìã Listo para Retiro</span>
                                {{else if (eq this.tipo 'documento_entregado')}}
                                    <span class="badge bg-success">‚úÖ Entregado</span>
                                {{else}}
                                    <span class="badge bg-secondary">{{this.tipo}}</span>
                                {{/if}}
                            </td>
                            <td>
                                {{#if this.metadatos.canal}}
                                    {{#if (eq this.metadatos.canal 'whatsapp')}}
                                        <span class="badge bg-success">üì± WhatsApp</span>
                                    {{else if (eq this.metadatos.canal 'email')}}
                                        <span class="badge bg-primary">üìß Email</span>
                                    {{else if (eq this.metadatos.canal 'ambos')}}
                                        <span class="badge bg-info">üì±üìß Ambos</span>
                                    {{else}}
                                        <span class="badge bg-secondary">{{this.metadatos.canal}}</span>
                                    {{/if}}
                                {{else}}
                                    <span class="badge bg-secondary">No especificado</span>
                                {{/if}}
                            </td>
                            <td>
                                {{#if this.metadatos.estado}}
                                    {{#if (eq this.metadatos.estado 'enviado')}}
                                        <span class="badge bg-success">‚úÖ Enviado</span>
                                    {{else if (eq this.metadatos.estado 'error')}}
                                        <span class="badge bg-danger">‚ùå Error</span>
                                    {{else if (eq this.metadatos.estado 'simulado')}}
                                        <span class="badge bg-warning">üîÑ Simulado</span>
                                    {{else}}
                                        <span class="badge bg-secondary">{{this.metadatos.estado}}</span>
                                    {{/if}}
                                {{else}}
                                    <span class="badge bg-secondary">Sin estado</span>
                                {{/if}}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="verDetalleNotificacion({{this.id}})">
                                    üëÅÔ∏è Ver Detalle
                                </button>
                            </td>
                        </tr>
                        {{else}}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                üì≠ No se encontraron notificaciones con los filtros aplicados
                            </td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
            
            {{#if notificaciones.length}}
            <div class="d-flex justify-content-between align-items-center mt-3">
                <small class="text-muted">
                    Mostrando {{notificaciones.length}} notificaciones (m√°ximo 50 resultados)
                </small>
                <a href="/matrizador/notificaciones/historial" class="btn btn-sm btn-outline-secondary">
                    üîÑ Limpiar Filtros
                </a>
            </div>
            {{/if}}
        </div>
    </div>
</div>

<!-- Modal para detalles de notificaci√≥n -->
<div class="modal fade" id="modalDetalleNotificacion" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üì± Detalle de Notificaci√≥n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contenidoDetalleNotificacion">
                <!-- Contenido cargado din√°micamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
function verDetalleNotificacion(id) {
    const modal = new bootstrap.Modal(document.getElementById('modalDetalleNotificacion'));
    const contenido = document.getElementById('contenidoDetalleNotificacion');
    
    // Mostrar spinner
    contenido.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Cargar detalles
    fetch(`/matrizador/api/notificaciones/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.exito) {
                const detalles = data.datos;
                
                // Debug: Verificar datos recibidos
                console.log('üìã Detalles recibidos:', detalles);
                console.log('üìÖ Fecha raw:', detalles.fecha);
                console.log('üîß Metadatos:', detalles.metadatos);
                console.log('üìÖ Fecha formateada en metadatos:', detalles.metadatos?.fechaFormateada);
                
                contenido.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-file-alt"></i> Informaci√≥n del Documento</h6>
                            <table class="table table-sm">
                                <tr><td><strong>C√≥digo:</strong></td><td>${detalles.documento.codigo}</td></tr>
                                <tr><td><strong>Tipo:</strong></td><td>${detalles.documento.tipo}</td></tr>
                                <tr><td><strong>Cliente:</strong></td><td>${detalles.documento.cliente}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-bell"></i> Informaci√≥n de la Notificaci√≥n</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Tipo:</strong></td><td>${detalles.tipo}</td></tr>
                                <tr><td><strong>Fecha:</strong></td><td>${formatearFechaModal(detalles.fecha, detalles.metadatos)}</td></tr>
                                <tr><td><strong>Usuario:</strong></td><td>${detalles.usuario}</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <h6><i class="fas fa-comment-alt"></i> Detalles</h6>
                    <pre>${detalles.detalles}</pre>
                    
                    ${detalles.mensajeEnviado ? `
                        <h6><i class="fas fa-envelope"></i> Mensaje Enviado al Cliente</h6>
                        <div class="mensaje-enviado">${detalles.mensajeEnviado}</div>
                    ` : ''}
                    
                    <h6><i class="fas fa-share-alt"></i> Canales de Env√≠o</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Email:</strong> ${detalles.canales.email || 'No disponible'}
                        </div>
                        <div class="col-md-6">
                            <strong>Tel√©fono:</strong> ${detalles.canales.telefono || 'No disponible'}
                        </div>
                    </div>
                    
                    ${detalles.metadatos && Object.keys(detalles.metadatos).length > 0 ? `
                        <h6 class="mt-3"><i class="fas fa-cogs"></i> Metadatos</h6>
                        <pre>${JSON.stringify(detalles.metadatos, null, 2)}</pre>
                    ` : ''}
                `;
            } else {
                contenido.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error al cargar los detalles: ${data.mensaje}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            contenido.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error de conexi√≥n al cargar los detalles
                </div>
            `;
        });
}

// ============== FORMATEAR FECHAS AL CARGAR LA P√ÅGINA ==============
document.addEventListener('DOMContentLoaded', function() {
    console.log('üïí Iniciando formateo de fechas en historial de notificaciones...');
    
    // Funci√≥n para formatear fecha de manera robusta
    function formatearFechaSegura(fechaRaw) {
        if (!fechaRaw || fechaRaw === 'null' || fechaRaw === '' || fechaRaw === 'undefined') {
            return 'Sin fecha';
        }
        
        try {
            // Intentar diferentes formatos de fecha
            let fecha;
            
            // Si ya es un objeto Date
            if (fechaRaw instanceof Date) {
                fecha = fechaRaw;
            }
            // Si es un string ISO
            else if (typeof fechaRaw === 'string') {
                // Limpiar la fecha de caracteres extra√±os
                const fechaLimpia = fechaRaw.trim();
                fecha = new Date(fechaLimpia);
            }
            // Si es un timestamp
            else if (typeof fechaRaw === 'number') {
                fecha = new Date(fechaRaw);
            }
            else {
                console.warn('Formato de fecha no reconocido:', fechaRaw);
                return 'Formato inv√°lido';
            }
            
            // Verificar si la fecha es v√°lida
            if (isNaN(fecha.getTime())) {
                console.warn('Fecha inv√°lida despu√©s de conversi√≥n:', fechaRaw);
                return 'Fecha inv√°lida';
            }
            
            return fecha;
        } catch (error) {
            console.error('Error procesando fecha:', error, 'Fecha original:', fechaRaw);
            return 'Error en fecha';
        }
    }
    
    // Formatear fechas principales (fecha completa)
    document.querySelectorAll('.fecha-evento').forEach(function(elemento) {
        const fechaRaw = elemento.getAttribute('data-fecha');
        const fechaFormateada = elemento.getAttribute('data-fecha-formateada');
        
        console.log('üìÖ Procesando fecha principal:', fechaRaw, 'Pre-formateada:', fechaFormateada);
        
        // Si ya tenemos fecha pre-procesada, usarla
        if (fechaFormateada && fechaFormateada !== 'undefined' && fechaFormateada !== '') {
            console.log('üìÖ Usando fecha pre-procesada:', fechaFormateada);
            // Extraer solo la fecha (sin hora) de la fecha formateada
            const soloFecha = fechaFormateada.split(' ')[0];
            elemento.textContent = soloFecha;
            elemento.classList.add('text-success');
            return;
        }
        
        // Si no hay fecha pre-procesada, procesar la fecha raw
        const fechaProcesada = formatearFechaSegura(fechaRaw);
        
        if (fechaProcesada instanceof Date) {
            elemento.textContent = fechaProcesada.toLocaleDateString('es-EC', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            });
            elemento.classList.add('text-success');
        } else {
            elemento.textContent = fechaProcesada;
            elemento.classList.add('text-muted');
        }
    });
    
    // Formatear horas (solo hora)
    document.querySelectorAll('.hora-evento').forEach(function(elemento) {
        const fechaRaw = elemento.getAttribute('data-fecha');
        const fechaFormateada = elemento.getAttribute('data-fecha-formateada');
        
        console.log('üïí Procesando hora:', fechaRaw, 'Pre-formateada:', fechaFormateada);
        
        // Si ya tenemos fecha pre-procesada, usarla
        if (fechaFormateada && fechaFormateada !== 'undefined' && fechaFormateada !== '') {
            console.log('üïí Usando hora pre-procesada:', fechaFormateada);
            // Extraer solo la hora de la fecha formateada
            const partes = fechaFormateada.split(' ');
            if (partes.length > 1) {
                elemento.textContent = partes[1];
            } else {
                elemento.textContent = '-';
            }
            return;
        }
        
        // Si no hay fecha pre-procesada, procesar la fecha raw
        const fechaProcesada = formatearFechaSegura(fechaRaw);
        
        if (fechaProcesada instanceof Date) {
            elemento.textContent = fechaProcesada.toLocaleTimeString('es-EC', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        } else {
            elemento.textContent = '-';
        }
    });
    
    console.log('‚úÖ Formateo de fechas completado');
});

function formatearFechaModal(fechaRaw, metadatos) {
    // Primero verificar si tenemos fecha pre-procesada en metadatos
    if (metadatos && metadatos.fechaFormateada) {
        console.log('üìÖ Modal: Usando fecha pre-procesada:', metadatos.fechaFormateada);
        return metadatos.fechaFormateada;
    }
    
    if (!fechaRaw || fechaRaw === 'null' || fechaRaw === '' || fechaRaw === 'undefined') {
        return 'Sin fecha';
    }
    
    try {
        // Intentar diferentes formatos de fecha
        let fecha;
        
        // Si ya es un objeto Date
        if (fechaRaw instanceof Date) {
            fecha = fechaRaw;
        }
        // Si es un string ISO
        else if (typeof fechaRaw === 'string') {
            // Limpiar la fecha de caracteres extra√±os
            const fechaLimpia = fechaRaw.trim();
            fecha = new Date(fechaLimpia);
        }
        // Si es un timestamp
        else if (typeof fechaRaw === 'number') {
            fecha = new Date(fechaRaw);
        }
        else {
            console.warn('Formato de fecha no reconocido:', fechaRaw);
            return 'Formato inv√°lido';
        }
        
        // Verificar si la fecha es v√°lida
        if (isNaN(fecha.getTime())) {
            console.warn('Fecha inv√°lida despu√©s de conversi√≥n:', fechaRaw);
            return 'Fecha inv√°lida';
        }
        
        return fecha.toLocaleString('es-EC', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
    } catch (error) {
        console.error('Error procesando fecha:', error, 'Fecha original:', fechaRaw);
        return 'Error en fecha';
    }
}
</script> 