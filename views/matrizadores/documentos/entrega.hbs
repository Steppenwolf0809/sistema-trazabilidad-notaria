{{!-- VISTA DE ENTREGA MATRIZADOR CORREGIDA - INTERFAZ UNIFICADA --}}
<div class="container-fluid" data-user-role="matrizador">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-handshake me-2"></i>Entrega de Documentos - Matrizador</h2>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/matrizador">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/matrizador/documentos">Documentos</a></li>
            <li class="breadcrumb-item active">Entrega</li>
          </ol>
        </nav>
      </div>

      {{!-- Mensajes de estado --}}
      {{#if error}}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fas fa-exclamation-triangle me-2"></i>{{error}}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {{/if}}

      {{#if success}}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="fas fa-check-circle me-2"></i>{{success}}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {{/if}}

      {{#if documento}}
        {{!-- ============== 1. DOCUMENTO PRINCIPAL CON INFORMACI√ìN COMPLETA ============== --}}
        <div class="card mb-3">
          <div class="card-header bg-success text-white">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h5 class="mb-1">
                  <i class="fas fa-file-alt me-2"></i>üìÑ Documento Principal: {{documento.codigoBarras}}
                </h5>
                <small class="opacity-75">
                  <strong>C√≥digo de Verificaci√≥n:</strong> 
                  {{#if documento.codigoVerificacion}}
                    {{#if (eq documento.codigoVerificacion 'sin_codigo')}}
                      <span class="badge bg-warning text-dark">Sin c√≥digo</span>
                    {{else}}
                      <code class="bg-light text-dark px-2 py-1 rounded">{{documento.codigoVerificacion}}</code>
                    {{/if}}
                  {{else}}
                    <span class="badge bg-warning text-dark">Sin c√≥digo</span>
                  {{/if}}
                </small>
              </div>
              <span class="badge bg-light text-dark fs-6">{{documento.tipoDocumento}}</span>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <h6><i class="fas fa-user me-1"></i> Cliente</h6>
                <p class="mb-1"><strong>{{documento.nombreCliente}}</strong></p>
                <p class="text-muted mb-0"><small>{{documento.identificacionCliente}}</small></p>
              </div>
              <div class="col-md-3">
                <h6><i class="fas fa-user-tie me-1"></i> Matrizador</h6>
                <p class="mb-1"><strong>{{documento.matrizador.nombre}}</strong></p>
                <p class="text-muted mb-0"><small>Asignado</small></p>
              </div>
              <div class="col-md-3">
                <h6><i class="fas fa-dollar-sign me-1"></i> Valor</h6>
                <p class="mb-1"><strong>${{formatMoney documento.valorFactura}}</strong></p>
                <p class="text-muted mb-0"><small>{{#if documento.numeroFactura}}Fact: {{documento.numeroFactura}}{{else}}Sin factura{{/if}}</small></p>
              </div>
              <div class="col-md-2">
                <h6><i class="fas fa-credit-card me-1"></i> Estado Pago</h6>
                <span class="badge {{estadoPagoClass documento.estadoPago}} fs-6">
                  {{estadoPagoTexto documento.estadoPago}}
                </span>
              </div>
            </div>
          </div>
        </div>

        {{!-- ============== 2. DOCUMENTOS ADICIONALES DETECTADOS ============== --}}
        {{#if documentosGrupales.tieneDocumentosAdicionales}}
          <div class="alert alert-info" id="alerta-entrega-grupal">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6><i class="fas fa-boxes me-2"></i>Documentos Adicionales Detectados</h6>
                <p class="mb-2">
                  Se encontraron <strong>{{documentosGrupales.cantidad}} documento(s) propio(s)</strong> 
                  adicionales del mismo cliente listos para entrega.
                </p>
                {{#if (gt documentosGrupales.documentosOtrosMatrizadores.length 0)}}
                  <p class="mb-2 text-warning">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    Tambi√©n hay <strong>{{documentosGrupales.documentosOtrosMatrizadores.length}} documento(s) de otros matrizadores</strong>
                  </p>
                {{/if}}
                <p class="mb-0 text-warning">
                  <i class="fas fa-shield-alt me-1"></i>
                  <strong>Acceso Matrizador:</strong> Solo puede entregar sus propios documentos
                </p>
              </div>
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="ocultarEntregaGrupal()">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>

          {{!-- Tabla de documentos propios con ESTADO DE PAGO VISIBLE --}}
          {{#if (gt documentosGrupales.cantidad 0)}}
            <div class="card mb-4" id="seccion-entrega-grupal">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="mb-0">
                    <i class="fas fa-list-check me-2"></i>
                    Seleccionar Sus Documentos Adicionales
                  </h6>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAll">
                    <label class="form-check-label" for="selectAll">
                      <strong>Seleccionar todos</strong>
                    </label>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover table-sm">
                    <thead class="table-light">
                      <tr>
                        <th width="50">Seleccionar</th>
                        <th>C√≥digo</th>
                        <th>Tipo</th>
                        <th>Valor</th>
                        <th>Estado Pago</th>
                        <th>Estado</th>
                      </tr>
                    </thead>
                    <tbody>
                      {{#each documentosGrupales.documentos}}
                        <tr>
                          <td>
                            <div class="form-check">
                              <input 
                                class="form-check-input documento-checkbox" 
                                type="checkbox" 
                                value="{{this.id}}"
                                data-codigo="{{this.codigoVerificacion}}"
                                data-matrizador-id="{{this.idMatrizador}}"
                                id="doc_{{this.id}}">
                              <label class="form-check-label" for="doc_{{this.id}}"></label>
                            </div>
                          </td>
                          <td>
                            <strong>{{this.codigoBarras}}</strong>
                          </td>
                          <td>
                            <span class="badge bg-secondary">{{this.tipoDocumento}}</span>
                          </td>
                          <td>
                            <strong>${{formatMoney this.valorFactura}}</strong>
                          </td>
                          <td>
                            <span class="badge {{estadoPagoClass this.estadoPago}}">
                              {{estadoPagoTexto this.estadoPago}}
                            </span>
                          </td>
                          <td>
                            <span class="badge bg-success">Listo</span>
                          </td>
                        </tr>
                      {{/each}}
                    </tbody>
                  </table>
                </div>

                {{!-- Contador de selecci√≥n mejorado --}}
                <div class="mt-3">
                  <div class="alert alert-light border">
                    <div class="d-flex justify-content-between align-items-center">
                      <span>
                        <i class="fas fa-info-circle me-2 text-info"></i>
                        <span id="contador-seleccion">1 documento(s) seleccionado(s)</span>
                      </span>
                      <div id="codigos-seleccionados" class="small text-muted"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {{/if}}

          {{!-- Alerta sobre documentos de otros matrizadores --}}
          {{#if (gt documentosGrupales.documentosOtrosMatrizadores.length 0)}}
            <div class="alert alert-warning" id="alerta-documentos-otros">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <h6><i class="fas fa-exclamation-triangle me-2"></i>Documentos de Otros Matrizadores</h6>
                  <p class="mb-2">
                    <strong>Atenci√≥n:</strong> Se detectaron <strong>{{documentosGrupales.documentosOtrosMatrizadores.length}} documento(s)</strong> 
                    del mismo cliente asignados a otros matrizadores.
                  </p>
                  
                  {{!-- Lista de documentos de otros matrizadores --}}
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead class="table-light">
                        <tr>
                          <th>C√≥digo</th>
                          <th>Tipo</th>
                          <th>Matrizador</th>
                          <th>Valor</th>
                          <th>Estado Pago</th>
                        </tr>
                      </thead>
                      <tbody>
                        {{#each documentosGrupales.documentosOtrosMatrizadores}}
                          <tr class="table-warning">
                            <td><strong>{{this.codigoBarras}}</strong></td>
                            <td>{{this.tipoDocumento}}</td>
                            <td>{{#if this.matrizador}}{{this.matrizador.nombre}}{{else}}Sin asignar{{/if}}</td>
                            <td><strong>${{formatMoney this.valorFactura}}</strong></td>
                            <td>
                              <span class="badge {{estadoPagoClass this.estadoPago}}">
                                {{estadoPagoTexto this.estadoPago}}
                              </span>
                            </td>
                          </tr>
                        {{/each}}
                      </tbody>
                    </table>
                  </div>
                  
                  <p class="mb-0 text-info">
                    <i class="fas fa-lightbulb me-1"></i>
                    <strong>Recomendaci√≥n:</strong> Coordine con recepci√≥n para una entrega grupal completa o informe al cliente que puede recoger estos documentos en recepci√≥n.
                  </p>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="ocultarAlertaOtros()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          {{/if}}
        {{/if}}

        {{!-- ============== 3. FORMULARIO DE ENTREGA CORREGIDO ============== --}}
        <form id="formEntrega" action="/matrizador/documentos/completar-entrega/{{documento.id}}" method="POST">
          {{!-- Campos ocultos para entrega grupal --}}
          <input type="hidden" id="documentos_seleccionados" name="documentosAdicionales" value="">
          <input type="hidden" id="entrega_grupal" name="entregaGrupal" value="false">
          <input type="hidden" name="tipoEntregaGrupal" value="matrizador_propios">

          {{!-- SECCI√ìN: VALIDACI√ìN DE C√ìDIGO CORREGIDA --}}
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-key me-2"></i>
                Validaci√≥n de C√≥digo
              </h6>
            </div>
            <div class="card-body">
              {{!-- Mostrar c√≥digos v√°lidos din√°micamente --}}
              <div class="alert alert-info" id="alert-codigos-validos">
                <strong>C√≥digos v√°lidos para esta entrega:</strong>
                <div id="lista-codigos-validos">
                  {{#if documento.codigoVerificacion}}
                    {{#unless (eq documento.codigoVerificacion 'sin_codigo')}}
                      <code class="bg-dark text-light px-2 py-1 rounded me-2">{{documento.codigoVerificacion}}</code>
                      <small class="text-muted me-3">(documento principal)</small>
                    {{/unless}}
                  {{/if}}
                </div>
              </div>

              {{!-- Input de c√≥digo con validaci√≥n mejorada --}}
              <div class="row">
                <div class="col-md-6">
                  <label for="codigoVerificacion" class="form-label">
                    <strong>C√≥digo de Verificaci√≥n</strong>
                    <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="codigoVerificacion" name="codigoVerificacion" 
                           placeholder="Ingrese c√≥digo de 4 d√≠gitos" maxlength="6" required>
                    <button type="button" class="btn btn-outline-primary" id="validarCodigo">
                      <i class="fas fa-check me-1"></i>Validar
                    </button>
                  </div>
                  <div id="mensaje-validacion-codigo" class="mt-2"></div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">M√©todo de verificaci√≥n alternativo</label>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="tipoVerificacion" value="llamada" id="verificacionLlamada">
                    <label class="form-check-label" for="verificacionLlamada">
                      Verificaci√≥n por llamada telef√≥nica
                    </label>
                  </div>
                  <div id="div-observaciones" class="mt-2 d-none">
                    <textarea class="form-control" id="observaciones" name="observaciones" rows="2" 
                              placeholder="Detalles de la verificaci√≥n por llamada..."></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {{!-- SECCI√ìN: INFORMACI√ìN DEL RECEPTOR --}}
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-user-check me-2"></i>
                Informaci√≥n del Receptor
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="nombreReceptor" class="form-label">
                    <strong>Nombre completo del receptor</strong>
                    <span class="text-danger">*</span>
                  </label>
                  <input type="text" class="form-control" id="nombreReceptor" name="nombreReceptor" 
                         placeholder="Nombre completo de quien recibe" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="identificacionReceptor" class="form-label">
                    <strong>Identificaci√≥n del receptor</strong>
                    <span class="text-danger">*</span>
                  </label>
                  <input type="text" class="form-control" id="identificacionReceptor" name="identificacionReceptor" 
                         placeholder="C√©dula o identificaci√≥n" required>
                </div>
              </div>
              <div class="mb-3">
                <label for="relacionReceptor" class="form-label">
                  <strong>Relaci√≥n con el cliente</strong>
                  <span class="text-danger">*</span>
                </label>
                <select class="form-select" id="relacionReceptor" name="relacionReceptor" required>
                  <option value="">Seleccione la relaci√≥n</option>
                  <option value="titular">Titular del documento</option>
                  <option value="representante_legal">Representante legal</option>
                  <option value="apoderado">Apoderado</option>
                  <option value="familiar">Familiar autorizado</option>
                  <option value="empleado">Empleado autorizado</option>
                  <option value="tercero_autorizado">Tercero autorizado</option>
                </select>
              </div>
            </div>
          </div>

          {{!-- BOT√ìN DE CONFIRMACI√ìN --}}
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-success btn-lg" id="btnConfirmarEntrega">
              <i class="fas fa-check-circle me-2"></i>
              Confirmar Entrega
            </button>
          </div>
        </form>

      {{else}}
        {{!-- ============== B√öSQUEDA Y LISTADO DE DOCUMENTOS ============== --}}
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-search me-2"></i>
              Buscar Documento para Entrega
            </h5>
          </div>
          <div class="card-body">
            <form action="/matrizador/documentos/entrega" method="GET">
              <div class="input-group mb-3">
                <input type="text" class="form-control form-control-lg" name="codigo" 
                       placeholder="Escanee o ingrese el c√≥digo de barras del documento" 
                       value="{{codigo}}" autofocus>
                <button class="btn btn-primary btn-lg" type="submit">
                  <i class="fas fa-search me-1"></i>Buscar
                </button>
              </div>
            </form>
          </div>
        </div>

        {{!-- LISTA DE DOCUMENTOS LISTOS CON ESTADO DE PAGO VISIBLE --}}
        {{#if documentosListos.length}}
          <div class="card mt-4">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-list me-2"></i>
                Sus Documentos Listos para Entrega ({{documentosListos.length}})
              </h6>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>C√≥digo</th>
                      <th>Cliente</th>
                      <th>Tipo</th>
                      <th>Valor</th>
                      <th>Estado Pago</th>
                      <th>Fecha Registro</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    {{#each documentosListos}}
                      <tr>
                        <td><strong>{{this.codigoBarras}}</strong></td>
                        <td>
                          <div>{{this.nombreCliente}}</div>
                          <small class="text-muted">{{this.identificacionCliente}}</small>
                        </td>
                        <td>
                          <span class="badge bg-secondary">{{this.tipoDocumento}}</span>
                        </td>
                        <td><strong>${{formatMoney this.valorFactura}}</strong></td>
                        <td>
                          <span class="badge {{estadoPagoClass this.estadoPago}}">
                            {{estadoPagoTexto this.estadoPago}}
                          </span>
                        </td>
                        <td>{{formatDate this.created_at}}</td>
                        <td>
                          <a href="/matrizador/documentos/entrega/{{this.id}}" class="btn btn-sm btn-primary">
                            <i class="fas fa-handshake me-1"></i>Entregar
                          </a>
                        </td>
                      </tr>
                    {{/each}}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        {{else}}
          <div class="card mt-4">
            <div class="card-body text-center py-5">
              <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
              <h5>No hay documentos listos para entrega</h5>
              <p class="text-muted">Todos sus documentos han sido entregados o est√°n en proceso.</p>
            </div>
          </div>
        {{/if}}
      {{/if}}
    </div>
  </div>
</div>

{{!-- ============== JAVASCRIPT CORREGIDO PARA FUNCIONALIDAD ============== --}}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Configuraci√≥n global
  window.documentoPrincipal = {{{json documento}}};
  window.documentosDisponibles = {{{json documentosGrupales.documentos}}};
  window.documentosOtrosMatrizadores = {{{json documentosGrupales.documentosOtrosMatrizadores}}};
  window.usuarioActual = { 
    rol: 'matrizador',
    id: {{{json usuario.id}}}
  };
  
  // Variables del DOM (igual que admin)
  const selectAll = document.getElementById('selectAll');
  const documentoCheckboxes = document.querySelectorAll('.documento-checkbox');
  const contadorSeleccion = document.getElementById('contador-seleccion');
  const codigoInput = document.getElementById('codigoVerificacion');
  const btnValidar = document.getElementById('validarCodigo');
  const listaCodigosValidos = document.getElementById('lista-codigos-validos');
  const verificacionLlamada = document.getElementById('verificacionLlamada');
  const divObservaciones = document.getElementById('div-observaciones');
  const btnConfirmar = document.getElementById('btnConfirmarEntrega');
  
  // Usar la misma l√≥gica que admin (funciones id√©nticas)
  // ============== GESTI√ìN DE SELECCI√ìN DE DOCUMENTOS ==============
  function actualizarSeleccion() {
    const seleccionados = Array.from(documentoCheckboxes).filter(cb => cb.checked);
    const total = seleccionados.length + 1; // +1 por el documento principal
    
    // Actualizar contador
    if (contadorSeleccion) {
      contadorSeleccion.textContent = `${total} documento(s) seleccionado(s)`;
    }
    
    // Actualizar c√≥digos v√°lidos
    if (listaCodigosValidos && window.documentoPrincipal) {
      let codigosHTML = '';
      
      // C√≥digo del documento principal
      if (window.documentoPrincipal.codigoVerificacion && window.documentoPrincipal.codigoVerificacion !== 'sin_codigo') {
        codigosHTML += `<code class="bg-dark text-light px-2 py-1 rounded me-2">${window.documentoPrincipal.codigoVerificacion}</code>`;
        codigosHTML += `<small class="text-muted me-3">(principal)</small>`;
      }
      
      // C√≥digos de documentos seleccionados
      seleccionados.forEach((checkbox, index) => {
        const codigo = checkbox.dataset.codigo;
        if (codigo && codigo !== 'sin_codigo') {
          codigosHTML += `<code class="bg-success text-light px-2 py-1 rounded me-2">${codigo}</code>`;
          codigosHTML += `<small class="text-muted me-3">(seleccionado ${index + 1})</small>`;
        }
      });
      
      // NUEVO: Mostrar c√≥digos de documentos propios no seleccionados tambi√©n
      const matrizadorActual = window.usuarioActual?.id;
      documentoCheckboxes.forEach((checkbox) => {
        const matrizadorDelDocumento = checkbox.dataset.matrizadorId;
        const codigo = checkbox.dataset.codigo;
        
        // Si es propio y no est√° seleccionado, tambi√©n mostrarlo como v√°lido
        if (matrizadorDelDocumento == matrizadorActual && !checkbox.checked && codigo && codigo !== 'sin_codigo') {
          codigosHTML += `<code class="bg-info text-light px-2 py-1 rounded me-2">${codigo}</code>`;
          codigosHTML += `<small class="text-muted me-3">(disponible)</small>`;
        }
      });
      
      if (codigosHTML === '') {
        codigosHTML = '<span class="text-warning">‚ö†Ô∏è Documentos sin c√≥digo - usar verificaci√≥n alternativa</span>';
      }
      
      listaCodigosValidos.innerHTML = codigosHTML;
    }
    
    // Actualizar campos ocultos
    const idsSeleccionados = seleccionados.map(cb => cb.value);
    document.getElementById('documentos_seleccionados').value = idsSeleccionados.join(',');
    document.getElementById('entrega_grupal').value = idsSeleccionados.length > 0 ? 'true' : 'false';
  }
  
  // Event listeners con validaci√≥n para matrizador
  if (selectAll) {
    selectAll.addEventListener('change', function() {
      documentoCheckboxes.forEach(cb => {
        // VALIDACI√ìN: Solo permitir selecci√≥n de documentos propios
        const matrizadorDelDocumento = cb.dataset.matrizadorId;
        const matrizadorActual = window.usuarioActual?.id;
        
        if (matrizadorDelDocumento == matrizadorActual) {
          cb.checked = this.checked;
        } else {
          cb.checked = false;
          cb.disabled = true;
          console.log(`üö´ [MATRIZADOR] Documento ${cb.value} bloqueado: pertenece a otro matrizador (${matrizadorDelDocumento} vs ${matrizadorActual})`);
        }
      });
      actualizarSeleccion();
    });
  }
  
  documentoCheckboxes.forEach(checkbox => {
    // VALIDACI√ìN: Solo permitir documentos propios
    const matrizadorDelDocumento = checkbox.dataset.matrizadorId;
    const matrizadorActual = window.usuarioActual?.id;
    
    if (matrizadorDelDocumento != matrizadorActual) {
      checkbox.disabled = true;
      checkbox.title = 'No puede seleccionar documentos de otros matrizadores';
      console.log(`üö´ [MATRIZADOR] Documento ${checkbox.value} deshabilitado: pertenece a otro matrizador`);
    }
    
    checkbox.addEventListener('change', function() {
      // Validaci√≥n adicional en el evento
      if (matrizadorDelDocumento != matrizadorActual) {
        this.checked = false;
        alert('‚ùå No puede seleccionar documentos de otros matrizadores');
        return false;
      }
      actualizarSeleccion();
    });
  });
  
  // Misma validaci√≥n de c√≥digo que admin
  if (btnValidar && codigoInput) {
    btnValidar.addEventListener('click', function() {
      const codigoIngresado = codigoInput.value.trim();
      const mensajeDiv = document.getElementById('mensaje-validacion-codigo');
      
      if (!codigoIngresado) {
        mensajeDiv.innerHTML = '<div class="alert alert-warning alert-sm mt-2">‚ö†Ô∏è Ingrese un c√≥digo</div>';
        return;
      }
      
      // Obtener c√≥digos v√°lidos (TODOS los documentos propios, no solo seleccionados)
      const codigosValidos = [];
      
      // C√≥digo principal
      if (window.documentoPrincipal && window.documentoPrincipal.codigoVerificacion && 
          window.documentoPrincipal.codigoVerificacion !== 'sin_codigo') {
        codigosValidos.push(window.documentoPrincipal.codigoVerificacion);
      }
      
      // CORREGIDO: C√≥digos de TODOS los documentos propios disponibles (no solo seleccionados)
      const matrizadorActual = window.usuarioActual?.id;
      documentoCheckboxes.forEach(cb => {
        const matrizadorDelDocumento = cb.dataset.matrizadorId;
        const codigo = cb.dataset.codigo;
        
        // Solo incluir c√≥digos de documentos propios
        if (matrizadorDelDocumento == matrizadorActual && codigo && codigo !== 'sin_codigo') {
          codigosValidos.push(codigo);
        }
      });
      
      // Validar c√≥digo con mensaje espec√≠fico para matrizador
      if (codigosValidos.includes(codigoIngresado)) {
        mensajeDiv.innerHTML = '<div class="alert alert-success alert-sm mt-2">‚úÖ C√≥digo v√°lido</div>';
        codigoInput.classList.remove('is-invalid');
        codigoInput.classList.add('is-valid');
      } else {
        // Verificar si est√° usando c√≥digo de documento de otro matrizador
        const todosLosCodigos = window.documentosOtrosMatrizadores || [];
        const codigoDeOtroMatrizador = todosLosCodigos.some(doc => doc.codigoVerificacion === codigoIngresado);
        
        if (codigoDeOtroMatrizador) {
          mensajeDiv.innerHTML = `<div class="alert alert-warning alert-sm mt-2">
            ‚ö†Ô∏è <strong>C√≥digo de otro matrizador:</strong> Este c√≥digo pertenece a un documento de otro matrizador.<br>
            <small>Solo puede usar c√≥digos de sus propios documentos: ${codigosValidos.join(', ')}</small>
          </div>`;
        } else if (codigosValidos.length > 0) {
          mensajeDiv.innerHTML = `<div class="alert alert-danger alert-sm mt-2">‚ùå C√≥digo incorrecto. C√≥digos v√°lidos: ${codigosValidos.join(', ')}</div>`;
        } else {
          mensajeDiv.innerHTML = '<div class="alert alert-warning alert-sm mt-2">‚ö†Ô∏è Sin c√≥digos disponibles - use verificaci√≥n por llamada</div>';
        }
        codigoInput.classList.remove('is-valid');
        codigoInput.classList.add('is-invalid');
      }
    });
  }
  
  // Misma verificaci√≥n alternativa que admin
  if (verificacionLlamada) {
    verificacionLlamada.addEventListener('change', function() {
      if (this.checked) {
        divObservaciones.classList.remove('d-none');
        document.getElementById('observaciones').setAttribute('required', '');
        codigoInput.removeAttribute('required');
      } else {
        divObservaciones.classList.add('d-none');
        document.getElementById('observaciones').removeAttribute('required');
        codigoInput.setAttribute('required', '');
      }
    });
  }
  
  // Misma validaci√≥n de formulario que admin
  if (btnConfirmar) {
    document.getElementById('formEntrega').addEventListener('submit', function(e) {
      const entregaGrupal = document.getElementById('entrega_grupal').value === 'true';
      const numDocumentos = entregaGrupal ? 
        document.getElementById('documentos_seleccionados').value.split(',').length + 1 : 1;
      
      if (entregaGrupal) {
        btnConfirmar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Procesando entrega grupal (${numDocumentos} documentos)...`;
      } else {
        btnConfirmar.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Procesando entrega...`;
      }
      
      btnConfirmar.disabled = true;
    });
  }
  
  // Inicializar selecci√≥n
  actualizarSeleccion();
  
  // Funciones espec√≠ficas para matrizador
  window.ocultarEntregaGrupal = function() {
    document.getElementById('alerta-entrega-grupal').style.display = 'none';
    document.getElementById('seccion-entrega-grupal').style.display = 'none';
  };
  
  window.ocultarAlertaOtros = function() {
    document.getElementById('alerta-documentos-otros').style.display = 'none';
  };
});
</script> 