<!-- Reporte Financiero -->
<div class="card">
  <div class="card-header bg-success text-white">
    <h5 class="mb-0">
      <i class="fas fa-dollar-sign me-2"></i>
      Reporte Financiero Completo
    </h5>
    <p class="mb-0 small">
      Análisis detallado de facturación, cobranza y recuperación de cartera
    </p>
  </div>
  <div class="card-body">
    
    <!-- Resumen Ejecutivo -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card bg-primary text-white h-100">
          <div class="card-body text-center">
            <i class="fas fa-file-invoice-dollar fa-3x mb-3 opacity-75"></i>
            <h6 class="card-title">Total Facturado</h6>
            <h2 class="mb-0">${{stats.totalFacturado}}</h2>
            <small>En el período</small>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card bg-success text-white h-100">
          <div class="card-body text-center">
            <i class="fas fa-hand-holding-usd fa-3x mb-3 opacity-75"></i>
            <h6 class="card-title">Total Cobrado</h6>
            <h2 class="mb-0">${{stats.totalCobrado}}</h2>
            <small>Efectivamente recibido</small>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card bg-warning text-dark h-100">
          <div class="card-body text-center">
            <i class="fas fa-clock fa-3x mb-3 opacity-75"></i>
            <h6 class="card-title">Total Pendiente</h6>
            <h2 class="mb-0">${{stats.totalPendiente}}</h2>
            <small>Por cobrar</small>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card bg-info text-white h-100">
          <div class="card-body text-center">
            <i class="fas fa-percentage fa-3x mb-3 opacity-75"></i>
            <h6 class="card-title">% Recuperación</h6>
            <h2 class="mb-0">{{stats.porcentajeRecuperacion}}%</h2>
            <small>Eficiencia cobranza</small>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Gráfico de Tendencia -->
    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-chart-line me-2"></i>
          Tendencia Financiera Diaria
        </h6>
      </div>
      <div class="card-body">
        <canvas id="graficoTendenciaFinanciera" height="300"></canvas>
      </div>
    </div>
    
    <!-- Tabla Detallada -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
          <i class="fas fa-table me-2"></i>
          Análisis Día por Día
        </h6>
        <div>
          <button class="btn btn-sm btn-outline-primary" onclick="ordenarPorFecha()">
            <i class="fas fa-sort me-1"></i> Por Fecha
          </button>
          <button class="btn btn-sm btn-outline-success" onclick="ordenarPorMonto()">
            <i class="fas fa-sort-amount-down me-1"></i> Por Monto
          </button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0" id="tablaFinanciera">
            <thead class="table-light">
              <tr>
                <th>Fecha</th>
                <th class="text-end">Facturado</th>
                <th class="text-end">Cobrado</th>
                <th class="text-end">Pendiente</th>
                <th class="text-center">% Recuperación</th>
                <th class="text-center">Estado</th>
              </tr>
            </thead>
            <tbody>
              {{#each datosTabla}}
              <tr data-fecha="{{this.fecha}}" data-facturado="{{this.facturado}}" data-cobrado="{{this.cobrado}}" data-pendiente="{{this.pendiente}}">
                <td><strong>{{this.fecha}}</strong></td>
                <td class="text-end">
                  <span class="text-primary">${{this.facturado}}</span>
                </td>
                <td class="text-end">
                  <span class="text-success">${{this.cobrado}}</span>
                </td>
                <td class="text-end">
                  <span class="text-{{#if (gt this.pendiente "0.00")}}warning{{else}}success{{/if}}">${{this.pendiente}}</span>
                </td>
                <td class="text-center">
                  <span class="badge {{#if (gte this.porcentaje 90)}}bg-success{{else if (gte this.porcentaje 70)}}bg-warning{{else}}bg-danger{{/if}}">
                    {{this.porcentaje}}%
                  </span>
                </td>
                <td class="text-center">
                  {{#if (eq this.porcentaje 100)}}
                  <i class="fas fa-check-circle text-success" title="100% cobrado"></i>
                  {{else if (gte this.porcentaje 90)}}
                  <i class="fas fa-check text-success" title="Excelente recuperación"></i>
                  {{else if (gte this.porcentaje 70)}}
                  <i class="fas fa-clock text-warning" title="Recuperación media"></i>
                  {{else}}
                  <i class="fas fa-exclamation-triangle text-danger" title="Baja recuperación"></i>
                  {{/if}}
                </td>
              </tr>
              {{/each}}
            </tbody>
            <tfoot class="table-light">
              <tr>
                <th>TOTAL</th>
                <th class="text-end">${{stats.totalFacturado}}</th>
                <th class="text-end">${{stats.totalCobrado}}</th>
                <th class="text-end">${{stats.totalPendiente}}</th>
                <th class="text-center">{{stats.porcentajeRecuperacion}}%</th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Análisis Adicional -->
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">Días con Mejor Rendimiento</h6>
          </div>
          <div class="card-body">
            <div id="mejoresDias">
              <!-- Se llenará con JavaScript -->
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">Oportunidades de Mejora</h6>
          </div>
          <div class="card-body">
            <div id="oportunidades">
              <!-- Se llenará con JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Scripts para Gráfico -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  initGraficoFinanciero();
  analizarRendimiento();
});

function initGraficoFinanciero() {
  const ctx = document.getElementById('graficoTendenciaFinanciera').getContext('2d');
  
  const datos = {
    labels: {{{json graficoTendencia.fechas}}},
    datasets: [
      {
        label: 'Facturado',
        data: {{{json graficoTendencia.facturado}}},
        borderColor: '#007bff',
        backgroundColor: 'rgba(0, 123, 255, 0.1)',
        fill: false,
        tension: 0.4
      },
      {
        label: 'Cobrado',
        data: {{{json graficoTendencia.cobrado}}},
        borderColor: '#28a745',
        backgroundColor: 'rgba(40, 167, 69, 0.1)',
        fill: false,
        tension: 0.4
      },
      {
        label: 'Pendiente',
        data: {{{json graficoTendencia.pendiente}}},
        borderColor: '#ffc107',
        backgroundColor: 'rgba(255, 193, 7, 0.1)',
        fill: false,
        tension: 0.4
      }
    ]
  };
  
  new Chart(ctx, {
    type: 'line',
    data: datos,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Monto ($)'
          },
          ticks: {
            callback: function(value) {
              return '$' + value.toFixed(2);
            }
          }
        },
        x: {
          title: {
            display: true,
            text: 'Fecha'
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
            }
          }
        },
        legend: {
          position: 'top'
        }
      }
    }
  });
}

function ordenarPorFecha() {
  const filas = Array.from(document.querySelectorAll('#tablaFinanciera tbody tr'));
  const tbody = document.querySelector('#tablaFinanciera tbody');
  
  filas.sort((a, b) => {
    const fechaA = new Date(a.dataset.fecha.split('/').reverse().join('-'));
    const fechaB = new Date(b.dataset.fecha.split('/').reverse().join('-'));
    return fechaA - fechaB;
  });
  
  filas.forEach(fila => tbody.appendChild(fila));
}

function ordenarPorMonto() {
  const filas = Array.from(document.querySelectorAll('#tablaFinanciera tbody tr'));
  const tbody = document.querySelector('#tablaFinanciera tbody');
  
  filas.sort((a, b) => {
    const montoA = parseFloat(a.dataset.facturado) || 0;
    const montoB = parseFloat(b.dataset.facturado) || 0;
    return montoB - montoA; // Descendente
  });
  
  filas.forEach(fila => tbody.appendChild(fila));
}

function analizarRendimiento() {
  const datosTabla = {{{json datosTabla}}};
  
  if (!datosTabla || datosTabla.length === 0) return;
  
  // Encontrar mejores días
  const mejoresDias = datosTabla
    .filter(item => parseFloat(item.facturado) > 0)
    .sort((a, b) => parseFloat(b.facturado) - parseFloat(a.facturado))
    .slice(0, 3);
  
  // Encontrar oportunidades (días con baja recuperación)
  const oportunidades = datosTabla
    .filter(item => item.porcentaje < 90 && parseFloat(item.pendiente) > 0)
    .sort((a, b) => parseFloat(b.pendiente) - parseFloat(a.pendiente))
    .slice(0, 3);
  
  // Mostrar mejores días
  const mejoresDiasHtml = mejoresDias.map(dia => `
    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
      <span><strong>${dia.fecha}</strong></span>
      <span class="badge bg-success">$${dia.facturado}</span>
    </div>
  `).join('');
  
  document.getElementById('mejoresDias').innerHTML = mejoresDiasHtml || 
    '<p class="text-muted">No hay datos suficientes</p>';
  
  // Mostrar oportunidades
  const oportunidadesHtml = oportunidades.map(dia => `
    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
      <span><strong>${dia.fecha}</strong></span>
      <span class="badge bg-warning">$${dia.pendiente} pendiente</span>
    </div>
  `).join('');
  
  document.getElementById('oportunidades').innerHTML = oportunidadesHtml || 
    '<p class="text-success">¡Todo cobrado correctamente!</p>';
}
</script> 